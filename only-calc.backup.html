<!doctype html>
<html lang="uk">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>TRIAL ONLY ‚Äî –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä (MVP) | MT –£–∫—Ä–∞—ó–Ω–∞</title>

    <style>
        :root{
            --bg:#f6f7fb;
            --card:#ffffff;
            --text:#0f172a;
            --muted:#475569;
            --border:rgba(15,23,42,.12);
            --chip:rgba(2,132,199,.10);
            --accent:rgba(34,197,94,.18);
            --accent2:rgba(2,132,199,.12);
            --btn:#0f172a;
            --btnText:#fff;
        }
        body.dark-theme{
            --bg:#0b1220;
            --card:rgba(255,255,255,.05);
            --text:#e5e7eb;
            --muted:#94a3b8;
            --border:rgba(255,255,255,.12);
            --chip:rgba(2,132,199,.18);
            --accent:rgba(34,197,94,.18);
            --accent2:rgba(2,132,199,.18);
            --btn:#e5e7eb;
            --btnText:#0b1220;
        }
        body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial;}
        .wrap{max-width:1180px;margin:0 auto;padding:18px;}
        .topbar{
            display:flex;align-items:center;justify-content:space-between;gap:14px;
            padding:14px 16px;border:1px solid var(--border);border-radius:18px;background:var(--card);
            position:sticky;top:10px;z-index:20;backdrop-filter: blur(10px);
        }
        .brand{display:flex;align-items:center;gap:12px;}
        .logo{width:44px;height:44px;border-radius:12px;background:var(--accent2);display:grid;place-items:center;font-weight:800;}
        .brand h1{margin:0;font-size:16px;}
        .brand .sub{margin:2px 0 0;color:var(--muted);font-size:12px;}
        .actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
        .btn{
            border:1px solid var(--border);background:var(--card);color:var(--text);
            padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:700;
        }
        .btn.primary{background:var(--btn);color:var(--btnText);border-color:transparent;}
        .btn.ghost{background:transparent;}
        .grid{display:grid;grid-template-columns:420px 1fr;gap:14px;margin-top:14px;}
        @media(max-width:980px){.grid{grid-template-columns:1fr;}}
        .card{border:1px solid var(--border);background:var(--card);border-radius:18px;overflow:hidden;}
        .cardHead{padding:14px 14px 0;}
        .cardTitle{margin:0;font-size:15px;font-weight:800;}
        .cardSub{margin:6px 0 0;color:var(--muted);font-size:12px;}
        .cardBody{padding:14px;}
        .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
        label{display:block;font-weight:700;margin:0 0 6px;}
        select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--text);outline:none;}
        input[type="number"]{
            width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);
            background:transparent;color:var(--text);outline:none;
        }
        .toggles{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
        .toggle{
            display:flex;align-items:center;gap:8px;border:1px solid var(--border);
            border-radius:999px;padding:8px 12px;background:transparent;
        }
        .chip{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:6px 10px;background:var(--chip);color:var(--text);border:1px solid var(--border);font-size:12px;}
        table{width:100%;border-collapse:separate;border-spacing:0;}
        th,td{padding:10px 10px;border-bottom:1px solid var(--border);vertical-align:top;}
        th{text-align:left;color:var(--muted);font-size:12px;font-weight:800;}
        .muted{color:var(--muted);}
        .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
        .kpi .chip b{font-size:13px;}
        .warn{padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:rgba(245,158,11,.10);margin-top:10px;}
        .ok{padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--accent);margin-top:10px;}
        .small{font-size:12px;}
    
/* ===== –†–µ–∂–∏–º–∏ –∫–ª—ñ—î–Ω—Ç/–º–µ–Ω–µ–¥–∂–µ—Ä + –∑–∞—è–≤–∫–∞ –≤ Telegram (1:1 —è–∫ eTSecutive) ===== */
.results-mode{
  display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:12px;
}
.btn-manager{
  padding:10px 12px; border-radius:12px; border:1px solid rgba(148,163,184,0.35);
  background: rgba(255,255,255,0.55); cursor:pointer; font-size:13px; font-weight:600;
}
.dark .btn-manager, .dark-theme .btn-manager{
  background: rgba(15,23,42,0.6); color:#e5e7eb;
}
.client-summary{ margin-top:12px; }
.client-total-card{
  border-radius:18px; padding:14px 18px; background: rgba(22,163,74,0.06);
  border:1px solid rgba(22,163,74,0.35);
  display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;
}
.client-total-label{ font-size:13px; opacity:0.75; }
.client-total-eur{ font-size:24px; font-weight:800; }
.client-contact{
  margin-top:12px; display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; font-size:13px;
}
.client-contact-fields{ display:flex; flex-wrap:wrap; gap:8px; }
.client-contact-fields > div{ display:flex; flex-direction:column; gap:6px; }
.client-contact input{
  min-width: 180px;
  padding:10px 12px; border-radius:12px;
  border:1px solid rgba(148,163,184,0.35);
  background: rgba(255,255,255,0.55);
}
.dark .client-contact input, .dark-theme .client-contact input{
  background: rgba(15,23,42,0.55); color:#e5e7eb;
}
.client-contact button{
  padding:12px 14px; border:0; border-radius:14px;
  background:#16a34a; color:#fff; font-weight:600; cursor:pointer; white-space:nowrap;
}
.client-contact button:hover{ box-shadow: 0 10px 25px rgba(22,163,74,0.45); transform: translateY(-1px); }
        /* –¢–∞–±–ª–∏—Ü—è –Ω–µ —Ä–æ–∑–¥—É–≤–∞—î—Ç—å—Å—è —á–µ—Ä–µ–∑ –¥–æ–≤–≥–∏–π —Ç–µ–∫—Å—Ç */
        .spec-table {
            table-layout: fixed;
            width: 100%;
        }

        .spec-table th, .spec-table td {
            vertical-align: top;
        }

        /* –ö–æ–ª–æ–Ω–∫–∞ "–ü–æ—Ä—ñ–∑–∫–∞ / –æ–ø–ª–∞—Ç–∞" ‚Äî –ø–µ—Ä–µ–Ω–æ—Å + –∞–¥–µ–∫–≤–∞—Ç–Ω–∞ —à–∏—Ä–∏–Ω–∞ */
        .spec-table th:nth-child(4),
        .spec-table td:nth-child(4) {
            width: 32%;
            max-width: 520px;
            white-space: normal;
            overflow-wrap: anywhere;   /* –ª–∞–º–∞—î –¥–æ–≤–≥—ñ —à–º–∞—Ç–∫–∏ */
            word-break: break-word;
            line-height: 1.25;
        }

        /* –¢—Ä–æ—Ö–∏ –ø—ñ–¥—Ç–∏—Å–Ω–µ–º–æ –Ω–∞ –º–µ–Ω—à–∏—Ö –µ–∫—Ä–∞–Ω–∞—Ö */
        @media (max-width: 1100px) {
            .spec-table th:nth-child(4),
            .spec-table td:nth-child(4) { width: 26%; max-width: 360px; }
        }
        @media (max-width: 900px) {
            .spec-table th:nth-child(4),
            .spec-table td:nth-child(4) { width: 22%; max-width: 280px; }
        }

</style>
</head>

<body>
<div class="wrap">
    <div class="topbar">
        <div class="brand">
            <div class="logo">MT</div>
            <div>
                <h1>TRIAL ONLY ‚Äî –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä (MVP)</h1>
                <div class="sub">–ö–∞—Ä–∫–∞—Å / –í—ñ—Ç—Ä–∏–Ω–∞ / LED ¬∑ –±–µ–∑ IKS (LAIT ‚Äî –ª–∏—à–µ —è–∫ —Ç–∏–ø –ø–æ–ª–∏—Ü—å –¥–ª—è –ª—ñ–º—ñ—Ç—É W)</div>
            </div>
        </div>
        <div class="actions">
            <a class="btn ghost" href="only.html">‚Üê –ù–∞–∑–∞–¥ –¥–æ ONLY</a>
            <button class="btn" id="themeToggle">–¢–µ–º–∞</button>
        </div>
    </div>

    <div class="grid">
        <!-- INPUTS -->
        <div class="card">
            <div class="cardHead">
                <div class="cardTitle">–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –º–æ–¥—É–ª—è</div>
                <div class="cardSub">–ì–µ–æ–º–µ—Ç—Ä—ñ—è: 4 –≤–µ—Ä—Ç–∏–∫–∞–ª—ñ + 2 –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—ñ + –æ–ø–æ—Ä–∏ + –∑‚Äô—î–¥–Ω—É–≤–∞—á—ñ.</div>
            </div>
            <div class="cardBody">
                <div class="row">
                    <div>
                        <label for="H">–í–∏—Å–æ—Ç–∞ H (–º–º)</label>
                        <input id="H" type="number" min="300" step="1" value="2200">
                    </div>
                    <div>
                        <label for="W">–®–∏—Ä–∏–Ω–∞ W (–º–º)</label>
                        <input id="W" type="number" min="300" step="1" value="1200">
                    </div>
                </div>

                <div style="margin-top:10px;">
                    <label for="D">–ì–ª–∏–±–∏–Ω–∞ D (–º–º)</label>
                    <input id="D" type="number" min="200" step="1" value="450">
                    <div class="small muted" style="margin-top:6px;">
                        D –∑–∞—Ä–∞–∑ –¥–æ–≤—ñ–¥–∫–æ–≤–æ (—Å–ø–µ—Ü–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∫–∞—Ä–∫–∞—Å–∞ —Ä–∞—Ö—É—î—Ç—å—Å—è –ø–æ H —Ç–∞ W).
                    </div>
                </div>

                <div style="margin-top:10px;">
                <label for="trimEachSide">–¢–æ—Ä—Ü—é–≤–∞–Ω–Ω—è –∑ –∫–æ–∂–Ω–æ–≥–æ –±–æ–∫—É (–º–º)</label>
                <input id="trimEachSide" type="number" min="0" max="120" step="1" value="60">
                <div class="small muted" style="margin-top:6px;">
                    –¢–æ—Ä—Ü—é—î–º–æ <b>–ø–∞–ª–∫–∏</b> (–∫–æ—Ä–∏—Å–Ω–∞ –¥–æ–≤–∂–∏–Ω–∞ = 6100 ‚àí 2√ó—Ç–æ—Ä—Ü—é–≤–∞–Ω–Ω—è). –î–µ—Ç–∞–ª—ñ –Ω–µ ‚Äú–∫–æ—Ä–æ—Ç–∏–º–æ‚Äù.
                </div>
            </div>
                <div style="margin-top:10px;">
                    <label for="colorCode">–ö–æ–ª—ñ—Ä –ø—Ä–æ—Ñ—ñ–ª—é</label>
                    <select id="colorCode" style="width:100%;padding:10px 12px;border-radius:12px;">
                        <option value="NS">–ß–æ—Ä–Ω–∏–π –º–∞—Ç</option>
                        <option value="BRA">–ë—Ä–æ–Ω–∑–∞ Armani</option>
                        <option value="BRC">–ë—Ä–æ–Ω–∑–∞ Cartier</option>
                    </select>
                </div>

                <div style="margin-top:10px;">
                    <label for="shelfType">–¢–∏–ø –ø–æ–ª–∏—Ü—å</label>
                    <select id="shelfType" style="width:100%;padding:10px 12px;border-radius:12px;">
<!--                        <option value="chipboard" selected>–ü–æ–ª–∏—Ü—ñ –î–°–ü/–ú–î–§ (—Ä–æ–±–æ—á–∞ —à–∏—Ä–∏–Ω–∞ 600‚Äì900 –º–º)</option>-->
                        <option value="lait">–ü–æ–ª–∏—Ü—ñ LAIT (Lite) (—Ä–æ–±–æ—á–∞ —à–∏—Ä–∏–Ω–∞ 600‚Äì1000 –º–º)</option>
                    </select>
                    <div class="small muted" style="margin-top:6px;">
                        –û–±–º–µ–∂–µ–Ω–Ω—è W ‚Äî –±—ñ–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–æ –¥–ª—è MVP-2 (–∑–∞ –ø—Ä–æ–≥–∏–Ω–æ–º –ø–æ–ª–∏—Ü—å).
                    </div>
                    <div id="wRangeWarn" class="warn small" style="display:none;margin-top:8px;"></div>
                    <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
                        <button type="button" id="openLaitBtn" class="btn">
                            –†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –ø–æ–ª–∏—Ü—ñ LAIT
                        </button>
                        <div class="small muted" id="laitHint" style="align-self:center;"></div>
                    </div>

                </div>

                <div style="margin-top:10px;">
                    <label for="shelvesCount">–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–ª–∏—Ü—å (—à—Ç)</label>
                    <input id="shelvesCount" type="number" min="0" max="12" step="1" value="0">
                    <div class="small muted" style="margin-top:6px;">
                        –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—ñ OL-965 = 2 (–≤–µ—Ä—Ö/–Ω–∏–∑) + N –ø–æ–ª–∏—Ü—å. –ó º—î–¥–Ω—É–≤–∞—á—ñ OL-GTSI = 2 —à—Ç –Ω–∞ 1 –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å.
                    </div>
                </div>

                <div class="field" style="margin-top:10px;">
                    <label class="toggle">
                        <input id="topBottom25" type="checkbox" checked>
                        –î–Ω–æ + –∫—Ä–∏—à–∫–∞ (–î–°–ü/–ú–î–§ 25 –º–º) ‚Äî –∫—Ä—ñ–ø–ª–µ–Ω–Ω—è Permo
                    </label>
                    <div class="small muted" style="margin-top:6px;">
                        –†–∞—Ö—É—î–º–æ –ø–ª–æ—â—É 2 –ø–∞–Ω–µ–ª–µ–π (W√óD) —Ç–∞ –∫–æ–º–ø–ª–µ–∫—Ç –∫—Ä—ñ–ø–ª–µ–Ω–Ω—è Permo –¥–ª—è –∫–æ–∂–Ω–æ—ó —Ä–∞–º–∫–∏ (4 —Ç–æ—á–∫–∏ –Ω–∞ –ø–∞–Ω–µ–ª—å).
                    </div>
                </div>

                <div class="field" style="margin-top:10px;">
                    <label class="toggle">
                        <input id="frameMode" type="checkbox">
                        –†–µ–∂–∏–º —Ä–∞–º–æ–∫ (–ø—Ä–æ–ª—å–æ—Ç–∏ –ø–æ —à–∏—Ä–∏–Ω—ñ)
                    </label>
                    <div class="small muted" style="margin-top:6px;">
                        –†–æ–∑–±–∏–≤–∞—î–º–æ –∑–∞–≥–∞–ª—å–Ω—É —à–∏—Ä–∏–Ω—É W –Ω–∞ –ø—Ä–æ–ª—å–æ—Ç–∏: –î–°–ü ‚â§900 –º–º, LAIT ‚â§1000 –º–º. –†–∞–º–æ–∫ = –ø—Ä–æ–ª—å–æ—Ç–∏ + 1.
                    </div>
                </div>

                <div style="margin-top:10px;">
                    <label for="sideGlass">–°–∫–ª–æ –≤ –±–æ–∫–æ–≤–∏–Ω–∞—Ö</label>
                    <select id="sideGlass" style="width:100%;padding:10px 12px;border-radius:12px;">
                        <option value="none" selected>–ù–µ–º–∞</option>
                        <option value="left">–õ—ñ–≤–∞ –±–æ–∫–æ–≤–∏–Ω–∞ (—Å–∫–ª–æ –≤ –ø–∞–∑)</option>
                        <option value="right">–ü—Ä–∞–≤–∞ –±–æ–∫–æ–≤–∏–Ω–∞ (—Å–∫–ª–æ –≤ –ø–∞–∑)</option>
                        <option value="both">–û–±–∏–¥–≤—ñ –±–æ–∫–æ–≤–∏–Ω–∏ (—Å–∫–ª–æ –≤ –ø–∞–∑)</option>
                    </select>
                <div style="margin-top:10px;">
                    <label for="buselSideGlassId">Busel: —Å–∫–ª–æ –¥–ª—è –±–æ–∫–æ–≤–∏–Ω (4 –º–º)</label>
                    <select id="buselSideGlassId" style="width:100%;padding:10px 12px;border-radius:12px;">
                        <option value="BUSEL_FLOAT_CLEAR_4_RIZKA" selected>Float Clear 4 –º–º</option>
                        <option value="BUSEL_ULTRACLEAR_4_RIZKA">UltraClear 4 –º–º</option>
                        <option value="BUSEL_CHINA_DARKGREY_4_RIZKA">DarkGrey 4 –º–º</option>
                        <option value="BUSEL_PLANIBEL_BRONZE_GREY_4_RIZKA">Planibel Bronze Grey 4 –º–º</option>
                    </select>
                </div>

                    <div class="small muted" style="margin-top:6px;">
                        MVP-3+: —Ä–∞—Ö—É—î–º–æ –ø–ª–æ—â—É –±–æ–∫–æ–≤–æ–≥–æ —Å–∫–ª–∞ 4 –º–º –∑–∞ –∫–∞—Ç–∞–ª–æ–≥–æ–º. PIATTO –¥–æ–¥–∞—é—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ (–ø–æ —Å–µ–∫—Ü—ñ—è—Ö).
                    </div>
                </div>

                <div class="toggles">
                    <label for="backPanelType">–¢–∏–ø –∑–∞–¥–Ω—å–æ—ó —Å—Ç—ñ–Ω–∫–∏</label>
                    <select id="backPanelType" style="width:100%;padding:10px 12px;border-radius:12px;">
                        <option value="none">–ù–µ–º–∞ (–≥–ª—É—Ö–∏–π –∫–∞—Ä–∫–∞—Å)</option>
                        <option value="opaque8">–ù–µ–ø—Ä–æ–∑–æ—Ä–µ 8 –º–º (MDF/HDF) ‚Äî –±–µ–∑ —É—â—ñ–ª—å–Ω—é–≤–∞—á–∞</option>
                        <option value="glass6" selected>–°–∫–ª–æ 6 –º–º (–≤ –ø–∞–∑) ‚Äî –∑ —É—â—ñ–ª—å–Ω—é–≤–∞—á–µ–º GU-C-RG</option>
                    </select>
                <div class="toggles" style="margin-top:10px;">
                    <label for="buselBackGlassId">Busel: —Å–∫–ª–æ –¥–ª—è —Å–ø–∏–Ω–∫–∏ (6 –º–º)</label>
                    <select id="buselBackGlassId" style="width:100%;padding:10px 12px;border-radius:12px;">
                        <option value="BUSEL_CHINA_FLOAT_CLEAR_6_RIZKA" selected>Float Clear 6 –º–º</option>
                        <option value="BUSEL_ULTRACLEAR_6_RIZKA">UltraClear 6 –º–º</option>
                        <option value="BUSEL_CHINA_DARKGREY_6_RIZKA">DarkGrey 6 –º–º</option>
                        <option value="BUSEL_CHINA_BRONZE_6_RIZKA">Bronze 6 –º–º</option>
                    </select>
                </div>

                    <label class="toggle">
                        <input id="isLed" type="checkbox">
                        LED (–ø–µ—Ä–µ–¥–Ω—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å)
                    </label>
                </div>

                <div class="warn small">
                    ‚ö†Ô∏è MVP: —Å–∫–ª–æ (—Ä–æ–∑–º—ñ—Ä–∏) —Ç–∞ –µ–ª–µ–∫—Ç—Ä–∏–∫–∞ LED –Ω–µ —Ä–∞—Ö—É—é—Ç—å—Å—è. IKS/LAIT ‚Äî –æ–∫—Ä–µ–º–æ.<br/>
                    ‚úÖ –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—Ñ—ñ–ª—é BAR: <b>0.5 –ø–∞–ª–∫–∏</b> —è–∫—â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ ‚â§ –ø–æ–ª–æ–≤–∏–Ω–∏ –∫–æ—Ä–∏—Å–Ω–æ—ó –¥–æ–≤–∂–∏–Ω–∏, —ñ–Ω–∞–∫—à–µ <b>1 –ø–∞–ª–∫–∞</b>.
                </div>

                <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
                    <button class="btn primary" id="btnCalc">–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏</button>
                    <button class="btn" id="btnCsv">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ CSV</button>
                </div>

<!--                <div class="ok small">-->
<!--                    –ü—Ä–∞–π—Å/—Ü—ñ–Ω–∏ –±–µ—Ä—É—Ç—å—Å—è –∑ <b>only.data.json</b> (EUR).-->
<!--                </div>-->
            </div>
        </div>



                <!-- üîÅ –†–µ–∂–∏–º + –∫–æ–Ω—Ç–∞–∫—Ç–∏ (—è–∫ —É eTSecutive) -->
<!--                <div class="results-mode">-->
<!--                  <span id="currentModeLabel">–†–µ–∂–∏–º: –∫–ª—ñ—î–Ω—Ç</span>-->
<!--                  <button type="button" class="btn-manager" id="managerToggleBtn">–ú–µ–Ω–µ–¥–∂–µ—Ä</button>-->
<!--                </div>-->

                <div id="clientSummary" class="client-summary" style="display:none;">
                  <div class="client-total-card">
                    <div>
                      <div class="client-total-label">–û—Ä—ñ—î–Ω—Ç–æ–≤–Ω–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å</div>
                      <div class="client-total-eur"><span id="clientTotalEur">0.00</span> ‚Ç¨</div>
                    </div>
                    <div class="client-total-extra">–∞–±–æ <span id="clientTotalUah">0</span> –≥—Ä–Ω</div>
                  </div>

                  <div class="client-contact">
                    <div class="client-contact-fields">
                      <div><label>–Ü–º º—è</label><input id="contactFirstName" placeholder="–Ü–º'—è"></div>
                      <div><label>–ü—Ä—ñ–∑–≤–∏—â–µ</label><input id="contactLastName" placeholder=""></div>
                      <div><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="contactPhone" placeholder="0XXXXXXXXX"></div>
                    </div>

                    <button type="button" id="sendToTelegramBtn">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–∞—è–≤–∫—É –≤ MT √ó Systems</button>
                  </div>
                    <div class="results-mode">
                        <span id="currentModeLabel">–†–µ–∂–∏–º: –∫–ª—ñ—î–Ω—Ç</span>
                        <button type="button" class="btn-manager" id="managerToggleBtn">–ú–µ–Ω–µ–¥–∂–µ—Ä</button>
                    </div>

                    <!-- OUTPUT -->
                    <div class="card">
                        <div class="cardHead">
                            <div class="cardTitle">–°–ø–µ—Ü–∏—Ñ—ñ–∫–∞—Ü—ñ—è</div>
                            <div class="cardSub">–ü–æ—Ä—ñ–∑–∫–∞ –ø–æ –ø–∞–ª–∫–∞—Ö + –æ–ø–ª–∞—Ç–∞ 0.5/1 + —Å—É–º–∞ ‚Ç¨.</div>
                        </div>
                        <div class="cardBody">
                            <div id="managerDetails" style="display:none;">
                                <div class="kpi" id="kpi"></div>

                                <div style="overflow:auto;margin-top:10px;">
                                    <table  class="spec-table" id="tbl">
                                        <thead>
                                        <tr>
                                            <th>–ö–æ–¥</th>
                                            <th>–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è</th>
                                            <th>–î–µ—Ç–∞–ª—ñ</th>
                                            <th>–ü–æ—Ä—ñ–∑–∫–∞ / –û–ø–ª–∞—Ç–∞</th>
                                            <th>–¶—ñ–Ω–∞ (‚Ç¨)</th>
                                            <th>–°—É–º–∞ (‚Ç¨)</th>
                                        </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>

                                <div class="small muted" style="margin-top:10px;">
                                    BAR-—Ä—è–¥–∫–∏ —Ä–∞—Ö—É—é—Ç—å—Å—è —è–∫: <b>—Ü—ñ–Ω–∞ –ø–∞–ª–∫–∏ √ó (0.5 –∞–±–æ 1)</b> –ø–æ –∫–æ–∂–Ω—ñ–π –ø–∞–ª—Ü—ñ, –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ñ–∞–∫—Ç–∏—á–Ω–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è.
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

</div>


    <!-- /#managerDetails -->
</div>

<script src="./glass-engine.busel.v3.js"></script>
<script>
  // ===== Busel v3 config (ONLY) =====
  // –¶—ñ–Ω–∏ (materialPricePerM2UAH_4/6, temperTariffPerM2UAH_4/6, edgePolishPerMUAH) –∑–∞–ø–æ–≤–Ω–∏–º–æ –ø—ñ—Å–ª—è –∑–≤—ñ—Ä–∫–∏ –ø—Ä–∞–π—Å—É.
  if (window.GlassEngine && typeof GlassEngine.setBuselConfig === "function") {
    GlassEngine.setBuselConfig({
      tempered: true,
      eurRate: 49.50,
      minAreaM2: 0.25,
      temperMinFloatUAH: 750,
      temperMinOtherUAH: 999,
      mtDiscount: 0.85,
      mtMarkup: 1.30,
      applySizeSurcharge: false,

      materialPricePerM2UAH_4: 0,
      materialPricePerM2UAH_6: 0,
      temperTariffPerM2UAH_4: 0,
      temperTariffPerM2UAH_6: 0,
      edgePolishPerMUAH: 0
    });
  }
</script>
<script>
    // ===== Busel price list (UAH) =====
    let BUSEL = null;

    async function loadBusel() {
        if (BUSEL) return BUSEL;
        const res = await fetch('./only.busel.glass.v1.json', { cache: 'no-store' });
        if (!res.ok) throw new Error(`Busel JSON HTTP ${res.status}`);
        BUSEL = await res.json();
        return BUSEL;
    }

    function buselFindGlassItem(busel, id){
        return busel?.glass_items?.find(x => x.id === id) || null;
    }

    function buselEdgePolishPerLm(busel, thicknessMm){
        const map = busel?.services?.edge_polish?.pricePerLm_uah || {};
        return thicknessMm === 4 ? (map.THK_4 || 0) : (map.THK_3_5_6 || 0);
    }

    function buselTemperingTariffPerM2(busel, temperGroup){
        const base = busel?.services?.tempering?.base_pricePerM2_uah || {};
        return base[temperGroup] || 0;
    }



    // ====== theme ======
    const body = document.body;
    const themeBtn = document.getElementById('themeToggle');
    if (localStorage.getItem('theme') === 'dark') body.classList.add('dark-theme');
    themeBtn.addEventListener('click', () => {
        body.classList.toggle('dark-theme');
        localStorage.setItem('theme', body.classList.contains('dark-theme') ? 'dark' : 'light');
    });

    // ====== data ======
    let DB = null;
    async function loadDB() {
        if (DB) return DB;

        const candidates = [
            './only.data.json',      // –æ—Å–Ω–æ–≤–Ω–∏–π —Ñ–∞–π–ª —É –ø—Ä–æ—î–∫—Ç—ñ

        ];

        let lastErr = null;
        for (const url of candidates) {
            try {
                const res = await fetch(url, { cache: 'no-store' });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json(); // —Ç—É—Ç –≤–ø–∞–¥–µ, —è–∫—â–æ —Ñ–∞–π–ª –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏–π JSON
                if (!data || !Array.isArray(data.items)) throw new Error('–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –ø—Ä–∞–π—Å—É (–Ω–µ–º–∞—î items).');
                DB = data;
                return DB;
            } catch (e) {
                lastErr = e;
            }
        }
        throw new Error('–ù–µ –º–æ–∂—É –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø—Ä–∞–π—Å ONLY (only.data.json). –ü–µ—Ä–µ–≤—ñ—Ä: 1) —Ñ–∞–π–ª –ø–æ—Ä—É—á –∑ HTML, 2) –≤–∞–ª—ñ–¥–Ω–∏–π JSON, 3) –Ω–∞–∑–≤–∞ –±–µ–∑ –ø–æ–º–∏–ª–æ–∫. ' + (lastErr ? ('(' + lastErr.message + ')') : ''));
    }
    function getItemByIdOrCode(db, key) {
        return db.items.find(x => x.id === key || x.code === key) || null;
    }
    // Safe money formatter (prevents NaN in UI if a price is missing/undefined)
    function eur(v){
      const n = Number(v);
      if (!Number.isFinite(n)) return "0.00";
      return (Math.round(n * 100) / 100).toFixed(2);
    }

    // Read EUR price from different schema variants (price.eur, price_eur, eur, etc.)
    function eurPrice(item){
      if (!item) return 0;
      const v = (item.price && (item.price.eur ?? item.price.EUR)) ?? item.price_eur ?? item.priceEUR ?? item.eur ?? item.EUR;
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }


    // ====== BAR CUTTING (FFD) ======
    function packCutsFFD(cuts, barLenEff, kerfMm = 0) {
        const sorted = [...cuts].sort((a,b) => b - a);
        const bars = []; // { used:number, cuts:number[] }

        for (const len of sorted) {
            let placed = false;
            for (const bar of bars) {
                const extra = (bar.cuts.length > 0) ? kerfMm : 0;
                if (bar.used + extra + len <= barLenEff) {
                    bar.used += extra + len;
                    bar.cuts.push(len);
                    placed = true;
                    break;
                }
            }
            if (!placed) bars.push({ used: len, cuts: [len] });
        }

        const detailed = bars.map((b, idx) => ({
            index: idx + 1,
            cuts: b.cuts,
            used: b.used,
            offcut: barLenEff - b.used
        }));

        return {
            barLenEff,
            kerfMm,
            bars: detailed,
            barsCount: detailed.length,
            offcutTotal: detailed.reduce((s, b) => s + b.offcut, 0),
            usedTotal: detailed.reduce((s, b) => s + b.used, 0),
        };
    }

    function paymentUnitsForPlan(plan) {
        // 0.5 —è–∫—â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ <= –ø–æ–ª–æ–≤–∏–Ω–∏ –∫–æ—Ä–∏—Å–Ω–æ—ó –¥–æ–≤–∂–∏–Ω–∏, —ñ–Ω–∞–∫—à–µ 1.0
        const half = plan.barLenEff / 2;
        let pay = 0;
        for (const b of plan.bars) pay += (b.used <= half ? 0.5 : 1.0);
        return pay;
    }

    function formatCutPlanWithPay(plan) {
        const half = plan.barLenEff / 2;
        const parts = plan.bars.map(b => {
            const pay = (b.used <= half ? 0.5 : 1.0);
            const cutsStr = b.cuts.join("+");
            return `–ü–∞–ª–∫–∞ #${b.index}: ${cutsStr} = ${b.used} –º–º; –∑–∞–ª–∏—à–æ–∫ ${b.offcut} –º–º; –æ–ø–ª–∞—Ç–∞ ${pay}`;
        });
        return parts.join(" | ");
    }

    function mapProfileIdByColor(baseId, colorCode) {
        if (colorCode === "NS") return baseId;

        const colorMap = {
            "OL-2545": {
                "BRA": "OL-2545_BRA",
                "BRC": "OL-2545_BRC"
            },
            "OL-965": {
                "BRA": "OL-965_BRA",
                "BRC": "OL-965_BRC"
            }
        };

        return colorMap[baseId]?.[colorCode] || baseId;
    }

    // ====== build spec ======
    function buildSpec(db, opts) {
        const { H, W, D, backPanelType, isLed, trimEachSide, colorCode, shelfType, shelvesCount, sideGlass, frameMode, topBottom25, busel } = opts;
        const barLen = db.defaults?.bar_length_mm || 6100;
        const kerfMm = 0; // —Ñ—ñ–∫—Å—É—î–º–æ 0, —â–æ–± –Ω–µ –ø–ª–æ–¥–∏—Ç–∏ –ø–æ–º–∏–ª–∫–∏

        const barLenEff = barLen - 2 * trimEachSide;
        if (barLenEff <= 0) throw new Error("–¢–æ—Ä—Ü—é–≤–∞–Ω–Ω—è –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–µ ‚Äî –Ω–µ–º–∞—î –∫–æ—Ä–∏—Å–Ω–æ—ó –¥–æ–≤–∂–∏–Ω–∏ –ø–∞–ª–∫–∏.");


        // –û–±–º–µ–∂–µ–Ω–Ω—è –∫–æ–ª—å–æ—Ä—ñ–≤ —É MVP: OL-2545L —Ç–∞ OL-2545RG –¥–æ—Å—Ç—É–ø–Ω—ñ –ª–∏—à–µ –≤ —á–æ—Ä–Ω–æ–º—É –º–∞—Ç (NS).
        // –Ø–∫—â–æ –æ–±—Ä–∞–Ω–æ —ñ–Ω—à–∏–π –∫–æ–ª—ñ—Ä ‚Äî –±–∞–∑–æ–≤—ñ –ø—Ä–æ—Ñ—ñ–ª—ñ —Ñ–∞—Ä–±—É—î–º–æ, –∞–ª–µ LED/RG –∑–∞–ª–∏—à–∞—î–º–æ NS —Ç–∞ –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è.
        const colorWarnings = [];
        const colorSafe = (colorCode === "NS");

        // Vertical types
        const baseVert = "OL-2545";
        const baseHor  = "OL-965";

// LED / RG —Ç—ñ–ª—å–∫–∏ NS
        const frontVertId = isLed
            ? "OL-2545L"
            : mapProfileIdByColor(baseVert, colorCode);

        const rearVertId = (backPanelType !== "none")
            ? "OL-2545RG" // —è–∫—â–æ —î –∑–∞–¥–Ω—è —Å—Ç—ñ–Ω–∫–∞ (—Å–∫–ª–æ –∞–±–æ –Ω–µ–ø—Ä–æ–∑–æ—Ä–µ) ‚Äî –±–µ—Ä–µ–º–æ –ø—Ä–æ—Ñ—ñ–ª—å –∑ –ø–∞–∑–æ–º
            : mapProfileIdByColor(baseVert, colorCode);

        const horId = mapProfileIdByColor(baseHor, colorCode);

        if (!colorSafe && isLed) colorWarnings.push("LED-–ø—Ä–æ—Ñ—ñ–ª—å OL-2545L –¥–æ—Å—Ç—É–ø–Ω–∏–π –ª–∏—à–µ –≤ —á–æ—Ä–Ω–æ–º—É (NS).");
        if (!colorSafe && backPanelType !== "none") colorWarnings.push("–ü—Ä–æ—Ñ—ñ–ª—å –∑ –ø–∞–∑–æ–º OL-2545RG –¥–æ—Å—Ç—É–ø–Ω–∏–π –ª–∏—à–µ –≤ —á–æ—Ä–Ω–æ–º—É (NS).");

        const items = [];
        // ===== Busel v3 helpers (ONLY) =====
        function findRowByKey(key){
            return items.find(r => r.id === key || r.code === key);
        }
        function setRowPriceByCode(key, priceEur, sumEur, extraNote){
            const r = findRowByKey(key);
            if (!r) return;
            r.priceEur = Number(priceEur) || 0;
            r.sumEur   = Number(sumEur)   || 0;
            if (extraNote){
                r.note = (r.note ? (r.note + " | ") : "") + String(extraNote);
            }
        }
        function calcBuselForPanel({ wMm, hMm, qty, thicknessMm, glassItemId, temperMinType="float" }){
            if (!window.GlassEngine || typeof GlassEngine.calcBuselV3Piece !== "function") return null;
            if (!busel) return null;

            const cfg = GlassEngine.BUSEL_CFG || {};
            const eurRate = Number(cfg.eurRate) || 49.5;

            const item = buselFindGlassItem(busel, glassItemId);
            if (!item) throw new Error(`Busel: –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ glass_item id=${glassItemId}`);

            const edgePolishPerMUAH = buselEdgePolishPerLm(busel, Number(thicknessMm)); // UAH/–ø–æ–≥.–º
            const temperTariffPerM2UAH = buselTemperingTariffPerM2(busel, item.tempering_group); // UAH/–º¬≤

            const breakdown = GlassEngine.calcBuselV3Piece({
                widthMm: wMm,

                heightMm: hMm,
                thicknessMm: Number(thicknessMm),
                qty: Number(qty) || 0,
                tempered: true,

                materialPricePerM2UAH: Number(item.pricePerM2_uah) || 0,
                edgePolishPerMUAH: Number(edgePolishPerMUAH) || 0,
                temperTariffPerM2UAH: Number(temperTariffPerM2UAH) || 0,
                temperMinType,

                // min bill / MT coefficients
                minAreaM2: Number(cfg.minAreaM2) || 0.25,
                temperMinFloatUAH: Number(cfg.temperMinFloatUAH) || 750,
                temperMinOtherUAH: Number(cfg.temperMinOtherUAH) || 999,
                mtDiscount: Number(cfg.mtDiscount) || 1,
                mtMarkup: Number(cfg.mtMarkup) || 1,
                applySizeSurcharge: !!cfg.applySizeSurcharge
            });

            breakdown._eurRate = eurRate;
            return breakdown;
        }

        function addRow(itemId, qty, pieceLenMm=null, extra={}) {
            const it = getItemByIdOrCode(db, itemId);
            if (!it) throw new Error(`–ù–µ–º–∞—î –ø–æ–∑–∏—Ü—ñ—ó –≤ only.data.json: ${itemId}`);
            items.push({
                id: it.id || itemId,
                code: it.code || it.id || itemId,
                name: it.name_ua || it.name || extra.name || (it.code || it.id || itemId),
                qtyPieces: qty,
                unit: it.unit || extra.unit || "—à—Ç",
                pieceLenMm,
                sell_type: it.sell_type || it.sellType || extra.sell_type || "PCS",
                priceEur: eurPrice(it),
                cutInfo: null,
                qtyPay: null,
                sumEur: null,
                bars: null,
                offcut: null,
                group: extra.group,
                note: extra.note
            });
        }
        // ===== counts (MVP-2) =====
        const nShelves = Math.max(0, Math.floor(Number(shelvesCount || 0)));

        // Frame-mode: W —Ä–æ–∑–±–∏–≤–∞—î–º–æ –Ω–∞ –ø—Ä–æ–ª—å–æ—Ç–∏, —Ä–∞–º–æ–∫ = –ø—Ä–æ–ª—å–æ—Ç–∏ + 1.
        const wRange = getWRange(shelfType);
        const spanMax = wRange.max; // 900 (–î–°–ü) –∞–±–æ 1000 (LAIT)

        const numSpans  = frameMode ? Math.max(1, Math.ceil(W / spanMax)) : 1;
        const numFrames = frameMode ? (numSpans + 1) : 2; // –±–∞–∑–æ–≤–∏–π –º–æ–¥—É–ª—å –±–µ–∑ —Ä–∞–º–æ–∫ = 2 —Ä–∞–º–∫–∏
        const spanW     = Math.ceil(W / numSpans);        // —à–∏—Ä–∏–Ω–∞ –æ–¥–Ω–æ–≥–æ –ø—Ä–æ–ª—å–æ—Ç—É (‚âà –¥–æ–≤–∂–∏–Ω–∞ –ø–µ—Ä–µ–º–∏—á–∫–∏)

        // –í–µ—Ä—Ç–∏–∫–∞–ª—ñ (–Ω–∞ —Ä–∞–º–∫—É: 1 –ø–µ—Ä–µ–¥–Ω—è + 1 –∑–∞–¥–Ω—è)
        if (frameMode) {
            addRow(frontVertId, numFrames, H);
            addRow(rearVertId,  numFrames, H);
        } else {
            // –±–∞–∑–æ–≤–∏–π MVP-2: 4 –≤–µ—Ä—Ç–∏–∫–∞–ª—ñ
            addRow(frontVertId, 2, H);
            addRow(rearVertId,  2, H);
        }

        // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—ñ (–ø–µ—Ä–µ–º–∏—á–∫–∏)
        let nHor;
        if (frameMode) {
            // –ù–∞ –∫–æ–∂–Ω—É —Ä–∞–º–∫—É: 2 (–≤–µ—Ä—Ö/–Ω–∏–∑) + N –ø–æ–ª–∏—Ü—å
            nHor = (2 + nShelves) * numFrames;
            addRow(horId, nHor, D);
        } else {
            // –±–∞–∑–æ–≤–∏–π MVP-2: 2 (–≤–µ—Ä—Ö/–Ω–∏–∑) + N –ø–æ–ª–∏—Ü—å (–Ω–∞ –º–æ–¥—É–ª—å)
            nHor = 2 + nShelves;
            addRow(horId, nHor, D);
        }

        // –û–ø–æ—Ä–∏ (–ø–æ 1 –Ω–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å)
        const legs = frameMode ? (2 * numFrames) : 4;
        addRow("OL-P", legs, null);

        // –ó‚Äô—î–¥–Ω—É–≤–∞—á—ñ: 2 —à—Ç –Ω–∞ 1 –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å
        addRow("OL-GTSI", 2 * nHor, null);

        // –ö—Ä—ñ–ø–ª–µ–Ω–Ω—è –∑–∞–¥–Ω—å–æ—ó —Å—Ç—ñ–Ω–∫–∏ (—è–∫—â–æ –≤–æ–Ω–∞ —î)
        if (backPanelType !== "none") {
            // OL-V ‚Äî –Ω–æ—Ä–º–∞ 8 —à—Ç –Ω–∞ 1 –º–æ–¥—É–ª—å (MVP-2). –î–ª—è frame-mode –ø–æ–∫–∏ –∑–∞–ª–∏—à–∞—î–º–æ —è–∫ MVP (–±–µ–∑ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è).
            addRow("OL-V_A11.034", 8, null);
            addRow("VITE-TSP-M4X10", 8, null);

            // –£—â—ñ–ª—å–Ω—é–≤–∞—á —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —Å–∫–ª–æ 6 –º–º –≤ –ø–∞–∑
            if (backPanelType === "glass6") {
                const gasketPcs = Math.ceil((numFrames * 2 * H) / 3000); // numFrames –∑–∞–¥–Ω—ñ—Ö —Å—Ç—ñ–π–æ–∫; —É—â—ñ–ª—å–Ω—é–≤–∞—á –∑ 2 —Å—Ç–æ—Ä—ñ–Ω; LISTA 3000 –º–º
                addRow("GU-C-RG-LISTA", gasketPcs, null);
            }
        } else {
            // –Ø–∫—â–æ –∑–∞–¥–Ω—å–æ—ó —Å—Ç—ñ–Ω–∫–∏ –Ω–µ–º–∞—î ‚Äî –±–∞–∑–æ–≤–∏–π –Ω–∞–±—ñ—Ä –≥–≤–∏–Ω—Ç—ñ–≤ (MVP-2)
            addRow("VITE-TSP-M4X10", 4, null);
        }

        // –ó–∞–≥–ª—É—à–∫–∏ GU-O-F: 2 LISTA (3000 –º–º) –Ω–∞ 1 –≤–µ—Ä—Ç–∏–∫–∞–ª—å (2 –ø–∞–∑–∏)
        const plugs = frameMode ? (4 * numFrames) : 8;
        addRow("GU-O-F-LISTA", plugs, null);

        // ====== ATTACHED MATERIALS (MVP-3+) ======
        // –ö–∞—Ç–∞–ª–æ–≥ ONLY:
        // 1) –ë–æ–∫–æ–≤–µ —Å–∫–ª–æ 4 –º–º: L_fianco - 3.5 –º–º | H_montante = H_vetro
        // 2) –°–ø–∏–Ω–∫–∞: H = H_montante - 38 –º–º
        //    - –¥–µ—Ä–µ–≤–æ 8 –º–º: L_vano + 16 –º–º
        //    - —Å–∫–ª–æ 6 –º–º:  L_vano + 11 –º–º
        // –ü—Ä–∞–≤–∏–ª–æ: —è–∫—â–æ frameMode ON ‚Äî —ñ —Å–ø–∏–Ω–∫–∞, —ñ –±–æ–∫–æ–≤–∏–Ω–∏ —Ä–∞—Ö—É—é—Ç—å—Å—è –ü–û –°–ï–ö–¶–Ü–Ø–• (vano) –æ–∫—Ä–µ–º–æ.

        // KPI areas (catalog-based)
        let rearAreaM2 = 0;
        let sideAreaM2 = 0;

        // helper: fallback row if SKU missing (price=0) so spec won't break
        function addFallback(code, name, qty, unit, group, note){
            items.push({
                id: code,
                code,
                name,
                qtyPieces: qty,
                unit: unit || "—à—Ç",
                pieceLenMm: null,
                sell_type: "VIRTUAL",
                priceEur: 0,
                cutInfo: "‚Äî",
                qtyPay: qty,
                sumEur: 0,
                bars: null,
                offcut: null,
                group: group || "ATTACHED",
                note
            });
        }

        function addMaterialM2(itemKey, qtyM2, fallbackName, note){
            const it = getItemByIdOrCode(db, itemKey);
            if (it){
                const pu = eurPrice(it);
                items.push({
                    id: it.id || itemKey,
                    code: it.code || it.id || itemKey,
                    name: it.name_ua || it.name || fallbackName,
                    qtyPieces: qtyM2,
                    unit: it.unit || "–º¬≤",
                    pieceLenMm: null,
                    sell_type: it.sell_type || it.sellType || "PCS",
                    priceEur: pu,
                    cutInfo: "‚Äî",
                    qtyPay: qtyM2,
                    sumEur: qtyM2 * pu,
                    bars: null,
                    offcut: null,
                    group: it.group || "PANELS",
                    note
                });
            } else {
                addFallback(itemKey, fallbackName || itemKey, qtyM2, "–º¬≤", "PANELS",
                    (note || "") + " (–ø–æ–∑–∏—Ü—ñ—è/—Ü—ñ–Ω–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞ –≤ only.data.json)");
            }
        }

        function addMaterialPCS(itemKey, qty, fallbackName, note, groupOverride){
            const it = getItemByIdOrCode(db, itemKey);
            if (it){
                const pu = eurPrice(it);
                items.push({
                    id: it.id || itemKey,
                    code: it.code || it.id || itemKey,
                    name: it.name_ua || it.name || fallbackName,
                    qtyPieces: qty,
                    unit: it.unit || "—à—Ç",
                    pieceLenMm: null,
                    sell_type: it.sell_type || it.sellType || "PCS",
                    priceEur: pu,
                    cutInfo: "‚Äî",
                    qtyPay: qty,
                    sumEur: qty * pu,
                    bars: null,
                    offcut: null,
                    group: groupOverride || it.group || "ONLY",
                    note
                });
            } else {
                addFallback(itemKey, fallbackName || itemKey, qty, "—à—Ç", groupOverride || "ONLY",
                    (note || "") + " (–ø–æ–∑–∏—Ü—ñ—è/—Ü—ñ–Ω–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞ –≤ only.data.json)");
            }
        }

        function addPermoKit(pointsTotal){
            const permoNote = "–°—Ç—è–∂–∫–∞ Permo –¥–ª—è –ø–∞–Ω–µ–ª–µ–π 25 –º–º (–∫—Ä–∏—à–∫–∞/–¥–Ω–æ)";
            const addPermo = (code, fallbackName, qty) => {
                const it = getItemByIdOrCode(db, code);
                if (it) {
                    const pu = eurPrice(it);
                    items.push({
                        id: it.id || code,
                        code: it.code || code,
                        name: it.name_ua || it.name || fallbackName,
                        qtyPieces: qty,
                        unit: it.unit || "—à—Ç",
                        pieceLenMm: null,
                        sell_type: it.sell_type || it.sellType || "PCS",
                        priceEur: pu,
                        cutInfo: "‚Äî",
                        qtyPay: qty,
                        sumEur: qty * pu,
                        bars: null,
                        offcut: null,
                        group: it.group || "PERMO",
                        note: permoNote
                    });
                } else {
                    addFallback(code, `${fallbackName} (Permo)`, qty, "—à—Ç", "PERMO",
                        permoNote + " ‚Äî –¥–æ–¥–∞–π—Ç–µ –ø–æ–∑–∏—Ü—ñ—é –≤ only.data.json, —â–æ–± –ø—ñ–¥—Ç—è–≥–Ω—É–ª–∞—Å—å —Ü—ñ–Ω–∞.");
                }
            };

            addPermo("B010ZZ0001409", "–í—Å—Ç–∞–≤–∫–∞/–∫–∞–º–µ—Ä–∞ Permo", pointsTotal);
            addPermo("GR01ZZ00010M8", "–ì–∞–π–∫–∞ Permo M8", pointsTotal);
            addPermo("TF02FZ0000736", "–°—Ç—è–∂–∫–∞ Permo (—à–ø–∏–ª—å–∫–∞)", pointsTotal);
        }

        // –†–∞—Ö—É—î–º–æ vano/—Å–µ–∫—Ü—ñ—ó: —É frameMode —ó—Ö = numSpans, —à–∏—Ä–∏–Ω–∞ vano = spanW
        const sectionsCount = frameMode ? numSpans : 1;
        const Lv = frameMode ? spanW : W;   // L_vano
        const Hmont = H;                    // H_montante

        // 1) –î–Ω–æ + –∫—Ä–∏—à–∫–∞ 25 –º–º (–º¬≤) + Permo (–Ω–µ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –∑–∞–¥–Ω—å–æ—ó —Å—Ç—ñ–Ω–∫–∏)
        if (topBottom25) {
            const panelAreaOne = (W * D) / 1e6;       // –º¬≤ –æ–¥–Ω—ñ—î—ó –ø–∞–Ω–µ–ª—ñ
            const panelsM2 = panelAreaOne * 2;        // 2 –ø–∞–Ω–µ–ª—ñ: –¥–Ω–æ + –∫—Ä–∏—à–∫–∞
            addMaterialM2(
                "PANEL_25_MM2",
                panelsM2,
                "–î–°–ü/–ú–î–§ 25 –º–º (–º¬≤)",
                `–†–æ–∑–º—ñ—Ä 1 —à—Ç: ${W}√ó${D} –º–º ¬∑ –ö-—Å—Ç—å: 2 —à—Ç ¬∑ –†–∞–∑–æ–º: ${eur(panelsM2)} –º¬≤`
            );


            // Permo: 4 —Ç–æ—á–∫–∏ –Ω–∞ –ø–∞–Ω–µ–ª—å —É —Ä–∞–º—Ü—ñ; 2 –ø–∞–Ω–µ–ª—ñ => 8 —Ç–æ—á–æ–∫/—Ä–∞–º–∫–∞
            const permoPointsPerPanel = 4;
            const permoPointsTotal = numFrames * 2 * permoPointsPerPanel;
            addPermoKit(permoPointsTotal);
        }

        // 2) –ó–∞–¥–Ω—è —Å—Ç—ñ–Ω–∫–∞ ‚Äî –ü–û –°–ï–ö–¶–Ü–Ø–• (catalog dims)
        if (backPanelType === "opaque8") {
            const backH = Hmont - 38;
            const backW = Lv + 16;
            const oneM2 = (backH * backW) / 1e6;
            rearAreaM2 = oneM2 * sectionsCount;

            addMaterialM2("PANEL_BACK_8_MM2", rearAreaM2, "–ó–∞–¥–Ω—è —Å—Ç—ñ–Ω–∫–∞ 8 –º–º (MDF/HDF) (–º¬≤)",
                `–°–ø–∏–Ω–∫–∞ 8 –º–º: ${sectionsCount}√ó(Lv+16)√ó(H-38) = ${backW}√ó${backH} –º–º ‚Üí ${eur(rearAreaM2)} –º¬≤`);
        }

        if (backPanelType === "glass6") {
            const backH = Hmont - 38;
            const backW = Lv + 11;
            const oneM2 = (backH * backW) / 1e6;
            rearAreaM2 = oneM2 * sectionsCount;

            addMaterialM2("GLASS_6_MM2", rearAreaM2, "–°–∫–ª–æ 6 –º–º (–º¬≤)",
                `–°–ø–∏–Ω–∫–∞ —Å–∫–ª–æ 6 –º–º: ${sectionsCount}√ó(Lv+11)√ó(H-38) = ${backW}√ó${backH} –º–º ‚Üí ${eur(rearAreaM2)} –º¬≤`);
            // === Busel v3 price for back glass 6mm (tempered) ===
            const b6 = calcBuselForPanel({ wMm: backW, hMm: backH, qty: sectionsCount, thicknessMm: 6, glassItemId: (opts.buselBackGlassId || "BUSEL_CHINA_FLOAT_CLEAR_6_RIZKA"), temperMinType: "float" });
            if (b6){
                const sumEur6 = b6.mtRetailUAH / Math.max(0.0001, b6._eurRate);
                const effEurM26 = sumEur6 / Math.max(0.0001, (b6.billingArea * b6.qty));
                setRowPriceByCode(
                    "GLASS_6_MM2",
                    effEurM26,
                    sumEur6,
                    `Busel v3 –≥–∞—Ä—Ç.: ${b6.qty} —à—Ç ¬∑ bill=${b6.billingArea.toFixed(3)} –º¬≤/—à—Ç ¬∑ kArea=${b6.kArea} ¬∑ kBatch=${b6.kBatch} ¬∑ min=${b6.temperMinUAH} –≥—Ä–Ω`
                );
            }

        }

        // 3) –ë–æ–∫–æ–≤—ñ –ø–∞–Ω–µ–ª—ñ (—Å–∫–ª–æ –≤ –ø–∞–∑ 4 –º–º) ‚Äî –ü–û –°–ï–ö–¶–Ü–Ø–• (catalog dims)
        const sidesCount = (sideGlass === "both") ? 2 : ((sideGlass === "left" || sideGlass === "right") ? 1 : 0);

        if (sidesCount > 0) {
            const sideH = Hmont;        // catalog: Hmontante = Hvetro
            const sideW = D - 3.5;      // catalog: Lfianco - 3.5mm

            // –∫—ñ–ª—å–∫—ñ—Å—Ç—å –¥–µ—Ç–∞–ª–µ–π (–ø–æ —Å–µ–∫—Ü—ñ—è—Ö + –ø–æ —Å—Ç–æ—Ä–æ–Ω–∞—Ö)
            const pieces = sectionsCount * sidesCount;

            // –ø–ª–æ—â–∞
            const oneM2 = (sideH * sideW) / 1e6;     // –º¬≤ –æ–¥–Ω—ñ—î—ó –±–æ–∫–æ–≤–∏–Ω–∏ (1 —à—Ç)
            sideAreaM2 = oneM2 * pieces;             // –∑–∞–≥–∞–ª—å–Ω–∞ –ø–ª–æ—â–∞

            // ‚úÖ –í–ò–í–Ü–î –†–û–ó–ú–Ü–†–£ (–º–º) + –ö–Ü–õ–¨–ö–û–°–¢–Ü (—à—Ç)
            addMaterialM2(
                "GLASS_4_MM2",
                sideAreaM2,
                "–°–∫–ª–æ 4 –º–º (–º¬≤)",
                `–†–æ–∑–º—ñ—Ä 1 —à—Ç: ${sideH.toFixed(1)}√ó${sideW.toFixed(1)} –º–º ¬∑ –ö-—Å—Ç—å: ${pieces} —à—Ç ¬∑ –†–∞–∑–æ–º: ${eur(sideAreaM2)} –º¬≤`
            );
            // === Busel v3 price for side glass 4mm (tempered) ===
            const b4 = calcBuselForPanel({ wMm: sideW, hMm: sideH, qty: pieces, thicknessMm: 4, glassItemId: (opts.buselSideGlassId || "BUSEL_FLOAT_CLEAR_4_RIZKA"), temperMinType: "float" });
            if (b4){
                const sumEur4 = b4.mtRetailUAH / Math.max(0.0001, b4._eurRate);
                const effEurM24 = sumEur4 / Math.max(0.0001, (b4.billingArea * b4.qty));
                setRowPriceByCode(
                    "GLASS_4_MM2",
                    effEurM24,
                    sumEur4,
                    `Busel v3 –≥–∞—Ä—Ç.: ${b4.qty} —à—Ç ¬∑ bill=${b4.billingArea.toFixed(3)} –º¬≤/—à—Ç ¬∑ kArea=${b4.kArea} ¬∑ kBatch=${b4.kBatch} ¬∑ min=${b4.temperMinUAH} –≥—Ä–Ω`
                );
            }


            // ‚úÖ PIATTO ‚Äî 1 —à—Ç –Ω–∞ –∫–æ–∂–Ω—É –±–æ–∫–æ–≤–∏–Ω—É (—Ç–æ–±—Ç–æ –Ω–∞ –∫–æ–∂–Ω—É –¥–µ—Ç–∞–ª—å)
            addMaterialPCS("PIATTO_25x2",  pieces, "–ü–ª–∞—Å—Ç–∏–Ω–∞ PIATTO-25x2",  "1 —à—Ç –Ω–∞ –±–æ–∫–æ–≤–∏–Ω—É (–ø–æ —Å–µ–∫—Ü—ñ—è—Ö)", "ONLY");
            addMaterialPCS("PIATTO_25x10", pieces, "–ü–ª–∞—Å—Ç–∏–Ω–∞ PIATTO-25x10", "1 —à—Ç –Ω–∞ –±–æ–∫–æ–≤–∏–Ω—É (–ø–æ —Å–µ–∫—Ü—ñ—è—Ö)", "ONLY");
        }


        // ====== Cutting plans per BAR item ======

        const cutsByBar = {};
        items.forEach(r => {
            if (r.sell_type === "BAR" && r.pieceLenMm) {
                if (!cutsByBar[r.id]) cutsByBar[r.id] = [];
                for (let i = 0; i < r.qtyPieces; i++) cutsByBar[r.id].push(r.pieceLenMm);
            }
        });

        const barPlans = {};
        Object.keys(cutsByBar).forEach(id => {
            barPlans[id] = packCutsFFD(cutsByBar[id], barLenEff, kerfMm);
        });

        // Fill BAR rows: bars/offcut/pay
        items.forEach(r => {
            if (r.sell_type === "BAR" && r.pieceLenMm) {
                const plan = barPlans[r.id];
                r.bars = plan.barsCount;
                r.offcut = plan.offcutTotal;
                r.qtyPay = paymentUnitsForPlan(plan); // 0.5/1 per bar
                r.cutInfo = formatCutPlanWithPay(plan);
                r.sumEur = r.qtyPay * r.priceEur; // —Ü—ñ–Ω–∞ –∑–∞ –ø–∞–ª–∫—É * –æ–ø–ª–∞—Ç–∞ –≤ –ø–∞–ª–∫–∞—Ö
            } else {
                r.qtyPay = r.qtyPieces;
                r.sumEur = r.qtyPieces * r.priceEur;
                r.cutInfo = "‚Äî";
            }
        });

        const totalEur = items.reduce((s, r) => s + (r.sumEur || 0), 0);
        const barsTotal = Object.values(barPlans).reduce((s, p) => s + p.barsCount, 0);
        const offcutTotal = Object.values(barPlans).reduce((s, p) => s + p.offcutTotal, 0);
        const payBarsTotal = items
            .filter(r => r.sell_type === "BAR")
            .reduce((s, r) => s + (r.qtyPay || 0), 0);

        return { items, totalEur, barsTotal, offcutTotal, barLen, barLenEff, payBarsTotal, trimEachSide, rearAreaM2, sideAreaM2, nHor, nShelves, shelfType, sideGlass, colorWarnings };
    }

    // ====== render ======
    
    function render(spec) {
        const kpi = document.getElementById('kpi');
        const rearTxt = (spec.rearAreaM2 && spec.rearAreaM2 > 0) ? `${eur(spec.rearAreaM2)} –º¬≤` : "‚Äî";
        const sideTxt = (spec.sideAreaM2 && spec.sideAreaM2 > 0) ? `${eur(spec.sideAreaM2)} –º¬≤` : "‚Äî";

        let kpiHtml = ""
          + `<span class="chip"><b>–†–∞–∑–æ–º:</b> ${eur(spec.totalEur)} ‚Ç¨</span>`
          + `<span class="chip"><b>–ü–∞–ª–∫–∏ (—Ñ–∞–∫—Ç):</b> ${spec.barsTotal} —à—Ç</span>`
          + `<span class="chip"><b>–û–ø–ª–∞—Ç–∞ (0.5/1):</b> ${eur(spec.payBarsTotal)} –ø–∞–ª.</span>`
          + `<span class="chip"><b>–ó–∞–ª–∏—à–æ–∫:</b> ${spec.offcutTotal} –º–º</span>`
          + `<span class="chip"><b>–ö–æ—Ä–∏—Å–Ω–∞ –¥–æ–≤–∂–∏–Ω–∞:</b> ${spec.barLenEff} –º–º</span>`
          + `<span class="chip"><b>–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—ñ:</b> ${spec.nHor} —à—Ç</span>`
          + `<span class="chip"><b>–ó–∞–¥–Ω—è —Å—Ç—ñ–Ω–∫–∞:</b> ${rearTxt}</span>`
          + `<span class="chip"><b>–ë–æ–∫–æ–≤–µ —Å–∫–ª–æ:</b> ${sideTxt}</span>`;

        if (spec.colorWarnings && spec.colorWarnings.length) {
            kpiHtml += spec.colorWarnings.map(t =>
                `<span class="chip" style="background:rgba(245,158,11,.12)"><b>‚ö†</b> ${t}</span>`
            ).join("");
        }

        kpi.innerHTML = kpiHtml;

        const tbody = document.querySelector('#tbl tbody');
        tbody.innerHTML = '';
        spec.items.forEach(r => {
            const tr = document.createElement('tr');
            const detailsCell =
                `<b>${r.qtyPieces}</b>` +
                (r.note ? `<div class="muted small">${r.note}</div>` : "") +
                ((r.sell_type === "BAR" && r.pieceLenMm)
                    ? `<div class="muted small">${eur(r.qtyPay || 0)} –ø–∞–ª. –¥–æ –æ–ø–ª–∞—Ç–∏</div>`
                    : "");
            tr.innerHTML = `
        <td><b>${r.code || r.id}</b></td>
        <td>${(r.name || r.name_ua || '')}<div class="muted small">${r.unit}</div></td>
        <td>${detailsCell}</td>
        <td class="muted">${r.cutInfo || '‚Äî'}</td>
        <td>${eur(r.priceEur)}</td>
        <td><b>${eur(r.sumEur || 0)}</b></td>
      `;
            tbody.appendChild(tr);
        });
    }


    // ====== CSV ======
    function toCSV(spec) {
        const lines = [];
        lines.push(["–ö–æ–¥","–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è","–î–µ—Ç–∞–ª—ñ","–û–ø–ª–∞—Ç–∞ (–ø–∞–ª.)","–û–¥–∏–Ω–∏—Ü—è","–¶—ñ–Ω–∞ EUR","–°—É–º–∞ EUR","–û–ø–∏—Å —Ä—ñ–∑–∫–∏"].join(";"));
        spec.items.forEach(r => {
            lines.push([
                (r.code || r.id),
                (r.name || "").replaceAll(";", ","),
                r.qtyPieces,
                (r.sell_type === "BAR" ? eur(r.qtyPay || 0) : ""),
                r.unit || "—à—Ç",
                eur(r.priceEur || 0),
                eur(r.sumEur || 0),
                (r.cutInfo || "").replaceAll(";", ",")
            ].join(";"));
        });
        return lines.join("\n");
    }
    function download(filename, text) {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([text], {type: 'text/csv;charset=utf-8;'}));
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
    }

    // ====== W range validation (MVP-2) ======
    function getWRange(shelfType){
        if (shelfType === "lait") return {min: 600, max: 1000, label: "LAIT (600‚Äì1000 –º–º)"};
        return {min: 600, max: 900, label: "–î–°–ü/–ú–î–§ (600‚Äì900 –º–º)"};
    }
    function updateWRangeUI(W, shelfType, frameMode){
    const warn = document.getElementById("wRangeWarn");
    const r = getWRange(shelfType);
    if (!warn) return;

    if (frameMode){
        const numSpans = Math.max(1, Math.ceil(W / r.max));
        const spanW = Math.ceil(W / numSpans);

        warn.style.display = "block";
        if (W < r.min){
            warn.innerHTML = `‚ö†Ô∏è –®–∏—Ä–∏–Ω–∞ W = <b>${W}</b> –º–º –º–µ–Ω—à–∞ –∑–∞ –º—ñ–Ω—ñ–º—É–º –¥–ª—è –ø–æ–ª–∏—Ü—å: <b>${r.min}</b> –º–º.`;
        } else if (spanW < r.min){
            warn.innerHTML = `‚ö†Ô∏è –†–µ–∂–∏–º —Ä–∞–º–æ–∫: —à–∏—Ä–∏–Ω–∞ –ø—Ä–æ–ª—å–æ—Ç—É <b>${spanW}</b> –º–º –º–µ–Ω—à–∞ –∑–∞ –º—ñ–Ω—ñ–º—É–º <b>${r.min}</b> –º–º.`;
        } else {
            warn.innerHTML = `‚ÑπÔ∏è –†–µ–∂–∏–º —Ä–∞–º–æ–∫: <b>${numSpans}</b> –ø—Ä–æ–ª—å–æ—Ç–∏ (~<b>${spanW}</b> –º–º) ¬∑ —Ä–∞–º–æ–∫: <b>${numSpans+1}</b> ¬∑ –ø–æ–ª–∏—Ü—ñ: <b>${r.label}</b>.`;
        }
        return;
    }

    if (W < r.min || W > r.max){
        warn.style.display = "block";
        warn.innerHTML = `‚ö†Ô∏è –®–∏—Ä–∏–Ω–∞ W = <b>${W}</b> –º–º –≤–∏—Ö–æ–¥–∏—Ç—å –∑–∞ —Ä–æ–±–æ—á—É —à–∏—Ä–∏–Ω—É –¥–ª—è –ø–æ–ª–∏—Ü—å: <b>${r.label}</b>.`;
    } else {
        warn.style.display = "none";
        warn.innerHTML = "";
    }
}






// ===== LAIT handoff (ONLY -> LAIT Lite) =====


(function initLaitHandoffOnce(){
    if (window.__laitHandoffInited) return;
    window.__laitHandoffInited = true;
    const openLaitBtn = document.getElementById('openLaitBtn');
    const laitHint    = document.getElementById('laitHint');
     // –ü–æ–≤–µ—Ä—Ç–∞—î "–∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø—Ä–æ–ª—å–æ—Ç—ñ–≤" (—Ä–∞–º–æ–∫ –ø–æ —à–∏—Ä–∏–Ω—ñ) –∑–∞ —Ç–≤–æ—ó–º –±—ñ–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–æ–º
    function getSpansCount(W, shelfType, frameMode){
        if (!frameMode) return 1;
         // –ø—Ä–∞–≤–∏–ª–æ: –î–°–ü <= 900, LAIT <= 1000 (—è–∫ —É —Ç–≤–æ—ó—Ö –ø—ñ–¥–∫–∞–∑–∫–∞—Ö)
        const maxSpan = (shelfType === 'lait') ? 1000 : 900;
        return Math.max(1, Math.ceil(W / maxSpan));
    }
     // –®–∏—Ä–∏–Ω–∞ –æ–¥–Ω–æ–≥–æ –ø—Ä–æ–ª—å–æ—Ç—É (Lvano). –¢—É—Ç –≤–∞–∂–ª–∏–≤–æ: –±–µ—Ä–µ–º–æ —à–∏—Ä–∏–Ω—É W —ñ –¥—ñ–ª–∏–º–æ –Ω–∞ –ø—Ä–æ–ª—ñ—Ç.
    // –Ø–∫—â–æ –ø—ñ–∑–Ω—ñ—à–µ –¥–æ–¥–∞—Å–∏ "—Ç–æ—Ä—Ü—ñ/–∑–∞–∑–æ—Ä–∏" ‚Äî –ø—Ä–∞–≤–∏—à —Ç—É—Ç –≤ –æ–¥–Ω–æ–º—É –º—ñ—Å—Ü—ñ.
    function getSectionClearWidthMm(W, spansCount){
        return W / spansCount;
    }
     function getEurRateSafe(){
        // —É ONLY EUR-–∫—É—Ä—Å–∞ –Ω–µ–º–∞—î —è–∫ —ñ–Ω–ø—É—Ç–∞ (—Ü—ñ–Ω–∏ –≤ EUR –∑ only.data.json),
        // —Ç–æ–º—É –±–µ—Ä–µ–º–æ –∑ localStorage (—è–∫—â–æ —î) –∞–±–æ –¥–µ—Ñ–æ–ª—Ç 49.5
        const v = Number(localStorage.getItem('eurRate') || 49.5);
        return Number.isFinite(v) ? v : 49.5;
    }
     function openLaitCalcFromOnly(){
        const W = parseFloat(document.getElementById('W').value || '0');
        const D = parseFloat(document.getElementById('D').value || '0');
        const shelfType    = document.getElementById('shelfType').value;
        const shelvesCount = parseInt(document.getElementById('shelvesCount').value || '0', 10);
        const frameMode    = !!document.getElementById('frameMode')?.checked;
         if (W <= 0 || D <= 0) { alert('–ó–∞–ø–æ–≤–Ω–∏ W —Ç–∞ D'); return; }
        if (shelvesCount <= 0) { alert('–í–∫–∞–∂–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–ª–∏—Ü—å > 0'); return; }
        if (shelfType !== 'lait') { alert('LAIT –¥–æ—Å—Ç—É–ø–Ω–∏–π –ª–∏—à–µ –∫–æ–ª–∏ "–¢–∏–ø –ø–æ–ª–∏—Ü—å" = LAIT'); return; }
         const spansCount = getSpansCount(W, shelfType, frameMode);
        const Lv = getSectionClearWidthMm(W, spansCount);
        const eurRate = getEurRateSafe();
         const url =
            `lait-lite.html` +
            `?eur=${encodeURIComponent(eurRate.toFixed(2))}` +
            `&len=${encodeURIComponent(Math.round(Lv))}` +
            `&dep=${encodeURIComponent(Math.round(D))}` +
            `&qty=${encodeURIComponent(shelvesCount)}`;
         window.open(url, '_blank');
    }
     function updateLaitUI(){
        const shelfType    = document.getElementById('shelfType')?.value;
        const shelvesCount = parseInt(document.getElementById('shelvesCount')?.value || '0', 10);
        const W = parseFloat(document.getElementById('W')?.value || '0');
        const D = parseFloat(document.getElementById('D')?.value || '0');
        const frameMode = !!document.getElementById('frameMode')?.checked;
         const show = shelfType === 'lait';
        if (openLaitBtn) openLaitBtn.style.display = show ? 'inline-flex' : 'none';
         if (laitHint){
            if (!show) { laitHint.textContent = ''; return; }
             const spansCount = getSpansCount(W, shelfType, frameMode);
            const Lv = (W > 0 ? getSectionClearWidthMm(W, spansCount) : 0);
             laitHint.textContent =
                `LAIT —Ä–∞—Ö—É—î–º–æ –≤ –æ–∫—Ä–µ–º–æ–º—É –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—ñ: ` +
                `–ø–µ—Ä–µ–¥–∞–º–æ –ø—Ä–æ–ª—ñ—Ç (‚âà${Math.round(Lv)} –º–º) + –≥–ª–∏–±–∏–Ω—É (${Math.round(D)} –º–º) + –∫-—Å—Ç—å –ø–æ–ª–∏—Ü—å (${shelvesCount}).`;
        }
    }
     window.__addLaitTotalRowIfAny = function(rows){
        const totalEur = Number(localStorage.getItem("ONLY_LAIT_TOTAL_EUR") || 0);
        if (!totalEur) return 0;
         const meta = JSON.parse(localStorage.getItem("ONLY_LAIT_META") || "{}");
         // –ø—Ä–∏–±—Ä–∞—Ç–∏ –¥—É–±–ª—å –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º—É –ø–µ—Ä–µ—Ä–∞—Ö—É–Ω–∫—É
        for (let i = rows.length - 1; i >= 0; i--) {
            if (rows[i]?.code === "LAIT_TOTAL") rows.splice(i, 1);
        }
         rows.push({
            code: "LAIT_TOTAL",
            name: "–ü–æ–ª–∏—Ü—ñ LAIT (–ø—ñ–¥—Å—É–º–æ–∫ –∑ LAIT –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞)",
            qtyPieces: 1,
            unit: "–∫–æ–º–ø–ª.",
            sell_type: "PCS",
            priceEur: totalEur,
            sumEur: totalEur,
            group: "LAIT",
            note: meta?.lenMm ? `L=${meta.lenMm} –º–º ¬∑ D=${meta.depMm} –º–º ¬∑ Qty=${meta.qty}` : ""
        });
         return totalEur;
    };


// attach once
    if (openLaitBtn) openLaitBtn.addEventListener('click', openLaitCalcFromOnly);
     document.getElementById('shelfType')?.addEventListener('change', updateLaitUI);
    document.getElementById('shelvesCount')?.addEventListener('input', updateLaitUI);
    document.getElementById('W')?.addEventListener('input', updateLaitUI);
    document.getElementById('D')?.addEventListener('input', updateLaitUI);
    document.getElementById('frameMode')?.addEventListener('change', updateLaitUI);
     updateLaitUI();
})();


// ====== events ======
    async function calculate() {
        const db = await loadDB();
        const busel = await loadBusel();
        const H = Number(document.getElementById('H').value);
        const W = Number(document.getElementById('W').value);
        const D = Number(document.getElementById('D').value);
        const trimEachSide = Number(document.getElementById('trimEachSide').value || 0);
        const backPanelType = document.getElementById('backPanelType').value; // none | opaque8 | glass6
        const buselBackGlassId = document.getElementById('buselBackGlassId')?.value || "BUSEL_CHINA_FLOAT_CLEAR_6_RIZKA";
        const buselSideGlassId = document.getElementById('buselSideGlassId')?.value || "BUSEL_FLOAT_CLEAR_4_RIZKA";
        const isLed = document.getElementById('isLed').checked;
        const colorCode = document.getElementById('colorCode').value;

        // ===== LAIT handoff (ONLY -> LAIT Lite) =====
// IMPORTANT: ONLY –Ω–µ –º–∞—î —ñ–Ω–ø—É—Ç—ñ–≤ sectionsCount/eurRate, —Ç–æ–º—É –ù–ï —á–∏—Ç–∞—î–º–æ —ó—Ö –∑ DOM.


if (!H || !W || !D) throw new Error("–ó–∞–ø–æ–≤–Ω–∏ H/W/D.");
        if (H < 300 || W < 300 || D < 200) throw new Error("–ù–µ—Ä–µ–∞–ª—å–Ω—ñ –≥–∞–±–∞—Ä–∏—Ç–∏. –ü–µ—Ä–µ–≤—ñ—Ä H/W/D.");

        const shelfType = document.getElementById('shelfType').value;
        const shelvesCount = Number(document.getElementById('shelvesCount').value || 0);
        const sideGlass = document.getElementById('sideGlass').value;

        const frameMode = document.getElementById('frameMode').checked;
        const topBottom25 = document.getElementById('topBottom25')?.checked ?? true;

        updateWRangeUI(W, shelfType, frameMode);

        const spec = buildSpec(db, { H, W, D, backPanelType, isLed, trimEachSide, colorCode, shelfType, shelvesCount, sideGlass, buselBackGlassId, buselSideGlassId, frameMode, topBottom25, busel });
// + LAIT total (—è–∫—â–æ —î –∑ lait-lite.html)
try {
    const laitAdd = window.__addLaitTotalRowIfAny ? window.__addLaitTotalRowIfAny(spec.items) : 0;
    if (laitAdd) {
        spec.totalEur = (spec.totalEur || 0) + laitAdd;
    }
} catch (e) {
    console.warn("LAIT total handoff skipped:", e);
}

        window.__onlySpec = spec;

        render(spec);

        // --- totals for client block + Telegram ---
        const rate = eurRateValue();
        lastCalc = {
          items: spec.items || [],
          totalEur: Number(spec.totalEur || 0),
          totalUah: Number(spec.totalEur || 0) * rate
        };

        const eurEl = document.getElementById("clientTotalEur");
        const uahEl = document.getElementById("clientTotalUah");
        if (eurEl) eurEl.textContent = lastCalc.totalEur.toFixed(2);
        if (uahEl) uahEl.textContent = Math.round(lastCalc.totalUah).toString();

        if (clientSummaryEl) clientSummaryEl.style.display = "block";
        if (currentMode !== "manager") setMode("client");

    }

    document.getElementById('btnCalc').addEventListener('click', () => {
        calculate().catch(err => alert(err.message || String(err)));
    });

    document.getElementById('btnCsv').addEventListener('click', () => {
        const spec = window.__onlySpec;
        if (!spec) return alert("–°–ø–æ—á–∞—Ç–∫—É –Ω–∞—Ç–∏—Å–Ω–∏ ¬´–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏¬ª.");
        download("ONLY_spec.csv", toCSV(spec));
    });

        // auto recalc on input change
    [
        "H","W","D","trimEachSide",
        "backPanelType","buselBackGlassId",
        "sideGlass","buselSideGlassId",
        "isLed","colorCode",
        "shelfType","shelvesCount",
        "frameMode","topBottom25"
    ].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener('input', () => calculate().catch(()=>{}));
        el.addEventListener('change', () => calculate().catch(()=>{}));
    });



    // ====== –†–µ–∂–∏–º (–∫–ª—ñ—î–Ω—Ç/–º–µ–Ω–µ–¥–∂–µ—Ä) + Telegram (1:1 —è–∫ eTSecutive) ======
    let currentMode = "client";        // client | manager
    let managerUnlocked = false;
    let lastCalc = null;

    const managerToggleBtn = document.getElementById("managerToggleBtn");
    const currentModeLabel = document.getElementById("currentModeLabel");
    const managerDetailsEl = document.getElementById("managerDetails");
    const clientSummaryEl  = document.getElementById("clientSummary");

    const contactFirstName = document.getElementById("contactFirstName");
    const contactLastName  = document.getElementById("contactLastName");
    const contactPhone     = document.getElementById("contactPhone");
    const sendToTelegramBtn= document.getElementById("sendToTelegramBtn");

    const TELEGRAM_FORM_SECRET = "mtx-volpato-2025";
    const EUR_RATE_FALLBACK = 49.50;

    function eurRateValue(){
      // —è–∫—â–æ –¥–µ—Å—å –∑ º—è–≤–∏—Ç—å—Å—è —ñ–Ω–ø—É—Ç eurRate ‚Äî –ø—ñ–¥—Ö–æ–ø–∏–º–æ –∞–≤—Ç–æ–º–∞—Ç–æ–º
      const el = document.getElementById("eurRate");
      const v = el ? Number(el.value || 0) : 0;
      return (v && v > 0) ? v : (window.__EUR_RATE || EUR_RATE_FALLBACK);
    }

    function setMode(mode){
      currentMode = mode;
      currentModeLabel.textContent = (mode === "manager") ? "–†–µ–∂–∏–º: –º–µ–Ω–µ–¥–∂–µ—Ä" : "–†–µ–∂–∏–º: –∫–ª—ñ—î–Ω—Ç";
      if (managerDetailsEl) managerDetailsEl.style.display = (mode === "manager") ? "block" : "none";
      if (clientSummaryEl)  clientSummaryEl.style.display  = lastCalc ? "block" : "none";
    }

    function getCurrentModeLabel(){
      return (currentMode === "manager") ? "–º–µ–Ω–µ–¥–∂–µ—Ä" : "–∫–ª—ñ—î–Ω—Ç";
    }

    if (managerToggleBtn){
      managerToggleBtn.addEventListener("click", () => {
        if (!managerUnlocked){
          const pwd = prompt("–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞");
          if (pwd !== "603"){ alert("–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å"); return; }
          managerUnlocked = true;
        }
        setMode("manager");
      });
    }

    function collectCSVForTelegram(){
      if (!lastCalc?.items) return "";
      return lastCalc.items
        .filter(it => (it.qtyPieces ?? it.qty ?? 0) > 0)
        .map(it => {
          const qty = (it.qtyPieces ?? it.qty ?? 0);
          const price = (it.priceEur ?? it.price ?? 0);
          const sum = (it.sumEur ?? it.sum ?? (qty * price));
          const code = it.code || it.id || "";
          const name = it.name || "";
          return `${code}; ${name}; ${qty}; ${Number(price).toFixed(2)}; ${Number(sum).toFixed(2)}`;
        })
        .join("\n");
    }

    async function sendCalculationToTelegram(){
      if (!lastCalc){ alert("–°–ø–æ—á–∞—Ç–∫—É –∑—Ä–æ–±—ñ—Ç—å —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫"); return; }

      const firstName = (contactFirstName?.value || "").trim();
      const lastName  = (contactLastName?.value  || "").trim();
      const phone     = (contactPhone?.value     || "").trim();

      if (!firstName){ alert("–í–∫–∞–∂—ñ—Ç—å —ñ–º º—è"); return; }
      if (!/^0\d{9}$/.test(phone)){ alert("–¢–µ–ª–µ—Ñ–æ–Ω —É —Ñ–æ—Ä–º–∞—Ç—ñ 0XXXXXXXXX"); return; }

      const H = document.getElementById("H")?.value || "-";
      const W = document.getElementById("W")?.value || "-";
      const D = document.getElementById("D")?.value || "-";

      const textSummary = [
        "üì® –ù–æ–≤–∞ –∑–∞—è–≤–∫–∞: ONLY",
        "",
        `üë§ ${firstName} ${lastName}`.trim(),
        `üìû ${phone}`,
        "",
        `üîÅ –†–µ–∂–∏–º: *${getCurrentModeLabel()}*`,
        "",
        `–ì–∞–±–∞—Ä–∏—Ç–∏: *${W}√ó${H}√ó${D} –º–º*`,
        "",
        `üí∞ –°—É–º–∞: *${lastCalc.totalEur.toFixed(2)} ‚Ç¨* (~ *${Math.round(lastCalc.totalUah)} –≥—Ä–Ω*)`
      ].join("\n");

      const csv = collectCSVForTelegram();
      const textCsv = "```\n–ö–æ–¥; –ù–∞–∑–≤–∞; –ö—ñ–ª—å–∫—ñ—Å—Ç—å; –¶—ñ–Ω–∞ ‚Ç¨/–æ–¥; –°—É–º–∞ ‚Ç¨\n" + csv + "\n```";

      await fetch("https://mt-volpato.vercel.app/api/telegram", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ secret: TELEGRAM_FORM_SECRET, text: textSummary })
      });

      await fetch("https://mt-volpato.vercel.app/api/telegram", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ secret: TELEGRAM_FORM_SECRET, text: textCsv })
      });

      alert("–ó–∞—è–≤–∫—É –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úÖ");
    }

    if (sendToTelegramBtn){
      sendToTelegramBtn.addEventListener("click", sendCalculationToTelegram);
    }


    // initial
    setMode('client');
    calculate().catch(e=>{ console.error(e); alert(e?.message || String(e)); });
</script>
</body>
</html>
