<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MT Hub ¬∑ IKS (—Å–∫–ª—è–Ω—ñ —Ñ–∞—Å–∞–¥–∏)</title>

  <style>
    :root {
      --bg: #f4f5fb;
      --bg-elevated: #ffffff;
      --bg-hero: #f9fafb;
      --text: #020617;
      --text-main: #141414;
      --text-muted: #555;
      --accent: #16a34a;
      --accent-soft: rgba(22, 163, 74, 0.08);
      --border: rgba(148, 163, 184, 0.40);
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.12);
      --radius-lg: 22px;
      --radius-md: 18px;
    }

    .dark-theme {
      --bg: #020617;
      --bg-elevated: #020617;
      --bg-hero: #020617;
      --text: #e5e7eb;
      --text-main: #ffffff;
      --text-muted: #cfcfcf;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.12);
      --border: rgba(148, 163, 184, 0.25);
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.90);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top left, #e0f2fe 0, transparent 40%),
        radial-gradient(circle at bottom right, #dcfce7 0, transparent 45%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    .page {
      max-width: 1120px;
      margin: 0 auto;
      padding: 32px 16px 56px;
    }

    /* TOPBAR */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.90);
      box-shadow: 0 12px 35px rgba(15, 23, 42, 0.12);
      border: 1px solid rgba(148, 163, 184, 0.35);
      backdrop-filter: blur(10px);
      margin-bottom: 22px;
      gap: 14px;
    }
    .dark-theme .topbar {
      background: rgba(15, 23, 42, 0.92);
      border-color: rgba(148, 163, 184, 0.35);
    }

    .topbar-left{
      display:flex;
      align-items:center;
      gap: 14px;
      min-width: 260px;
    }

    .brand {
      display:flex;
      flex-direction: column;
      line-height: 1.05;
    }
    .brand b {
      font-size: 13px;
      letter-spacing: 0.2px;
      color: var(--text-main);
    }
    .brand span {
      font-size: 11px;
      color: var(--text-muted);
    }

    .nav {
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
      padding: 0 6px;
      flex: 1;
    }

    .nav a{
      text-decoration: none;
      font-size: 12px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(255, 255, 255, 0.70);
      color: var(--text-main);
      transition: transform .15s ease, background .15s ease;
    }
    .dark-theme .nav a{
      background: rgba(2, 6, 23, 0.35);
      border-color: rgba(148, 163, 184, 0.25);
      color: var(--text);
    }
    .nav a:hover { transform: translateY(-1px); }
    .nav a.active{
      background: var(--accent-soft);
      border-color: rgba(22,163,74,0.35);
    }
    .dark-theme .nav a.active{
      border-color: rgba(34,197,94,0.35);
    }

    .topbar-actions{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 220px;
      justify-content: flex-end;
    }

    .pill{
      display:flex;
      align-items:center;
      gap: 8px;
      border-radius: 999px;
      padding: 8px 12px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(255, 255, 255, 0.70);
      font-size: 12px;
      color: var(--text-main);
      cursor: pointer;
      user-select: none;
    }
    .dark-theme .pill{
      background: rgba(2, 6, 23, 0.35);
      border-color: rgba(148, 163, 184, 0.25);
      color: var(--text);
    }

    /* SECTIONS / CARDS */
    .hero {
      padding: 24px 24px 26px;
      border-radius: var(--radius-lg);
      background: rgba(255,255,255,0.86);
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(10px);
      margin-bottom: 18px;
    }
    .dark-theme .hero{
      background: rgba(15, 23, 42, 0.62);
      border-color: rgba(148, 163, 184, 0.25);
    }

    .hero h1{
      margin: 0 0 10px;
      font-size: 24px;
      color: var(--text-main);
      letter-spacing: -0.2px;
    }
    .hero p{
      margin: 0;
      color: var(--text-muted);
      font-size: 14px;
      line-height: 1.55;
      max-width: 78ch;
    }
    .dark-theme .hero p{ color: rgba(229,231,235,0.78); }

    .grid2{
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 14px;
      margin-bottom: 18px;
    }
    @media (max-width: 980px){
      .grid2{ grid-template-columns: 1fr; }
      .topbar{ flex-wrap: wrap; border-radius: 26px; }
      .topbar-left, .topbar-actions{ min-width: unset; width: 100%; justify-content: space-between; }
      .nav{ width: 100%; justify-content: flex-start; }
    }

    .card{
      border-radius: var(--radius-lg);
      background: rgba(255,255,255,0.86);
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(10px);
      padding: 18px 18px 18px;
    }
    .dark-theme .card{
      background: rgba(15, 23, 42, 0.62);
      border-color: rgba(148, 163, 184, 0.25);
    }

    .card h2{
      margin: 0 0 10px;
      font-size: 16px;
      color: var(--text-main);
    }
    .card .lead{
      margin: 0 0 12px;
      color: var(--text-muted);
      font-size: 13px;
      line-height: 1.55;
    }
    .dark-theme .card .lead{ color: rgba(229,231,235,0.78); }

    .list{
      margin: 0;
      padding-left: 18px;
      color: var(--text-muted);
      font-size: 13px;
      line-height: 1.55;
    }
    .dark-theme .list{ color: rgba(229,231,235,0.78); }
    .list li + li{ margin-top: 6px; }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(255,255,255,0.72);
      color: var(--text-main);
      text-decoration:none;
      font-size: 12px;
      cursor:pointer;
      transition: transform .15s ease;
      white-space: nowrap;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn.primary{
      background: var(--accent-soft);
      border-color: rgba(22,163,74,0.35);
    }
    .dark-theme .btn{ background: rgba(2, 6, 23, 0.35); color: var(--text); border-color: rgba(148, 163, 184, 0.25); }
    .dark-theme .btn.primary{ border-color: rgba(34,197,94,0.35); background: rgba(34,197,94,0.12); }

    /* MEDIA GRID */
    .mediaGrid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 14px;
      margin-top: 14px;
    }
    @media (max-width: 980px){
      .mediaGrid{ grid-template-columns: 1fr; }
    }

    .mediaCard{
      grid-column: span 4;
      border-radius: var(--radius-md);
      overflow:hidden;
      border: 1px solid rgba(148, 163, 184, 0.28);
      background: rgba(255,255,255,0.80);
      box-shadow: 0 18px 45px rgba(0,0,0,0.08);
    }
    .dark-theme .mediaCard{
      background: rgba(15,23,42,0.55);
      border-color: rgba(148,163,184,0.22);
      box-shadow: 0 18px 45px rgba(0,0,0,0.35);
    }
    @media (max-width: 980px){
      .mediaCard{ grid-column: span 12; }
    }

    .mediaThumb{
      aspect-ratio: 16 / 10;
      width: 100%;
      background: rgba(2,6,23,0.15);
    }
    .mediaThumb img{
      
      width: 100%;
      height: 100%;
      object-fit: cover;
      display:block;
    }

    .mediaThumb.contain img{
      object-fit: contain;
      padding: 10px;
      background: rgba(2,6,23,0.10);
    }


    .mediaBody{
      padding: 12px 14px 14px;
    }
    .mediaTitle{
      margin: 0 0 4px 0;
      font-weight: 800;
      font-size: 13px;
      color: var(--text-main);
    }
    .dark-theme .mediaTitle{ color: #fff; }

    .mediaText{
      margin: 0;
      font-size: 12.5px;
      color: rgba(51,65,85,0.85);
      line-height: 1.35;
    }
    .dark-theme .mediaText{ color: rgba(229,231,235,0.72); }

    
    /* ===== Calculator (IKS) ‚Äî same vibe as ONLY/LAIT ===== */
    .section-headline{
      margin: 0 0 10px;
      font-size: 18px;
      letter-spacing: -0.2px;
      color: var(--text-main);
    }
    .section-lead{
      margin: 0 0 16px;
      color: var(--text-muted);
      font-size: 13px;
      line-height: 1.55;
      max-width: 86ch;
    }
    .dark-theme .section-lead{ color: rgba(229,231,235,0.78); }

    .calcRoot{
      border-radius: var(--radius-lg);
      background: rgba(255,255,255,0.86);
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(10px);
      padding: 18px;
    }
    .dark-theme .calcRoot{
      background: rgba(15, 23, 42, 0.62);
      border-color: rgba(148, 163, 184, 0.25);
    }

    .calcGrid{
      display:grid;
      grid-template-columns: 1.05fr 0.95fr;
      gap: 14px;
      margin-top: 10px;
    }
    @media (max-width: 980px){
      .calcGrid{ grid-template-columns: 1fr; }
    }

    .panel{
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.28);
      background: rgba(255,255,255,0.75);
      padding: 14px;
    }
    .dark-theme .panel{
      background: rgba(2, 6, 23, 0.35);
      border-color: rgba(148, 163, 184, 0.22);
    }

    .panelTitle{
      margin: 0 0 10px;
      font-size: 13px;
      font-weight: 800;
      color: var(--text-main);
    }
    .dark-theme .panelTitle{ color: #fff; }

    .formGrid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 10px;
    }
    .field{ grid-column: span 6; display:flex; flex-direction:column; gap: 6px; }
    .field.full{ grid-column: span 12; }
    @media (max-width: 680px){
      .field{ grid-column: span 12; }
    }
    .field label{
      font-size: 12px;
      color: rgba(71,85,105,0.92);
    }
    .dark-theme .field label{ color: rgba(229,231,235,0.70); }

    .field input, .field select, .field textarea{
      width: 100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.40);
      background: rgba(255,255,255,0.88);
      color: var(--text-main);
      outline: none;
      font-size: 13px;
    }
    .dark-theme .field input,
    .dark-theme .field select,
    .dark-theme .field textarea{
      background: rgba(15, 23, 42, 0.65);
      border-color: rgba(148, 163, 184, 0.25);
      color: var(--text);
    }
    .field textarea{ min-height: 86px; resize: vertical; }

    .rowActions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
      align-items:center;
    }

    .hint{
      margin-top: 8px;
      font-size: 12px;
      color: rgba(71,85,105,0.85);
      line-height: 1.45;
    }
    .dark-theme .hint{ color: rgba(229,231,235,0.65); }

    .sumGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .sumBox{
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(255,255,255,0.70);
      padding: 12px;
    }
    .dark-theme .sumBox{
      background: rgba(2, 6, 23, 0.30);
      border-color: rgba(148, 163, 184, 0.20);
    }
    .sumBox h4{
      margin: 0 0 8px;
      font-size: 12px;
      font-weight: 800;
      color: var(--text-main);
    }
    .dark-theme .sumBox h4{ color: #fff; }

    .kv{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      font-size: 12.5px;
      padding: 6px 0;
      border-bottom: 1px dashed rgba(148,163,184,0.25);
    }
    .kv:last-child{ border-bottom: none; }
    .kv b{ color: var(--text-main); }
    .dark-theme .kv b{ color: #fff; }
    .kv span{ color: rgba(71,85,105,0.92); }
    .dark-theme .kv span{ color: rgba(229,231,235,0.72); }

    .warn{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(245, 158, 11, 0.35);
      background: rgba(245, 158, 11, 0.08);
      color: rgba(92, 56, 0, 0.9);
      font-size: 12px;
      line-height: 1.45;
    }
    .dark-theme .warn{
      color: rgba(255, 237, 213, 0.92);
      background: rgba(245, 158, 11, 0.10);
      border-color: rgba(245, 158, 11, 0.28);
    }

    .modeRow{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      margin-bottom: 10px;
    }
    .modeBadge{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      font-size: 12px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(255,255,255,0.72);
      color: var(--text-main);
    }
    .dark-theme .modeBadge{
      background: rgba(2, 6, 23, 0.35);
      border-color: rgba(148, 163, 184, 0.25);
      color: var(--text);
    }

    footer{
      margin-top: 22px;
      color: rgba(71,85,105,0.85);
      font-size: 12px;
      text-align: center;
    }
    .dark-theme footer{ color: rgba(229,231,235,0.65); }
  
/* ONLY handoff button */
#applyToOnlyBtn{border-color: rgba(46, 204, 113, .55);} 
#applyToOnlyBtn:hover{box-shadow: 0 0 0 3px rgba(46, 204, 113, .10);} 

</style>
</head>

<body>
  <div class="page" id="pageRoot">
    <!-- TOPBAR -->
    <div class="topbar">
      <div class="topbar-left">
        <div class="brand">


        </div>
      </div>

      <nav class="nav" aria-label="–ù–∞–≤—ñ–≥–∞—Ü—ñ—è">
        <a href="index.html">MT Hub</a>
        <a href="only.html">ONLY</a>
        <a href="lait-lite.html">LAIT</a>
        <a href="iks.html" class="active">IKS</a>
      </nav>

      <div class="topbar-actions">
        <button id="themeToggle" class="pill" type="button" title="–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ —Ç–µ–º—É">
          üåó <span id="themeLabel">–¢–µ–º–∞</span>
        </button>
      </div>
    </div>

    <!-- HERO -->
    <section class="hero">
      <h1>IKS ‚Äî —Å–∫–ª—è–Ω—ñ —Ñ–∞—Å–∞–¥–∏</h1>
      <p>
        –ê–ª—é–º—ñ–Ω—ñ—î–≤–∞ —Å–∏—Å—Ç–µ–º–∞ —Ä–æ–∑–ø–∞—à–Ω–∏—Ö —Å–∫–ª—è–Ω–∏—Ö –¥–≤–µ—Ä–µ–π –¥–ª—è –ø—Ä–µ–º—ñ–∞–ª—å–Ω–∏—Ö —à–∞—Ñ, –≤—ñ—Ç—Ä–∏–Ω —Ç–∞ –≥–∞—Ä–¥–µ—Ä–æ–±—ñ–≤.
      </p>
    </section>

    <section class="grid2">
      <article class="card">
        <h2>–°–∏—Å—Ç–µ–º–∞ IKS</h2>
        <p class="lead">
          –ü–æ–≤–Ω–æ—Ä–æ–∑–º—ñ—Ä–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —Å–∫–ª—è–Ω–∏—Ö —Ñ–∞—Å–∞–¥—ñ–≤ —ñ–∑ –ø—Ä–∏—Ö–æ–≤–∞–Ω–∏–º–∏ –ø–µ—Ç–ª—è–º–∏. –û—Ä—ñ—î–Ω—Ç–æ–≤–Ω–æ –¥–æ 33 –∫–≥ –Ω–∞ –ø–∞—Ä—É –ø–µ—Ç–µ–ª—å
          (–∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó).
        </p>
        <ul class="list">
          <li><b>–ü—Ä–æ—Ñ—ñ–ª—å:</b> IS-954 (–≤–∫–ª–µ–π–∫–∞) / IS-955 (—Å–∫–ª–æ –≤ –ø–∞–∑)</li>
          <li><b>–°–∫–ª–æ:</b> 4‚Äì6 –º–º</li>
          <li><b>–ö—É—Ç –≤—ñ–¥–∫—Ä–∏–≤–∞–Ω–Ω—è:</b> 95¬∞ / 180¬∞</li>
          <li><b>–†–µ–≥—É–ª—é–≤–∞–Ω–Ω—è:</b> –≤–∏—Å–æ—Ç–∞ / —à–∏—Ä–∏–Ω–∞ / –≥–ª–∏–±–∏–Ω–∞</li>
        </ul>
      </article>

      <aside class="card">
        <h2>–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è</h2>
              <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <a class="btn primary" href="IKS-mini_IKS_Only-IKS.pdf" target="_blank"
             rel="noopener">üìÑ –°–∫–∞—á–∞—Ç–∏ –∫–∞—Ç–∞–ª–æ–≥ IKS (PDF)</a>
          <a class="btn" href="#gallery">üñºÔ∏è –í—É–∑–ª–∏ (–≥–∞–ª–µ—Ä–µ—è)</a>
        </div>
             </aside>
    </section>


    
    <!-- CALCULATOR -->
    <section id="calculator" style="margin-bottom: 18px;">
      <h2 class="section-headline">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä IKS (—Å–∫–ª–æ + IKS/IKS mini)</h2>
      <p class="section-lead">
        –í–∫–∞–∂—ñ—Ç—å –≥–∞–±–∞—Ä–∏—Ç —Ñ–∞—Å–∞–¥—É —Ç–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ —Å–∏—Å—Ç–µ–º–∏. –î–æ—Å—Ç—É–ø–Ω—ñ 2 –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∏ —Å–∫–ª–∞: <b>–í–∞—Ä—ñ–∞–Ω—Ç A</b> —Ç–∞ <b>–í–∞—Ä—ñ–∞–Ω—Ç B</b>,
        –∑ –ø–µ—Ä–µ–º–∏–∫–∞—á–µ–º <b>–∑–∞–≥–∞—Ä—Ç–æ–≤–∞–Ω–µ / –Ω–µ –∑–∞–≥–∞—Ä—Ç–æ–≤–∞–Ω–µ</b>. –†–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–∂–Ω–∞ —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –∞–±–æ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤ Telegram, –∞ —Ç–∞–∫–æ–∂ —Å–∫–∞—á–∞—Ç–∏ CSV –¥–ª—è 1–°.
      </p>

      <div class="calcRoot">
        <div class="modeRow">
          <span class="modeBadge">üîÅ –†–µ–∂–∏–º: <b id="modeLabel">–∫–ª—ñ—î–Ω—Ç</b></span>
          <button class="btn" id="modeToggleBtn" type="button">–ö–ª—ñ—î–Ω—Ç / –ú–µ–Ω–µ–¥–∂–µ—Ä</button>
          <button class="btn primary" id="calcBtn" type="button">–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏</button>
          <button class="btn" id="applyToOnlyBtn" type="button" title="–ó–±–µ—Ä–µ–≥—Ç–∏ IKS —è–∫ add-on –¥–ª—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ ONLY">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –¥–æ ONLY</button>
        </div>

        <div class="calcGrid">
          <!-- Inputs -->
          <div class="panel">
            <h3 class="panelTitle">–í—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ</h3>

            <div class="formGrid">
              <div class="field">
                <label for="eurRate">–ö—É—Ä—Å EUR, –≥—Ä–Ω</label>
                <input id="eurRate" type="number" value="49.5" step="0.01" />
              </div>

              <div class="field">
                <label for="qty">–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ñ–∞—Å–∞–¥—ñ–≤, —à—Ç</label>
                <input id="qty" type="number" value="1" min="1" step="1" />
              </div>

              <div class="field">
                <label for="doorW">–®–∏—Ä–∏–Ω–∞ —Ñ–∞—Å–∞–¥—É, –º–º</label>
                <input id="doorW" type="number" value="500" min="120" step="1" />
              </div>

              <div class="field">
                <label for="doorH">–í–∏—Å–æ—Ç–∞ —Ñ–∞—Å–∞–¥—É, –º–º</label>
                <input id="doorH" type="number" value="700" min="200" step="1" />
              </div>

              <div class="field">
                <label for="systemType">–°–∏—Å—Ç–µ–º–∞</label>
                <select id="systemType">
                  <option value="IKS">IKS (33 –∫–≥)</option>
                  <option value="IKS_MINI">IKS mini (20 –∫–≥)</option>
                </select>
              </div>

              <div class="field">
                <label for="profileType">–ü—Ä–æ—Ñ—ñ–ª—å</label>
                <select id="profileType">
                  <!-- IKS -->
                  <option value="IS954" data-sys="IKS">IS-954 (—Å–∫–ª–æ –ø—Ä–∏–∫–ª–µ—é—î—Ç—å—Å—è)</option>
                  <option value="IS955" data-sys="IKS">IS-955 (—Å–∫–ª–æ –≤ –ø–∞–∑ + —É—â—ñ–ª—å–Ω—é–≤–∞—á)</option>
                  <!-- IKS mini -->
                  <option value="ISM956" data-sys="IKS_MINI">ISM-956 (–≤–∫–ª–µ–π–∫–∞ —Å–∫–ª–∞)</option>
                  <option value="ISM955" data-sys="IKS_MINI">ISM-955 (—Å–∫–ª–æ –≤ –ø–∞–∑ 4 –º–º + —É—â—ñ–ª—å–Ω—é–≤–∞—á)</option>
                </select>
              </div>

              <div class="field">
                <label for="finish">–ö–æ–ª—ñ—Ä</label>
                <select id="finish">
                  <option value="NS">–ß–æ—Ä–Ω–∏–π –º–∞—Ç (NS)</option>
                  <option value="DE">–ü—ñ–¥ —Ñ–∞—Ä–±—É–≤–∞–Ω–Ω—è (DE)</option>
                  <option value="BRA">–ë—Ä–æ–Ω–∑–∞ Armani</option>
                  <option value="BRC">–ë—Ä–æ–Ω–∑–∞ Cartier</option>
                </select>
              </div>

              <div class="field">
                <label for="angle">–ö—É—Ç –≤—ñ–¥–∫—Ä–∏–≤–∞–Ω–Ω—è</label>
                <select id="angle">
                  <option value="95">95¬∞</option>
                  <option value="180">180¬∞</option>
                </select>
              </div>
              <div class="field" id="hingeField">
                <label for="hingeMode">–ü–µ—Ç–ª—ñ (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º ‚Äî –∑ –¥–æ–≤–æ–¥—á–∏–∫–æ–º)</label>
                <select id="hingeMode">
                  <option value="PI">–ó –¥–æ–≤–æ–¥—á–∏–∫–æ–º (PI) ‚Äî default MT</option>
                  <option value="NO_CLOSER">–ë–µ–∑ –¥–æ–≤–æ–¥—á–∏–∫–∞</option>
                  <option value="TIPON">Tip-On</option>
                </select>
                <div class="hint" id="hingeHint" style="margin-top:6px; opacity:.8; font-size:12px;">
                  –î–ª—è 180¬∞ –ø–µ—Ç–ª—ñ –ø—ñ–¥–±–∏—Ä–∞—é—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ (–æ–∫—Ä–µ–º–∏–π –∫–æ–º–ø–ª–µ–∫—Ç).
                </div>
              </div>


              <div class="field">
                <label for="supplier">–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫ —Å–∫–ª–∞</label>
                <select id="supplier">
                  <option value="ABSTRACT">–í–∞—Ä—ñ–∞–Ω—Ç A</option>
                  <option value="BUSEL">–í–∞—Ä—ñ–∞–Ω—Ç B</option>
                </select>
              </div>

              <div class="field full">
                <label for="glassItem">–°–∫–ª–æ (–∑ –±–∞–∑–∏)</label>
                <select id="glassItem"></select>
              </div>

              <div class="field">
                <label for="tempered">–ó–∞–≥–∞—Ä—Ç–æ–≤–∞–Ω–µ</label>
                <select id="tempered">
                  <option value="1">–¢–∞–∫</option>
                  <option value="0">–ù—ñ</option>
                </select>
              </div>

              <div class="field">
                <label for="edgePolish">–ü–æ–ª—ñ—Ä—É–≤–∞–Ω–Ω—è –∫—Ä–æ–º–∫–∏</label>
                <select id="edgePolish">
                  <option value="1">–¢–∞–∫</option>
                  <option value="0">–ù—ñ</option>
                </select>
              </div>

              <div class="field full">
                <label>
                  <input type="checkbox" id="adhesionPrep" checked />
                  –í–∞—Ä—ñ–∞–Ω—Ç A: ‚Äú–ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø—ñ–¥ –ø—Ä–æ—Ñ—ñ–ª—å / —Ñ–∞—Ä–±—É–≤–∞–Ω–Ω—è‚Äù (–ª–∏—à–µ –¥–ª—è –≤–∫–ª–µ–π–∫–∏)
                </label>
              </div>


              <div class="field full" id="buselPaintBlock" style="display:none;">
                <label class="checkbox">
                  <input type="checkbox" id="buselPaint" />
                  –í–∞—Ä—ñ–∞–Ω—Ç B: —Ñ–∞—Ä–±—É–≤–∞–Ω–Ω—è / –µ–º–∞–ª—é–≤–∞–Ω–Ω—è (–Ω–µ–ø—Ä–æ–∑–æ—Ä–µ RAL –∞–±–æ NCS, <b>–º–∞–ª–∞ –ø–∞—Ä—Ç—ñ—è</b>)
                </label>
                <label class="checkbox" style="margin-top:6px;">
                  <input type="checkbox" id="buselPaintEdgeClean" />
                  –í–∞—Ä—ñ–∞–Ω—Ç B: –∑–∞—á–∏—Å—Ç–∫–∞ —Ç–æ—Ä—Ü—ñ–≤ –≤—ñ–¥ —Ñ–∞—Ä–±–∏ (+50% –¥–æ —Ñ–∞—Ä–±—É–≤–∞–Ω–Ω—è, —Ç—ñ–ª—å–∫–∏ —Ç–æ–≤—â–∏–Ω–∞ ‚â• 6 –º–º)
                </label>
                <div class="help" style="margin-top:6px; opacity:.85;">
                  –ü—Ä–∏–º—ñ—Ç–∫–∞: –≤–∏—Ä—ñ–± <b>&lt; 0.25 –º¬≤</b> —Ç–∞—Ä–∏—Ñ—ñ–∫—É—î—Ç—å—Å—è —è–∫ <b>0.25 –º¬≤</b>.
                </div>
              </div>

              <!-- Manager details -->
              <div class="field full" id="managerBlock" style="display:none;">
                <label for="clientName">–ö–ª—ñ—î–Ω—Ç / –ö–æ–Ω—Ç–∞–∫—Ç (–¥–ª—è Telegram)</label>
                <input id="clientName" type="text" placeholder="–Ü–º º—è –∞–±–æ –∫–æ–º–ø–∞–Ω—ñ—è" />
                <div style="height:10px"></div>
                <label for="clientPhone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                <input id="clientPhone" type="text" placeholder="067..." />
                <div style="height:10px"></div>
                <label for="comment">–ö–æ–º–µ–Ω—Ç–∞—Ä</label>
                <textarea id="comment" placeholder="–ù–∞–ø—Ä.: —Ñ–∞—Å–∞–¥–∏ —É –≤—ñ—Ç—Ä–∏–Ω—É, –ø–æ—Ç—Ä—ñ–±–Ω—ñ 180¬∞ –ø–µ—Ç–ª—ñ"></textarea>
              </div>
            </div>

            <div class="hint">
              <b>–§–æ—Ä–º—É–ª–∞ —Å–∫–ª–∞ (—Ç–æ—á–Ω—ñ –¥–æ–ø—É—Å–∫–∏):</b> <span id="glassRuleText">‚Äî</span>
            </div>
          </div>

          <!-- Results -->
          <div class="panel">
            <h3 class="panelTitle">–†–µ–∑—É–ª—å—Ç–∞—Ç</h3>

            <div class="sumGrid">
              <div class="sumBox managerOnly">
                <h4>–°–∫–ª–æ</h4>
                <div class="kv"><b>–†–æ–∑–º—ñ—Ä —Å–∫–ª–∞ (–º–º)</b><span id="outGlassSize">‚Äî</span></div>
                <div class="kv"><b>–ü–ª–æ—â–∞ raw 1 —à—Ç (–º¬≤)</b><span id="outGlassAreaRaw">‚Äî</span></div>
                <div class="kv"><b>–ü–ª–æ—â–∞ bill 1 —à—Ç (–º¬≤)</b><span id="outGlassAreaBill">‚Äî</span></div>
                <div class="kv"><b>–ü–ª–æ—â–∞ bill —Ä–∞–∑–æ–º (–º¬≤)</b><span id="outGlassAreaTotal">‚Äî</span></div>
              </div>

              <div class="sumBox managerOnly">
                <h4>–ü—Ä–æ—Ñ—ñ–ª—å</h4>
                <div class="kv"><b>–ü–µ—Ä–∏–º–µ—Ç—Ä —Ñ–∞—Å–∞–¥—É 1 —à—Ç (–º)</b><span id="outPerim">‚Äî</span></div>
                <div class="kv"><b>–ü–µ—Ä–∏–º–µ—Ç—Ä —Ä–∞–∑–æ–º (–º)</b><span id="outPerimTotal">‚Äî</span></div>
                <div class="kv"><b>–ü–∞–ª–æ–∫ 6100 (—à—Ç)</b><span id="outBars">‚Äî</span></div>
              </div>

              <div class="sumBox">
                <h4>–°—É–º–∏</h4>
                <div class="kv managerOnly" id="rowGlassUah"><b>–°–∫–ª–æ (–≥—Ä–Ω)</b><span id="outGlassUah">‚Äî</span></div>
                <div class="kv managerOnly" id="rowIksEur"><b>IKS (‚Ç¨)</b><span id="outIksEur">‚Äî</span></div>
                <div class="kv"><b>–†–∞–∑–æ–º (–≥—Ä–Ω)</b><span id="outTotalUah">‚Äî</span></div>
                <div class="kv"><b>–†–∞–∑–æ–º (~‚Ç¨)</b><span id="outTotalEur">‚Äî</span></div>
              </div>

              <div class="warn" id="warnBox" style="display:none;"></div>

              <div class="sumBox managerOnly">
                <h4>–†–æ–∑—à–∏—Ñ—Ä–æ–≤–∫–∞</h4>
                <div class="hint" style="margin-top:0;">–°–∫–ª–æ:</div>
                <pre id="outGlassBreakdown" style="margin:8px 0 0; white-space:pre-wrap; font-size:12px; color:inherit;"></pre>
                <div class="hint">IKS:</div>
                <pre id="outIksBreakdown" style="margin:8px 0 0; white-space:pre-wrap; font-size:12px; color:inherit;"></pre>
              </div>
              <div class="sumBox managerOnly" id="specBox">
                <h4>–°–ø–µ—Ü–∏—Ñ—ñ–∫–∞—Ü—ñ—è (–¥–ª—è —Ä–∞—Ö—É–Ω–∫—É)</h4>
                <div class="hint" style="margin-top:0;">–ü–æ–≤–Ω–∏–π —Å–ø–∏—Å–æ–∫ –ø–æ–∑–∏—Ü—ñ–π –∑–≥—ñ–¥–Ω–æ –ø—Ä–∞–π—Å—É: –∞—Ä—Ç–∏–∫—É–ª, –Ω–∞–∑–≤–∞, –∫—ñ–ª—å–∫—ñ—Å—Ç—å, —Ü—ñ–Ω–∞, —Å—É–º–∞.</div>

                <div style="overflow:auto; margin-top:10px;">
                  <table class="specTable" id="specTable" style="width:100%; border-collapse:collapse; min-width:720px;">
                    <thead>
                      <tr>
                        <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">–ê—Ä—Ç–∏–∫—É–ª</th>
                        <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞</th>
                        <th style="text-align:right; padding:10px 12px; border-bottom:1px solid var(--border);">–ö-—Å—Ç—å</th>
                        <th style="text-align:right; padding:10px 12px; border-bottom:1px solid var(--border);">–¶—ñ–Ω–∞</th>
                        <th style="text-align:right; padding:10px 12px; border-bottom:1px solid var(--border);">–°—É–º–∞</th>
                        <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border);">–í–∞–ª—é—Ç–∞</th>
                      </tr>
                    </thead>
                    <tbody id="specTableBody"></tbody>
                  </table>
                </div>

                <div class="rowActions" style="margin-top:12px;">
                  <button class="btn" id="copySpecBtn" type="button">üìã –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ (—Ç–∞–±–ª–∏—á–Ω–æ)</button>
                  <button class="btn" id="downloadCsvBtn2" type="button">üìé CSV (1–°)</button>
                </div>
                <div class="hint" id="specHint" style="margin-top:10px;">‚Äî</div>
              </div>


              <div class="sumBox managerOnly">
                <h4>–¢–µ–∫—Å—Ç –¥–ª—è Telegram</h4>
                <textarea id="telegramText" style="width:100%; min-height:160px; resize:vertical; border-radius:12px; padding:10px; border:1px solid rgba(148,163,184,0.40); background: rgba(255,255,255,0.88); font-size:12.5px;"></textarea>
                <div class="rowActions">
                  <button class="btn primary" id="sendTelegramBtn" type="button">üì® –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤ Telegram</button>
                  <button class="btn" id="copySummaryBtn" type="button">üìã –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏</button>
                  <button class="btn" id="downloadCsvBtn" type="button">üìé CSV (1–°)</button>
                </div>
                <div class="hint" id="telegramStatus"></div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </section>


    <!-- GALLERY -->
    <section class="card" id="gallery">
      <h2>–í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó —Ç–∞ –≤—É–∑–ª–∏ IKS</h2>
      <p class="lead">–û–¥–Ω–∞–∫–æ–≤–∏–π —Ä–æ–∑–º—ñ—Ä –ø—Ä–µ–≤‚Äô—é, –∞–∫—É—Ä–∞—Ç–Ω—ñ –≤—ñ–¥—Å—Ç—É–ø–∏, –∞–¥–∞–ø—Ç–∏–≤–Ω–∞ —Å—ñ—Ç–∫–∞.</p>

      <div class="mediaGrid">
        <article class="mediaCard">
          <div class="mediaThumb">
            <img src="images/iks/iks-hinge-red.jpg" alt="ONLY + IKS ‚Äî –∑–∞–≥–∞–ª—å–Ω–∏–π –≤–∏–≥–ª—è–¥" loading="lazy">
          </div>
          <div class="mediaBody">
            <h3 class="mediaTitle">ONLY + IKS (–ø—Ä–∏–∫–ª–∞–¥)</h3>
            <p class="mediaText">–ì–æ—Ç–æ–≤–µ —Ä—ñ—à–µ–Ω–Ω—è: –∫–∞—Ä–∫–∞—Å ONLY + –¥–≤–µ—Ä—ñ IKS.</p>
          </div>
        </article>

        <article class="mediaCard">
          <div class="mediaThumb">
            <img src="images/iks/iks-cabinet-open.jpg" alt="IKS ‚Äî —Ñ–∞—Å–∞–¥–∏ —É —à–∞—Ñ—ñ" loading="lazy">
          </div>
          <div class="mediaBody">
            <h3 class="mediaTitle">–§–∞—Å–∞–¥–∏ —É –º–æ–¥—É–ª—ñ</h3>
            <p class="mediaText">–ü—Ä–∏–∫–ª–∞–¥ –º–æ–¥—É–ª—è –∑ —Ä–æ–∑–ø–∞—à–Ω–∏–º –≤—ñ–¥–∫—Ä–∏–≤–∞–Ω–Ω—è–º.</p>
          </div>
        </article>

        <article class="mediaCard">
          <div class="mediaThumb contain">
            <img src="images/iks/iks-explode-door.jpg" alt="IKS ‚Äî –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü—ñ—è —Ñ–∞—Å–∞–¥—É (exploded view)" loading="lazy">
          </div>
          <div class="mediaBody">
            <h3 class="mediaTitle">–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü—ñ—è —Ñ–∞—Å–∞–¥—É</h3>
            <p class="mediaText">–ü—Ä–æ—Ñ—ñ–ª—ñ + –∫—É—Ç–æ—á–∫–∏ + —Å–∫–ª–æ (exploded view).</p>
          </div>
        </article>

        <article class="mediaCard">
          <div class="mediaThumb contain">
            <img src="images/iks/iks-hinge-close.jpg" alt="–ü–µ—Ç–ª—è IKS –∫—Ä—É–ø–Ω–∏–º –ø–ª–∞–Ω–æ–º" loading="lazy">
          </div>
          <div class="mediaBody">
            <h3 class="mediaTitle">–ü–µ—Ç–ª—è (–≤—É–∑–æ–ª)</h3>
            <p class="mediaText">–ü–æ—Å–∞–¥–∫–∞ –Ω–∞ –ø—Ä–æ—Ñ—ñ–ª—å, –∫—Ä—ñ–ø–ª–µ–Ω–Ω—è, –≥–µ–æ–º–µ—Ç—Ä—ñ—è.</p>
          </div>
        </article>

        <article class="mediaCard">
          <div class="mediaThumb contain">
            <img src="images/iks/iks-only-hero.jpg" alt="–†–µ–≥—É–ª—é–≤–∞–Ω–Ω—è –ø–µ—Ç–ª—ñ IKS" loading="lazy">
          </div>
          <div class="mediaBody">
            <h3 class="mediaTitle">–†–µ–≥—É–ª—é–≤–∞–Ω–Ω—è</h3>
            <p class="mediaText">–ü—ñ–¥—Å—Ç—Ä–æ—é–≤–∞–Ω–Ω—è —Ñ–∞—Å–∞–¥—É (–≤–∏—Å–æ—Ç–∞/—à–∏—Ä–∏–Ω–∞/–≥–ª–∏–±–∏–Ω–∞).</p>
          </div>
        </article>

        <article class="mediaCard">
          <div class="mediaThumb contain">
            <img src="images/iks/iks-hinge-on-wood.jpg" alt="–ú–æ–Ω—Ç–∞–∂ —É –∫—É—Ç—ñ" loading="lazy">
          </div>
          <div class="mediaBody">
            <h3 class="mediaTitle">–ú–æ–Ω—Ç–∞–∂ —É –∫—É—Ç—ñ</h3>
            <p class="mediaText">–í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è —Ä–æ–∑–º—ñ—â–µ–Ω–Ω—è –º–µ—Ö–∞–Ω—ñ–∑–º—É.</p>
          </div>
        </article>

      </div>

      <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;">
        <a class="btn" href="#top" onclick="window.scrollTo({top:0,behavior:'smooth'}); return false;">‚¨ÜÔ∏è –í–≥–æ—Ä—É</a>
        <a class="btn primary" href="lait-lite.html">–ü–µ—Ä–µ–π—Ç–∏ –¥–æ LAIT</a>
        <a class="btn" href="only.html">–ü–µ—Ä–µ–π—Ç–∏ –¥–æ ONLY</a>
      </div>
    </section>

    <footer>
      ¬© MT Hub ¬∑ IKS / ONLY / LAIT
    </footer>
  </div>

  
  
  <script>
    // ===== Theme =====
    (function initTheme(){
      const root = document.documentElement;
      const btn  = document.getElementById('themeToggle');
      const label = document.getElementById('themeLabel');

      function apply(mode){
        if(mode === 'dark'){
          root.classList.add('dark-theme');
          label.textContent = '–°–≤—ñ—Ç–ª–∞ —Ç–µ–º–∞';
        } else {
          root.classList.remove('dark-theme');
          label.textContent = '–¢–µ–º–Ω–∞ —Ç–µ–º–∞';
        }
        localStorage.setItem('mtHubTheme', mode);
      }

      const saved = localStorage.getItem('mtHubTheme');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      apply(saved ? saved : (prefersDark ? 'dark' : 'light'));

      btn.addEventListener('click', function(){
        const isDark = root.classList.contains('dark-theme');
        apply(isDark ? 'light' : 'dark');
      });
    })();

    // ========= Data (embedded) =========
    const GLASS_MASTER = {"meta": {"name": "ONLY master glass catalog (Busel + AbstractGlass)", "version": "only.glass.master.v1", "generated_at": "2025-12-15T19:45:20", "timezone": "Europe/Kyiv", "notes": ["This file merges supplier catalogs for ONLY and adds default supplier and auto-selection rules.", "All prices are UAH; material prices are per m¬≤; services have their own units.", "Commercial multipliers are included as references; apply in your ONLY pricing pipeline as needed."]}, "suppliers": [{"id": "BUSEL", "name": "Busel"}, {"id": "ABSTRACT", "name": "AbstractGlass"}], "catalogs": {"BUSEL": {"glass_items": [{"id": "BUSEL_FLOAT_CLEAR_4_RIZKA", "supplier": "BUSEL", "origin": "non-china", "thickness_mm": 4, "type": "Float Clear", "label": "–°–∫–ª–æ —Ñ–ª–æ–∞—Ç –ø—Ä–æ–∑–æ—Ä–µ 4 –º–º (#–†—ñ–∑–∫–∞#)", "sell_type": "M2", "unit": "–º¬≤", "pricePerM2_uah": 507.9, "tempering_group": "FLOAT"}, {"id": "BUSEL_ULTRACLEAR_4_RIZKA", "supplier": "BUSEL", "origin": "non-china", "thickness_mm": 4, "type": "Ultra Clear", "label": "–°–∫–ª–æ –Ω–∞–¥–ø—Ä–æ–∑–æ—Ä–µ (Ultra Clear) 4 –º–º (#–†—ñ–∑–∫–∞#)", "sell_type": "M2", "unit": "–º¬≤", "pricePerM2_uah": 879.3, "tempering_group": "ULTRACLEAR_TINTED"}, {"id": "BUSEL_CHINA_DARKGREY_4_RIZKA", "supplier": "BUSEL", "origin": "china", "thickness_mm": 4, "type": "Dark Grey", "label": "CHINA GLASS Dark Grey 4 –º–º (#–†—ñ–∑–∫–∞#)", "sell_type": "M2", "unit": "–º¬≤", "pricePerM2_uah": 996.42, "tempering_group": "ULTRACLEAR_TINTED"}, {"id": "BUSEL_PLANIBEL_BRONZE_GREY_4_RIZKA", "supplier": "BUSEL", "origin": "non-china", "thickness_mm": 4, "type": "Bronze/Grey", "label": "PLANIBEL Bronze/Grey 4 –º–º (#–†—ñ–∑–∫–∞#)", "sell_type": "M2", "unit": "–º¬≤", "pricePerM2_uah": 1060.68, "tempering_group": "ULTRACLEAR_TINTED"}, {"id": "BUSEL_CHINA_FLOAT_CLEAR_6_RIZKA", "supplier": "BUSEL", "origin": "china", "thickness_mm": 6, "type": "Float Clear", "label": "CHINA GLASS Float 6 –º–º (#–†—ñ–∑–∫–∞#)", "sell_type": "M2", "unit": "–º¬≤", "pricePerM2_uah": 749.4, "tempering_group": "FLOAT"}, {"id": "BUSEL_ULTRACLEAR_6_RIZKA", "supplier": "BUSEL", "origin": "non-china", "thickness_mm": 6, "type": "Ultra Clear", "label": "–°–∫–ª–æ –Ω–∞–¥–ø—Ä–æ–∑–æ—Ä–µ (Ultra Clear) 6 –º–º (#–†—ñ–∑–∫–∞#)", "sell_type": "M2", "unit": "–º¬≤", "pricePerM2_uah": 1403.4, "tempering_group": "ULTRACLEAR_TINTED"}, {"id": "BUSEL_CHINA_DARKGREY_6_RIZKA", "supplier": "BUSEL", "origin": "china", "thickness_mm": 6, "type": "Dark Grey", "label": "CHINA GLASS Dark Grey 6 –º–º (#–†—ñ–∑–∫–∞#)", "sell_type": "M2", "unit": "–º¬≤", "pricePerM2_uah": 1976.4, "tempering_group": "ULTRACLEAR_TINTED"}, {"id": "BUSEL_CHINA_BRONZE_6_RIZKA", "supplier": "BUSEL", "origin": "china", "thickness_mm": 6, "type": "Bronze", "label": "CHINA GLASS Bronze 6 –º–º (#–†—ñ–∑–∫–∞#)", "sell_type": "M2", "unit": "–º¬≤", "pricePerM2_uah": 986.1, "tempering_group": "ULTRACLEAR_TINTED"}], "services": {"tempering": {"id": "BUSEL_TEMPERING", "label": "–ó–∞–≥–∞—Ä—Ç—É–≤–∞–Ω–Ω—è (Busel)", "unit": "–º¬≤", "sell_type": "M2", "base_pricePerM2_uah": {"FLOAT": 217.68, "ULTRACLEAR_TINTED": 282.96, "PYROLYTIC_COATED": 326.46}, "batch_coefficients": [{"range_m2": [0.0, 0.25], "multiplier": 2.0, "note": "If you enforce min billable area as per Busel rules for tiny parts."}, {"range_m2": [0.25, 2.0], "multiplier": 1.5, "note": "Batch 0.25‚Äì2 m¬≤ (+50%)."}, {"range_m2": [2.0, 10.0], "multiplier": 1.3, "note": "Batch 2‚Äì10 m¬≤ (+30%)."}]}, "edge_polish": {"id": "BUSEL_EDGE_POLISH", "label": "–ü–æ–ª—ñ—Ä—É–≤–∞–Ω–Ω—è –∫—Ä–æ–º–∫–∏ (Busel)", "unit": "–ø.–º.", "sell_type": "LM", "pricePerLm_uah": {"THK_4": 70.62, "THK_3_5_6": 99.66}, "notes": ["THK_4 for 4 mm.", "THK_3_5_6 for 5‚Äì6 mm."]}}, "commercial_rules": {"busel_discount_multiplier": 0.85, "busel_markup_multiplier": 1.3, "busel_total_multiplier": 1.105, "abstract_markup_multiplier_reference": 1.15}}, "ABSTRACT": {"glass_items": [{"id": "ABS_FLOAT_4", "supplier": "ABSTRACT", "origin": "china", "thickness_mm": 4, "type": "Float Clear", "label": "–°–∫–ª–æ –∑–≤–∏—á–∞–π–Ω–µ (Float) 4 –º–º", "sell_type": "M2", "unit": "–º¬≤", "pricePerM2_uah": 690, "tempering_group": "ALL"}, {"id": "ABS_DIAMOND_4", "supplier": "ABSTRACT", "origin": "china", "thickness_mm": 4, "type": "Diamond / Extra Clear", "label": "–°–∫–ª–æ –î—ñ–∞–º–∞–Ω—Ç (Extra Clear) 4 –º–º", "sell_type": "M2", "unit": "–º¬≤", "pricePerM2_uah": 980, "tempering_group": "ALL"}, {"id": "ABS_GRAPHITE_4", "supplier": "ABSTRACT", "origin": "china", "thickness_mm": 4, "type": "Graphite", "label": "–°–∫–ª–æ –ì—Ä–∞—Ñ—ñ—Ç 4 –º–º", "sell_type": "M2", "unit": "–º¬≤", "pricePerM2_uah": 1180, "tempering_group": "ALL"}, {"id": "ABS_BRONZE_4", "supplier": "ABSTRACT", "origin": "china", "thickness_mm": 4, "type": "Bronze", "label": "–°–∫–ª–æ –ë—Ä–æ–Ω–∑–∞ 4 –º–º", "sell_type": "M2", "unit": "–º¬≤", "pricePerM2_uah": 1180, "tempering_group": "ALL"}, {"id": "ABS_FLOAT_5", "supplier": "ABSTRACT", "origin": "china", "thickness_mm": 5, "type": "Float Clear", "label": "–°–∫–ª–æ –∑–≤–∏—á–∞–π–Ω–µ (Float) 5 –º–º", "sell_type": "M2", "unit": "–º¬≤", "pricePerM2_uah": 890, "tempering_group": "ALL"}, {"id": "ABS_DIAMOND_5", "supplier": "ABSTRACT", "origin": "china", "thickness_mm": 5, "type": "Diamond / Extra Clear", "label": "–°–∫–ª–æ –î—ñ–∞–º–∞–Ω—Ç (Extra Clear) 5 –º–º", "sell_type": "M2", "unit": "–º¬≤", "pricePerM2_uah": 1285, "tempering_group": "ALL"}, {"id": "ABS_GRAPHITE_5", "supplier": "ABSTRACT", "origin": "china", "thickness_mm": 5, "type": "Graphite", "label": "–°–∫–ª–æ –ì—Ä–∞—Ñ—ñ—Ç 5 –º–º", "sell_type": "M2", "unit": "–º¬≤", "pricePerM2_uah": 1500, "tempering_group": "ALL"}, {"id": "ABS_BRONZE_5", "supplier": "ABSTRACT", "origin": "china", "thickness_mm": 5, "type": "Bronze", "label": "–°–∫–ª–æ –ë—Ä–æ–Ω–∑–∞ 5 –º–º", "sell_type": "M2", "unit": "–º¬≤", "pricePerM2_uah": 1500, "tempering_group": "ALL"}, {"id": "ABS_FLOAT_6", "supplier": "ABSTRACT", "origin": "china", "thickness_mm": 6, "type": "Float Clear", "label": "–°–∫–ª–æ –∑–≤–∏—á–∞–π–Ω–µ (Float) 6 –º–º", "sell_type": "M2", "unit": "–º¬≤", "pricePerM2_uah": 1100, "tempering_group": "ALL"}, {"id": "ABS_DIAMOND_6", "supplier": "ABSTRACT", "origin": "china", "thickness_mm": 6, "type": "Diamond / Extra Clear", "label": "–°–∫–ª–æ –î—ñ–∞–º–∞–Ω—Ç (Extra Clear) 6 –º–º", "sell_type": "M2", "unit": "–º¬≤", "pricePerM2_uah": 1590, "tempering_group": "ALL"}, {"id": "ABS_GRAPHITE_6", "supplier": "ABSTRACT", "origin": "china", "thickness_mm": 6, "type": "Graphite", "label": "–°–∫–ª–æ –ì—Ä–∞—Ñ—ñ—Ç 6 –º–º", "sell_type": "M2", "unit": "–º¬≤", "pricePerM2_uah": 1795, "tempering_group": "ALL"}, {"id": "ABS_BRONZE_6", "supplier": "ABSTRACT", "origin": "china", "thickness_mm": 6, "type": "Bronze", "label": "–°–∫–ª–æ –ë—Ä–æ–Ω–∑–∞ 6 –º–º", "sell_type": "M2", "unit": "–º¬≤", "pricePerM2_uah": 1795, "tempering_group": "ALL"}], "services": {"tempering": {"id": "ABS_TEMPERING", "label": "–ó–∞–≥–∞—Ä—Ç—É–≤–∞–Ω–Ω—è (AbstractGlass)", "unit": "–º¬≤", "sell_type": "M2", "pricePerM2_uah": {"THK_4": 265, "THK_5": 275, "THK_6": 290}}, "edge_polish": {"id": "ABS_EDGE_POLISH", "label": "–ü–æ–ª—ñ—Ä—É–≤–∞–Ω–Ω—è –∫—Ä–æ–º–∫–∏ (AbstractGlass)", "unit": "–ø.–º.", "sell_type": "LM", "pricePerLm_uah": {"THK_3_4_5": 55, "THK_6": 65}}, "adhesion_prep": {"id": "ABS_ART_PAINT", "label": "–•—É–¥. —Ñ–∞—Ä–±—É–≤–∞–Ω–Ω—è / –ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø—ñ–¥ –ø—Ä–æ—Ñ—ñ–ª—å (1 –∫–æ–ª—ñ—Ä)", "unit": "–º¬≤", "sell_type": "M2", "pricePerM2_uah": 485, "notes": ["–¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—á–Ω–∞ –ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–æ–≤–µ—Ä—Ö–Ω—ñ —Å–∫–ª–∞ –ø—ñ–¥ –ø—Ä–∏–∫–ª–µ–π–∫—É –ø—Ä–æ—Ñ—ñ–ª—é", "–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –∞–¥–≥–µ–∑—ñ—ó"]}}, "commercial_rules": {"abstract_markup_multiplier": 1.15}}}, "defaults": {"default_supplier": "ABSTRACT", "default_policy": {"kitchen_upper": "ABSTRACT", "wardrobe_large": "BUSEL"}, "assumptions": {"edge_polish_always_on": true, "tempering_for_large_wardrobe": true}}, "selector_rules": {"description": "Rule-based supplier selector for glass in ONLY", "rules_ordered": [{"id": "R1_CHINA_6MM_PREFERRED_BUSEL", "when": {"thickness_mm_in": [6], "origin_preference": "china", "glass_type_in": ["Float Clear", "Bronze", "Dark Grey"]}, "pick_supplier": "BUSEL", "reason": "China 6 mm is typically cheaper and present as explicit CHINA GLASS in Busel price lists."}, {"id": "R2_4_5MM_DEFAULT_ABSTRACT", "when": {"thickness_mm_in": [4, 5]}, "pick_supplier": "ABSTRACT", "reason": "Default mass supplier for 4‚Äì5 mm."}, {"id": "R3_ULTRACLEAR_PREMIUM_BUSEL_OPTION", "when": {"glass_type_in": ["Ultra Clear", "Diamond / Extra Clear", "–°–∫–ª–æ –Ω–∞–¥–ø—Ä–æ–∑–æ—Ä–µ (Ultra Clear) 4 –º–º (#–†—ñ–∑–∫–∞#)", "–°–∫–ª–æ –Ω–∞–¥–ø—Ä–æ–∑–æ—Ä–µ (Ultra Clear) 6 –º–º (#–†—ñ–∑–∫–∞#)"], "premium_client": true}, "pick_supplier": "BUSEL", "reason": "Premium client path may prefer Busel ultraclear control and assortment."}, {"id": "R4_FALLBACK_DEFAULT", "when": {}, "pick_supplier": "ABSTRACT", "reason": "Fallback to default supplier."}], "service_policy": {"edge_polish": {"enabled": true, "default": {"BUSEL": "BUSEL_EDGE_POLISH", "ABSTRACT": "ABS_EDGE_POLISH"}}, "tempering": {"enabled": "conditional", "default": {"BUSEL": "BUSEL_TEMPERING", "ABSTRACT": "ABS_TEMPERING"}, "enable_when": {"is_wardrobe_large": true}}, "adhesion_prep": {"enabled": "conditional", "supplier": "ABSTRACT", "service_id": "ABS_ART_PAINT", "enable_when": {"needs_profile_adhesion_prep": true}}}}};
    const IKS_PRICE_EUR = {"IKS": {"barLenMm": 6100, "IS_954_bar": {"id": "trIS-954-NS", "label": "–ü—Ä–æ—Ñ—ñ–ª—å IKS (IS-954) L=6100", "priceEur": 188.16}, "IS_955_bar": {"id": "trIS-955-NS", "label": "–ü—Ä–æ—Ñ—ñ–ª—å IKS (IS-955) L=6100", "priceEur": 194.54}, "HANDLE_200": {"id": "trIS-986-200-NS", "label": "–†—É—á–∫–∞ IKS L=200", "priceEur": 22.55}, "CORNER_DX": {"id": "trIS-G-DX", "label": "–ö—É—Ç–æ—á–æ–∫ IKS (–ø—Ä–∞–≤–∏–π)", "priceEur": 7.45}, "CORNER_SX": {"id": "trIS-G-SX", "label": "–ö—É—Ç–æ—á–æ–∫ IKS (–ª—ñ–≤–∏–π)", "priceEur": 7.45}, "GASKET": {"id": "trGU-BATTUTA-FUME", "label": "–£—â—ñ–ª—å–Ω—é–≤–∞—á –¥–≤–µ—Ä–µ–π IKS L=3000", "priceEur": 4.34}, "HINGE_SET": {"id": "trIS-CE33-180", "label": "–ü–µ—Ç–ª—è IKS-33 180¬∞ –∑ –¥–æ–≤–æ–¥—á–∏–∫–æ–º (–∫–æ–º–ø–ª)", "priceEur": 71.73}}, "IKS_MINI": {"barLenMm": 6100, "ISM_956_bar": {"id": "trISM-956-NS", "label": "–ü—Ä–æ—Ñ—ñ–ª—å IKS mini (ISM-956) L=6100", "priceEur": 105.0}, "ISM_955_bar": {"id": "trISM-955-NS", "label": "–ü—Ä–æ—Ñ—ñ–ª—å IKS mini (ISM-955) L=6100", "priceEur": 108.57}, "HANDLE_120": {"id": "trISM-986-NS", "label": "–†—É—á–∫–∞ IKS mini L=120", "priceEur": 16.42}, "CORNER_DX": {"id": "trISM-G-DX", "label": "–ö—É—Ç–æ—á–æ–∫ IKS mini (–ø—Ä–∞–≤–∏–π)", "priceEur": 3.4}, "CORNER_SX": {"id": "trISM-G-SX", "label": "–ö—É—Ç–æ—á–æ–∫ IKS mini (–ª—ñ–≤–∏–π)", "priceEur": 3.4}, "GASKET": {"id": "trA10.232-3000", "label": "–£—â—ñ–ª—å–Ω—é–≤–∞—á IKS mini L=3000", "priceEur": 8.86}, "HINGE_SET": {"id": "HH148.001.003", "label": "–ö–æ–º–ø–ª–µ–∫—Ç –ø–µ—Ç–µ–ª—å IKS mini –∑ –¥–æ–≤–æ–¥—á–∏–∫–æ–º", "priceEur": 37.87}}};

    // === IKS finish variants (from Trial_price.pdf 04.11.2025) ===
    // –Ø–∫—â–æ –¥–ª—è –≤–∏–±—Ä–∞–Ω–æ–≥–æ –∫–æ–ª—å–æ—Ä—É –Ω–µ–º–∞—î –ø–æ–∑–∏—Ü—ñ—ó ‚Äî —Ä–æ–±–∏–º–æ fallback –Ω–∞ NS —ñ –ø–æ–∫–∞–∑—É—î–º–æ warning.
    const IKS_FINISH_VARIANTS = {
      IKS: {
        IS_954_bar: {
          NS:  { id:"trIS-954-NS",     label:"–ü—Ä–æ—Ñ—ñ–ª—å IKS (IS-954) L=6100", priceEur:188.16 },
          BRA: { id:"trIS-954-BRA",    label:"–ü—Ä–æ—Ñ—ñ–ª—å IKS (IS-954) L=6100", priceEur:166.02 },
          BRC: { id:"trIS-954-BRC_—Å–≤", label:"–ü—Ä–æ—Ñ—ñ–ª—å IKS (IS-954) L=6100", priceEur:156.83 },
          DE:  null
        },
        IS_955_bar: {
          NS:  { id:"trIS-955-NS",     label:"–ü—Ä–æ—Ñ—ñ–ª—å IKS (IS-955) L=6100", priceEur:194.54 },
          BRA: { id:"trIS-955-BRA",    label:"–ü—Ä–æ—Ñ—ñ–ª—å IKS (IS-955) L=6100", priceEur:166.02 },
          BRC: { id:"trIS-955-BRC_—Å–≤", label:"–ü—Ä–æ—Ñ—ñ–ª—å IKS (IS-955) L=6100", priceEur:156.80 },
          DE:  { id:"trIS-955-DE",     label:"–ü—Ä–æ—Ñ—ñ–ª—å IKS (IS-955) L=6100", priceEur:120.74 }
        },
        HANDLE_200: {
          NS:  { id:"trIS-986-200-NS", label:"–†—É—á–∫–∞ IKS L=200", priceEur:22.55 },
          BRA: { id:"trIS-986-BRA",    label:"–†—É—á–∫–∞ IKS L=200", priceEur:22.55 },
          BRC: { id:"trIS-986-BRC",    label:"–†—É—á–∫–∞ IKS L=200", priceEur:22.55 },
          DE:  { id:"trIS-986-DE",     label:"–†—É—á–∫–∞ IKS L=200", priceEur:17.28 }
        }
      },
      IKS_MINI: {
        ISM_956_bar: {
          NS:  { id:"trISM-956-NS",     label:"–ü—Ä–æ—Ñ—ñ–ª—å IKS mini (ISM-956) L=6100", priceEur:105.00 },
          BRA: { id:"trISM-956-BRA",    label:"–ü—Ä–æ—Ñ—ñ–ª—å IKS mini (ISM-956) L=6100", priceEur:105.00 },
          BRC: { id:"trISM-956-BRC_—Å–≤", label:"–ü—Ä–æ—Ñ—ñ–ª—å IKS mini (ISM-956) L=6100", priceEur:105.00 },
          DE:  null
        },
        ISM_955_bar: {
          NS:  { id:"trISM-955-NS", label:"–ü—Ä–æ—Ñ—ñ–ª—å IKS mini (ISM-955) L=6100", priceEur:108.57 },
          BRA: null,
          BRC: null,
          DE:  null
        },
        HANDLE_120: {
          NS:  { id:"trISM-986-NS",  label:"–†—É—á–∫–∞ IKS mini L=120", priceEur:16.42 }, // fallback
          BRA: { id:"trISM-986-BRA", label:"–†—É—á–∫–∞ IKS mini L=120", priceEur:16.42 },
          BRC: { id:"trISM-986-BRC", label:"–†—É—á–∫–∞ IKS mini L=120", priceEur:16.42 },
          DE:  null
        }
      }
    };

    function pickFinishItem(systemType, key, finish){
      const base = IKS_PRICE_EUR[systemType] && IKS_PRICE_EUR[systemType][key];
      const map = IKS_FINISH_VARIANTS[systemType] && IKS_FINISH_VARIANTS[systemType][key];
      if(!map) return { item: base, warn: "" };

      const chosen = map[finish];
      if(chosen) return { item: chosen, warn: "" };

      // fallback to NS
      const fallback = map.NS || base;
      const warn = `‚ö†Ô∏è –î–ª—è ${key} –Ω–µ–º–∞—î —Ü—ñ–Ω–∏ –≤ –∫–æ–ª—å–æ—Ä—ñ ${finish}. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ NS.`;
      return { item: fallback, warn };
    }


    // ========= Busel engine (embedded) =========
    (function (root, factory) {
  if (typeof module === "object" && typeof module.exports === "object") {
    module.exports = factory();
  } else {
    root.GlassEngine = factory();
  }
})(typeof self !== "undefined" ? self : this, function () {
  "use strict";

// =========================
// MT Busel v3 defaults (global config)
// =========================
// You can override per-call by passing fields into calcBuselV3Piece(p),
// or globally via GlassEngine.setBuselConfig({...}).
let BUSEL_CFG = {
  // Business rule: MT glass is tempered by default
  tempered: true,

  // Billing area minimum per piece (m¬≤)
  minAreaM2: 0.25,

  // Temper minimums (UAH) per ONE glass type/thickness in the order
  temperMinFloatUAH: 750,
  temperMinOtherUAH: 999,

  // MT pricing modifiers
  mtDiscount: 0.85, // -15%
  mtMarkup: 1.30,   // +30%

  // Optional size surcharge application
  applySizeSurcharge: false
};

function setBuselConfig(patch) {
  if (!patch || typeof patch !== "object") return BUSEL_CFG;
  BUSEL_CFG = { ...BUSEL_CFG, ...patch };
  return BUSEL_CFG;
}


  // -------------------------
  // utils
  // -------------------------
  function clamp0(x) {
    x = Number(x);
    return Number.isFinite(x) ? Math.max(0, x) : 0;
  }

  function mm2_to_m2(wMm, hMm) {
    return (clamp0(wMm) * clamp0(hMm)) / 1_000_000;
  }

  function perimeter_m(wMm, hMm) {
    return (2 * (clamp0(wMm) + clamp0(hMm))) / 1000;
  }

  function round2(x) {
    return Math.round((Number(x) + Number.EPSILON) * 100) / 100;
  }

  // -------------------------
  // Busel coefficients
  // -------------------------
  function areaCoef(billingAreaM2) {
    const a = clamp0(billingAreaM2);
    if (a >= 7.5) return 2.0;
    if (a >= 6.5) return 1.5;
    if (a >= 5.5) return 1.3;
    if (a >= 4.5) return 1.2;
    if (a >= 3.5) return 1.1;
    return 1.0;
  }

  /**
   * Batch coefficient for tempering party.
   * (Keep same logic as Volpato calculator. Adjust later if you confirm exact table.)
   */
  function batchCoefTempered(totalAreaM2) {
    const a = clamp0(totalAreaM2);
    if (a < 0.25) return 2.0;
    if (a < 2.0) return 1.5;
    if (a < 10.0) return 1.3;
    if (a < 50.0) return 1.1;
    if (a <= 100.0) return 1.05;
    return 1.0;
  }

  /**
   * Size surcharge for pre-processing (optional, based on one side length).
   * If you don't need it now ‚Äî keep enabled=false in options.
   */
  function sizeSurchargeCoef(p) {
    const wMm = clamp0(p && p.wMm);
    const hMm = clamp0(p && p.hMm);
    const maxSide = Math.max(wMm, hMm);
    if (maxSide >= 3200) return 1.50;
    if (maxSide >= 2800) return 1.35;
    if (maxSide >= 2200) return 1.20;
    return 1.00;
  }

  // -------------------------
  // Core pricing
  // -------------------------

  /**
   * Calculate Busel-based glass cost for given piece geometry.
   *
   * @param {object} p
   * @param {number} p.widthMm
   * @param {number} p.heightMm
   * @param {number} p.qty
   * @param {number} p.materialPricePerM2UAH     - Busel base material price, UAH/m¬≤
   * @param {number} p.edgePolishPerMUAH         - polishing price, UAH/m (can be 0)
   * @param {boolean} [p.tempered=true]          - we treat ALL glass as tempered in MT projects
   * @param {number} [p.temperTariffPerM2UAH=0]  - Busel tempering tariff, UAH/m¬≤ for this glass type/thickness
   * @param {"float"|"other"} [p.temperMinType="other"] - which min order to use
   * @param {number} [p.temperMinFloatUAH=750]
   * @param {number} [p.temperMinOtherUAH=999]
   * @param {boolean} [p.applySizeSurcharge=false]
   * @returns {object} breakdown
   */
  function calcBuselV3Piece(p) {
    const widthMm = clamp0(p && p.widthMm);
    const heightMm = clamp0(p && p.heightMm);
    const qty = Math.max(1, Math.floor(clamp0((p && p.qty) || 1)));

    const materialPricePerM2UAH = clamp0(p && p.materialPricePerM2UAH);
    const edgePolishPerMUAH = clamp0(p && p.edgePolishPerMUAH);

    const rawArea = mm2_to_m2(widthMm, heightMm);
    const billingArea = Math.max(rawArea, (BUSEL_CFG && BUSEL_CFG.minAreaM2) ? BUSEL_CFG.minAreaM2 : 0.25);

    const kArea = areaCoef(billingArea);

    // material + polish (Busel base)
    const materialUAH = billingArea * materialPricePerM2UAH;
    const edgeLenM = perimeter_m(widthMm, heightMm);
    const polishUAH = edgeLenM * edgePolishPerMUAH;

    // optional size surcharge (for pre-processing). Apply to (material+polish) only (safe default).
    const kSize = ((p && typeof p.applySizeSurcharge === "boolean") ? p.applySizeSurcharge : (BUSEL_CFG ? !!BUSEL_CFG.applySizeSurcharge : false))
      ? sizeSurchargeCoef({ wMm: widthMm, hMm: heightMm }) : 1.0;
    const buselBaseUAH = (materialUAH + polishUAH) * kSize;

    // tempering
    const tempered = (p && p.tempered === false) ? false : ((p && typeof p.tempered === "boolean") ? p.tempered : (BUSEL_CFG ? !!BUSEL_CFG.tempered : true));
    const temperTariffPerM2UAH = clamp0((p && p.temperTariffPerM2UAH) || 0);

    let temperTotalUAH = 0;
    let kBatch = 1.0;
    let temperMinUAH = 0;

    if (tempered && temperTariffPerM2UAH > 0) {
      const partyArea = billingArea * qty;
      kBatch = batchCoefTempered(partyArea);

      temperTotalUAH = temperTariffPerM2UAH * billingArea * kArea * qty * kBatch;

      const minFloat = clamp0((p && p.temperMinFloatUAH) != null ? p.temperMinFloatUAH : (BUSEL_CFG && BUSEL_CFG.temperMinFloatUAH != null ? BUSEL_CFG.temperMinFloatUAH : 750));
      const minOther = clamp0((p && p.temperMinOtherUAH) != null ? p.temperMinOtherUAH : (BUSEL_CFG && BUSEL_CFG.temperMinOtherUAH != null ? BUSEL_CFG.temperMinOtherUAH : 999));
      temperMinUAH = ((p && p.temperMinType) === "float") ? minFloat : minOther;

      if (temperTotalUAH < temperMinUAH) temperTotalUAH = temperMinUAH;
    }

    const buselNetUAH = buselBaseUAH + temperTotalUAH;

    // MT pricing: -15% then +30%
    const mtNetUAH = buselNetUAH * (BUSEL_CFG && BUSEL_CFG.mtDiscount ? BUSEL_CFG.mtDiscount : 0.85);
    const mtRetailUAH = mtNetUAH * (BUSEL_CFG && BUSEL_CFG.mtMarkup ? BUSEL_CFG.mtMarkup : 1.30);

    // per-piece for UI/debug
    const mtRetailPerPieceUAH = mtRetailUAH / qty;

    return {
      widthMm: widthMm,
      heightMm: heightMm,
      qty: qty,
      rawArea: rawArea,
      billingArea: billingArea,
      edgeLenM: edgeLenM,
      kArea: kArea,
      kBatch: kBatch,
      kSize: kSize,
      materialUAH: materialUAH,
      polishUAH: polishUAH,
      temperTariffPerM2UAH: temperTariffPerM2UAH,
      temperMinUAH: temperMinUAH,
      temperTotalUAH: temperTotalUAH,
      buselNetUAH: buselNetUAH,
      mtRetailUAH: mtRetailUAH,
      mtRetailPerPieceUAH: mtRetailPerPieceUAH
    };
  }

  // -------------------------
  // ONLY sizing helpers
  // -------------------------

  /**
   * ONLY side glass (4 mm) per section:
   *   Hglass = Hmont
   *   Lglass = D - 3.5
   */
  function onlySideGlass4mm(p) {
    const H = clamp0(p && p.HmontMm);
    const D = clamp0(p && p.depthMm);
    const sections = Math.max(1, Math.floor(clamp0((p && p.sectionsCount) || 1)));

    const sideMode = (p && p.sideMode) || "none";
    const sidesCount =
      (sideMode === "both") ? 2 :
      (sideMode === "left" || sideMode === "right") ? 1 : 0;

    const wMm = Math.max(0, D - 3.5);
    const hMm = H;

    const oneArea = mm2_to_m2(wMm, hMm);
    const totalPieces = sections * sidesCount;
    const totalArea = oneArea * totalPieces;

    return {
      thicknessMm: 4,
      perPiece: { wMm: wMm, hMm: hMm, areaM2: oneArea },
      total: { pieces: totalPieces, areaM2: totalArea },
      text: "–ë–æ–∫–æ–≤–µ —Å–∫–ª–æ 4 –º–º: " + sections + "√ó" + sidesCount +
        "√ó(" + wMm + "√ó" + hMm + " –º–º) = " + round2(totalArea) + " –º¬≤"
    };
  }

  /**
   * ONLY back panel per section:
   *  glass 6mm:  Wback = Lvano + 11; Hback = Hmont - 38
   *  board 8mm:  Wback = Lvano + 16; Hback = Hmont - 38
   *
   * Lvano is the clear section width (span).
   */
  function onlyBackPanel(p) {
    const Lvano = clamp0(p && p.spanMm);
    const Hmont = clamp0(p && p.HmontMm);

    const material = (p && p.material) || "";
    const isGlass6 = (material === "glass6");
    const isBoard8 = (material === "board8");

    if (!isGlass6 && !isBoard8) return null;

    const addW = isGlass6 ? 11 : 16;
    const wMm = Math.max(0, Lvano + addW);
    const hMm = Math.max(0, Hmont - 38);
    const tMm = isGlass6 ? 6 : 8;

    const area = mm2_to_m2(wMm, hMm);

    return {
      thicknessMm: tMm,
      perPiece: { wMm: wMm, hMm: hMm, areaM2: area },
      text: (isGlass6 ? "–°–ø–∏–Ω–∫–∞ —Å–∫–ª–æ 6 –º–º" : "–°–ø–∏–Ω–∫–∞ –î–°–ü/–ú–î–§ 8 –º–º") +
        ": 1√ó(" + wMm + "√ó" + hMm + " –º–º) = " + round2(area) + " –º¬≤"
    };
  }

  // -------------------------
  // Public API
  // -------------------------
  return {
    calcBuselV3Piece: calcBuselV3Piece,
    areaCoef: areaCoef,
    batchCoefTempered: batchCoefTempered,
    sizeSurchargeCoef: sizeSurchargeCoef,
    onlySideGlass4mm: onlySideGlass4mm,
    onlyBackPanel: onlyBackPanel,
    mm2_to_m2: mm2_to_m2,
    perimeter_m: perimeter_m,
    BUSEL_CFG: BUSEL_CFG,
    setBuselConfig: setBuselConfig
  };
});

    // ========= –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏ —Ä–µ–∂–∏–º—É / Telegram =========
    const MANAGER_PASSWORD = "603";
    const TELEGRAM_ENDPOINT = "https://mt-volpato.vercel.app/api/telegram";
    const TELEGRAM_FORM_SECRET = "mtx-volpato-2025";

    let currentMode = "client"; // client | manager
    let last = null;

    const $ = (id)=>document.getElementById(id);

    function fmt(n, d=2){
      if(!isFinite(n)) return "‚Äî";
      return Number(n).toFixed(d);
    }
    function fmtUAH(n){
      if(!isFinite(n)) return "‚Äî";
      return new Intl.NumberFormat("uk-UA",{maximumFractionDigits:2}).format(Number(n));
    }
    function fmtEUR(n){
      if(!isFinite(n)) return "‚Äî";
      return new Intl.NumberFormat("uk-UA",{maximumFractionDigits:2}).format(Number(n));
    }

    function setWarn(msg){
      const box = $('warnBox');
      if(!msg){ box.style.display="none"; box.textContent=""; }
      else{ box.style.display="block"; box.textContent=msg; }
    }

    function setMode(mode){
      currentMode = mode;
      $('modeLabel').textContent = mode === "manager" ? "–º–µ–Ω–µ–¥–∂–µ—Ä" : "–∫–ª—ñ—î–Ω—Ç";

      // –ü–æ–∫–∞–∑/–ø—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è –º–µ–Ω–µ–¥–∂–µ—Ä—Å—å–∫–∏—Ö –±–ª–æ–∫—ñ–≤ (—Å–ø–µ—Ü–∏—Ñ—ñ–∫–∞—Ü—ñ—è, Telegram, –¥–µ—Ç–∞–ª—ñ)
      const showManager = (mode === "manager");
      $('managerBlock').style.display = showManager ? "block" : "none";

      // –î–æ–¥–∞—Ç–∫–æ–≤–æ: –≤—Å–µ, —â–æ –ø–æ–∑–Ω–∞—á–µ–Ω–æ —è–∫ managerOnly, —Ö–æ–≤–∞—î–º–æ –≤ —Ä–µ–∂–∏–º—ñ –∫–ª—ñ—î–Ω—Ç–∞
      document.querySelectorAll('.managerOnly').forEach(el=>{
        el.style.display = showManager ? "" : "none";
      });

      // –£ —Ä–µ–∂–∏–º—ñ –∫–ª—ñ—î–Ω—Ç–∞ –∑–∞–ª–∏—à–∞—î–º–æ –ª–∏—à–µ –ø—ñ–¥—Å—É–º–æ–∫ (–±–µ–∑ —Ä–æ–∑—à–∏—Ñ—Ä–æ–≤–æ–∫)
      if(!showManager){
        $('outGlassBreakdown').textContent = "";
        $('outIksBreakdown').textContent = "";
      }
    }

    function getCatalog(supplier){
      return (GLASS_MASTER && GLASS_MASTER.catalogs && GLASS_MASTER.catalogs[supplier]) ? GLASS_MASTER.catalogs[supplier] : null;
    }

    function populateGlassList(){
      const supplier = $('supplier').value;
      const cat = getCatalog(supplier);
      const sel = $('glassItem');
      sel.innerHTML = "";
      if(!cat) return;

      const items = (cat.glass_items || []).slice().sort((a,b)=> (a.thickness_mm - b.thickness_mm) || String(a.label).localeCompare(String(b.label)));
      for(const it of items){
        const opt = document.createElement('option');
        opt.value = it.id;
        opt.textContent = `${it.label} ‚Äî ${it.pricePerM2_uah} –≥—Ä–Ω/–º¬≤`;
        sel.appendChild(opt);
      }
      sel.selectedIndex = 0;
    }

    function getGlassItem(supplier, id){
      const cat = getCatalog(supplier);
      return (cat && cat.glass_items) ? cat.glass_items.find(x=>x.id===id) : null;
    }

    function mm2_to_m2(wMm,hMm){ return (Number(wMm)*Number(hMm))/1_000_000; }
    function perimeter_m(wMm,hMm){ return (2*(Number(wMm)+Number(hMm)))/1000; }

    // ===== Tolerances (from TRIAL catalog rules) =====
    function glassSizeByTolerance(systemType, profileType, doorW, doorH){
      let sub = 0;
      let text = "";
      if(systemType === "IKS"){
        if(profileType === "IS954"){ sub = 5.5; text = "IKS / IS-954: —Å–∫–ª–æ = —Ñ–∞—Å–∞–¥ ‚àí 5,5 –º–º (–ø–æ W —ñ H)"; }
        else { sub = 10; text = "IKS / IS-955: —Å–∫–ª–æ = —Ñ–∞—Å–∞–¥ ‚àí 10 –º–º (–ø–æ W —ñ H)"; }
      } else {
        if(profileType === "ISM956"){ sub = 4; text = "IKS mini / ISM-956: —Å–∫–ª–æ = —Ñ–∞—Å–∞–¥ ‚àí 4 –º–º (–ø–æ W —ñ H)"; }
        else { sub = 40; text = "IKS mini / ISM-955: —Å–∫–ª–æ = —Ñ–∞—Å–∞–¥ ‚àí 40 –º–º (–ø–æ W —ñ H)"; }
      }
      const glassW = Math.max(1, Math.round((doorW - sub) * 10) / 10);
      const glassH = Math.max(1, Math.round((doorH - sub) * 10) / 10);
      return { glassW, glassH, sub, ruleText: text };
    }

    // ===== Hinges UI sync (safe fallback) =====
    // In earlier versions hinge UI could depend on system/finish/angle.
    // If hinge controls are not present in the layout, this function safely no-ops.
    function syncHingeUI(){
      const wrap = document.getElementById('hingeWrap');
      const sel  = document.getElementById('hingeType');
      if(!wrap || !sel) return;
      // For now: always keep visible and enabled (MT default: hinges with closer).
      wrap.style.display = '';
      sel.disabled = false;
    }

    function syncProfileOptions(){
      const sys = $('systemType').value;
      const sel = $('profileType');
      const opts = Array.from(sel.options);
      let firstVisible = null;
      opts.forEach(o => {
        const ok = (o.dataset && o.dataset.sys) ? (o.dataset.sys === sys) : true;
        o.hidden = !ok;
        o.disabled = !ok;
        if(ok && !firstVisible) firstVisible = o.value;
      });
      if(sel.selectedOptions.length && (sel.selectedOptions[0].disabled || sel.selectedOptions[0].hidden)){
        sel.value = firstVisible || sel.value;
      }
      // update rule line
      const tmp = glassSizeByTolerance($('systemType').value, $('profileType').value,
        Number($('doorW').value||0), Number($('doorH').value||0));
      $('glassRuleText').textContent = tmp.ruleText || "‚Äî";
      autoAdhesionPrep();
      autoBuselPaint();
      syncHingeUI();
    }

    function autoAdhesionPrep(){
      const supplier = $('supplier').value;
      const profile = $('profileType').value;
      const isAdhesive = (profile === "IS954" || profile === "ISM956");
      const cb = $('adhesionPrep');
      cb.disabled = !(supplier === "ABSTRACT" && isAdhesive);
      if(cb.disabled) cb.checked = false;
      if(!cb.disabled) cb.checked = true;
    }


    function autoBuselPaint(){
      const supplier = $('supplier').value;
      const profile = $('profileType').value;
      const isAdhesive = (profile === "IS954" || profile === "ISM956");

      const block = $('buselPaintBlock');
      const cbPaint = $('buselPaint');
      const cbEdge = $('buselPaintEdgeClean');

      const enabled = (supplier === "BUSEL" && isAdhesive);
      block.style.display = enabled ? "block" : "none";

      if(!enabled){
        cbPaint.checked = false;
        cbEdge.checked = false;
        cbEdge.disabled = true;
        return;
      }

      // default ON for Busel + adhesive
      if(cbPaint.checked === false) cbPaint.checked = true;

      // edge clean only for thickness >= 6 and only if paint is on
      const thk = Number(getGlassItem("BUSEL", $('glassItem').value)?.thickness_mm || 0);
      cbEdge.disabled = !(cbPaint.checked && thk >= 6);
      if(cbEdge.disabled) cbEdge.checked = false;
    }

    function buselEdgeTariff(thkMm){
      const srv = getCatalog("BUSEL")?.services?.edge_polish;
      if(!srv) return 0;
      const key = (Number(thkMm) === 4) ? "THK_4" : "THK_3_5_6";
      return Number(srv.pricePerLm_uah?.[key] || 0);
    }
    function buselTemperTariff(group){
      const srv = getCatalog("BUSEL")?.services?.tempering;
      if(!srv) return 0;
      return Number(srv.base_pricePerM2_uah?.[group] || 0);
    }
    function abstractEdgeTariff(thkMm){
      const srv = getCatalog("ABSTRACT")?.services?.edge_polish;
      if(!srv) return 0;
      const key = (Number(thkMm) >= 6) ? "THK_6" : "THK_3_4_5";
      return Number(srv.pricePerLm_uah?.[key] || 0);
    }
    function abstractTemperTariff(thkMm){
      const srv = getCatalog("ABSTRACT")?.services?.tempering;
      if(!srv) return 0;
      const t = Number(thkMm);
      const key = (t === 4) ? "THK_4" : (t === 5) ? "THK_5" : "THK_6";
      return Number(srv.pricePerM2_uah?.[key] || 0);
    }
    function abstractPrepTariff(){
      const srv = getCatalog("ABSTRACT")?.services?.adhesion_prep;
      return Number(srv?.pricePerM2_uah || 0);
    }

    function calcGlassUAH({supplier, glassItem, glassW, glassH, qty, tempered, edgePolish, adhesionPrep, isAdhesive, buselPaint, buselPaintEdgeClean}){
      const w = Number(glassW), h = Number(glassH);
      const q = Math.max(1, Math.floor(Number(qty)||1));

      const areaRaw = mm2_to_m2(w,h);
      const areaBill = Math.max(areaRaw, 0.25);
      const edgeM = perimeter_m(w,h);

      const materialPrice = Number(glassItem.pricePerM2_uah || 0);
      const thk = Number(glassItem.thickness_mm || 4);

      if(supplier === "BUSEL"){
        const edgeTariff = edgePolish ? buselEdgeTariff(thk) : 0;
        const temperTariff = tempered ? buselTemperTariff(glassItem.tempering_group || "FLOAT") : 0;

        const res = GlassEngine.calcBuselV3Piece({
          widthMm: w,
          heightMm: h,
          qty: q,
          tempered: !!tempered,
          materialPricePerM2UAH: materialPrice,
          edgePolishPerMUAH: edgeTariff,
          temperTariffPerM2UAH: temperTariff,
          temperMinType: (glassItem.tempering_group === "FLOAT") ? "float" : "other"
        });

        // Busel: —Ñ–∞—Ä–±—É–≤–∞–Ω–Ω—è/–µ–º–∞–ª—é–≤–∞–Ω–Ω—è (–∞–Ω–∞–ª–æ–≥ "–ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∏ –ø—ñ–¥ –ø—Ä–æ—Ñ—ñ–ª—å" –¥–ª—è –≤–∫–ª–µ–π–∫–∏)
        // Default: –ù–µ–ø—Ä–æ–∑–æ—Ä—ñ –ø–æ RAL –∞–±–æ NCS, –ú–ê–õ–ê –ø–∞—Ä—Ç—ñ—è (–≥—Ä–Ω/–º¬≤), –º—ñ–Ω. –ø–ª–æ—â–∞ 0.25 –º¬≤ –≤–∂–µ –≤—Ä–∞—Ö–æ–≤–∞–Ω–∞ —è–∫ areaBill.
        const buselPaintTariff = 561.42; // –≥—Ä–Ω/–º¬≤ (–º–∞–ª–∞ –ø–∞—Ä—Ç—ñ—è) ‚Äî –ø—Ä–∞–π—Å Busel "–§–∞—Ä–±—É–≤–∞–Ω–Ω—è —Å–∫–ª–∞"
        const paintUAH = (buselPaint && isAdhesive) ? (areaBill * buselPaintTariff * q) : 0;

        // Busel: –∑–∞—á–∏—Å—Ç–∫–∞ —Ç–æ—Ä—Ü—ñ–≤ –≤—ñ–¥ —Ñ–∞—Ä–±–∏ (—Ç—ñ–ª—å–∫–∏ —Ç–æ–≤—â–∏–Ω–∞ ‚â• 6 –º–º) = 50% –≤—ñ–¥ –≤–∞—Ä—Ç–æ—Å—Ç—ñ —Ñ–∞—Ä–±—É–≤–∞–Ω–Ω—è
        const edgeCleanUAH = (buselPaintEdgeClean && paintUAH > 0 && thk >= 6) ? (paintUAH * 0.50) : 0;

        const totalUAH = res.mtRetailUAH + paintUAH + edgeCleanUAH;

        const breakdown =
`–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫: Busel (v3)
–ü–ª–æ—â–∞ raw: ${areaRaw.toFixed(3)} –º¬≤
–ü–ª–æ—â–∞ bill: ${areaBill.toFixed(3)} –º¬≤ √ó ${q} —à—Ç
–°–∫–ª–æ: ${materialPrice} –≥—Ä–Ω/–º¬≤
–ü–æ–ª—ñ—Ä—É–≤–∞–Ω–Ω—è: ${edgePolish ? (edgeTariff + " –≥—Ä–Ω/–ø.–º. (–ø–µ—Ä–∏–º–µ—Ç—Ä " + edgeM.toFixed(2) + " –º)") : "‚Äî"}
–ó–∞–≥–∞—Ä—Ç—É–≤–∞–Ω–Ω—è: ${tempered ? (temperTariff + " –≥—Ä–Ω/–º¬≤ (–º—ñ–Ω " + res.temperMinUAH.toFixed(0) + " –≥—Ä–Ω)") : "‚Äî"}
–§–∞—Ä–±—É–≤–∞–Ω–Ω—è (RAL/NCS): ${ (buselPaint && isAdhesive) ? (buselPaintTariff + " –≥—Ä–Ω/–º¬≤") : "‚Äî" }
–ó–∞—á–∏—Å—Ç–∫–∞ —Ç–æ—Ä—Ü—ñ–≤: ${ (buselPaintEdgeClean && paintUAH>0 && thk>=6) ? "+50%" : "‚Äî" }
–†–∞–∑–æ–º (MT retail): ${fmtUAH(totalUAH)} –≥—Ä–Ω`;

        const specRows = [];
        specRows.push(["BUSEL_GLASS", glassItem.label, (areaBill*q).toFixed(3), (materialPrice).toFixed(2) + " –≥—Ä–Ω", (areaBill*q*materialPrice).toFixed(2) + " –≥—Ä–Ω"]);
        if(edgePolish) specRows.push(["BUSEL_EDGE", "–ü–æ–ª—ñ—Ä—É–≤–∞–Ω–Ω—è –∫—Ä–æ–º–∫–∏ (Busel)", (edgeM*q).toFixed(3), edgeTariff.toFixed(2) + " –≥—Ä–Ω", (edgeM*q*edgeTariff).toFixed(2) + " –≥—Ä–Ω"]);
        if(tempered) specRows.push(["BUSEL_TEMP", "–ó–∞–≥–∞—Ä—Ç—É–≤–∞–Ω–Ω—è (Busel)", (areaBill*q).toFixed(3), temperTariff.toFixed(2) + " –≥—Ä–Ω", (res.temperTotalUAH).toFixed(2) + " –≥—Ä–Ω"]);

        if(buselPaint && isAdhesive) specRows.push(["BUSEL_PAINT","–§–∞—Ä–±—É–≤–∞–Ω–Ω—è/–µ–º–∞–ª—é–≤–∞–Ω–Ω—è (RAL –∞–±–æ NCS, –º–∞–ª–∞ –ø–∞—Ä—Ç—ñ—è)",(areaBill*q).toFixed(3)+" –º¬≤", buselPaintTariff.toFixed(2)+" –≥—Ä–Ω", paintUAH.toFixed(2)+" –≥—Ä–Ω"]);
        if(buselPaintEdgeClean && paintUAH>0 && thk>=6) specRows.push(["BUSEL_EDGE_CLEAN","–ó–∞—á–∏—Å—Ç–∫–∞ —Ç–æ—Ä—Ü—ñ–≤ –≤—ñ–¥ —Ñ–∞—Ä–±–∏ (+50%)","", "", edgeCleanUAH.toFixed(2)+" –≥—Ä–Ω"]);
        return { totalUAH, areaRaw, areaBill, areaBillTotal: areaBill*q, breakdown, specRows };
      }

      // ABSTRACT
      const edgeTariff = edgePolish ? abstractEdgeTariff(thk) : 0;
      const temperTariff = tempered ? abstractTemperTariff(thk) : 0;
      const prepTariff = (adhesionPrep && isAdhesive) ? abstractPrepTariff() : 0;

      const material = areaBill * materialPrice * q;
      const edge = edgePolish ? (edgeM * edgeTariff * q) : 0;
      const temp = tempered ? (areaBill * temperTariff * q) : 0;
      const prep = (adhesionPrep && isAdhesive) ? (areaBill * prepTariff * q) : 0;
      const total = material + edge + temp + prep;

      const breakdown =
`–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫: AbstractGlass
–ü–ª–æ—â–∞ raw: ${areaRaw.toFixed(3)} –º¬≤
–ü–ª–æ—â–∞ bill: ${areaBill.toFixed(3)} –º¬≤ √ó ${q} —à—Ç
–°–∫–ª–æ: ${materialPrice} –≥—Ä–Ω/–º¬≤ ‚Üí ${fmtUAH(material)} –≥—Ä–Ω
–ü–æ–ª—ñ—Ä—É–≤–∞–Ω–Ω—è: ${edgePolish ? (edgeTariff + " –≥—Ä–Ω/–ø.–º. (–ø–µ—Ä–∏–º–µ—Ç—Ä " + edgeM.toFixed(2) + " –º) ‚Üí " + fmtUAH(edge) + " –≥—Ä–Ω") : "‚Äî"}
–ó–∞–≥–∞—Ä—Ç—É–≤–∞–Ω–Ω—è: ${tempered ? (temperTariff + " –≥—Ä–Ω/–º¬≤ ‚Üí " + fmtUAH(temp) + " –≥—Ä–Ω") : "‚Äî"}
–ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø—ñ–¥ –ø—Ä–æ—Ñ—ñ–ª—å: ${(adhesionPrep && isAdhesive) ? (prepTariff + " –≥—Ä–Ω/–º¬≤ ‚Üí " + fmtUAH(prep) + " –≥—Ä–Ω") : "‚Äî"}
–†–∞–∑–æ–º: ${fmtUAH(total)} –≥—Ä–Ω`;

      const specRows = [];
      specRows.push(["ABS_GLASS", glassItem.label, (areaBill*q).toFixed(3), materialPrice.toFixed(2) + " –≥—Ä–Ω", material.toFixed(2) + " –≥—Ä–Ω"]);
      if(edgePolish) specRows.push(["ABS_EDGE", "–ü–æ–ª—ñ—Ä—É–≤–∞–Ω–Ω—è –∫—Ä–æ–º–∫–∏ (AbstractGlass)", (edgeM*q).toFixed(3), edgeTariff.toFixed(2) + " –≥—Ä–Ω", edge.toFixed(2) + " –≥—Ä–Ω"]);
      if(tempered) specRows.push(["ABS_TEMP", "–ó–∞–≥–∞—Ä—Ç—É–≤–∞–Ω–Ω—è (AbstractGlass)", (areaBill*q).toFixed(3), temperTariff.toFixed(2) + " –≥—Ä–Ω", temp.toFixed(2) + " –≥—Ä–Ω"]);
      if(adhesionPrep && isAdhesive) specRows.push(["ABS_PREP", "–ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø—ñ–¥ –ø—Ä–æ—Ñ—ñ–ª—å (AbstractGlass)", (areaBill*q).toFixed(3), prepTariff.toFixed(2) + " –≥—Ä–Ω", prep.toFixed(2) + " –≥—Ä–Ω"]);

      return { totalUAH: total, areaRaw, areaBill, areaBillTotal: areaBill*q, breakdown, specRows };
    }

    
    // ===== –ü–µ—Ç–ª—ñ IKS (–ø—Ä–∞–π—Å TRIAL), —Ü—ñ–Ω–∏ –∑–∞ 1 —à—Ç (DX –∞–±–æ SX) =====
    const IKS_HINGES = {
      PI:        { dx:{id:"trIS-CE33-PI-DX",  label:"–ü–µ—Ç–ª—è IKS 33 –∫–≥ –∑ –¥–æ–≤–æ–¥—á–∏–∫–æ–º (DX)", priceEur:55.26},
                   sx:{id:"trIS-CE33-PI-SX",  label:"–ü–µ—Ç–ª—è IKS 33 –∫–≥ –∑ –¥–æ–≤–æ–¥—á–∏–∫–æ–º (SX)", priceEur:55.26} },
      NO_CLOSER: { dx:{id:"trIS-CE33-DX",     label:"–ü–µ—Ç–ª—è IKS 33 –∫–≥ –±–µ–∑ –¥–æ–≤–æ–¥—á–∏–∫–∞ (DX)", priceEur:54.01},
                   sx:{id:"trIS-CE33-SX",     label:"–ü–µ—Ç–ª—è IKS 33 –∫–≥ –±–µ–∑ –¥–æ–≤–æ–¥—á–∏–∫–∞ (SX)", priceEur:54.01} },
      TIPON:     { dx:{id:"trIS-CE33LIB-DX",  label:"–ü–µ—Ç–ª—è IKS 33 –∫–≥ Tip-On (DX)", priceEur:48.45},
                   sx:{id:"trIS-CE33LIB-SX",  label:"–ü–µ—Ç–ª—è IKS 33 –∫–≥ Tip-On (SX)", priceEur:48.45} },
      DEG180:    { dx:{id:"trIS-102001-DX",   label:"–ü–µ—Ç–ª—è IKS 180¬∞ –∑ –¥–æ–≤–æ–¥—á–∏–∫–æ–º (DX)", priceEur:71.73},
                   sx:{id:"trIS-102001-SX",   label:"–ü–µ—Ç–ª—è IKS 180¬∞ –∑ –¥–æ–≤–æ–¥—á–∏–∫–æ–º (SX)", priceEur:71.73} }
    };
function calcIksHardwareEur(systemType, profileType, doorW, doorH, qty, finish, angleDeg, hingeMode){
      const cfg = IKS_PRICE_EUR[systemType];
      const barLenMm = cfg.barLenMm;

      const perimMm = 2*(Number(doorW)+Number(doorH));
      const needLmPerDoor = perimMm/1000;
      const needLmTotal = needLmPerDoor * qty;

      const isAdhesive = (profileType === "IS954" || profileType === "ISM956");
      const barKey = (systemType === "IKS")
        ? (isAdhesive ? "IS_954_bar" : "IS_955_bar")
        : (isAdhesive ? "ISM_956_bar" : "ISM_955_bar");

      const pickBar = pickFinishItem(systemType, barKey, finish);
      const bar = pickBar.item;

      // collect warnings
      const warns = [];
      if(pickBar.warn) warns.push(pickBar.warn);

      const pricePerM = bar.priceEur / (barLenMm/1000);
      const profileEur = needLmTotal * pricePerM;

      // –ö—É—Ç–æ—á–∫–∏: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ñ (DX/SX) –∞–±–æ 180¬∞ —á–æ—Ä–Ω–∏–π (NS) –¥–ª—è IKS


              let cornersEur = 0;           // ‚Üê –î–û–î–ê–¢–ò –¶–ï
              let cornersLabel = "–ö—É—Ç–æ—á–∫–∏: 4 —à—Ç/–¥–≤–µ—Ä—ñ";
  let cornersCsvRows = [];
  if(systemType==="IKS" && Number(angleDeg)===180 && String(finish)==="NS"){
    // 180¬∞ –∫—É—Ç–æ—á–∫–∏ (–∑–∞ –ø—Ä–∞–π—Å–æ–º TRIAL): GIUNTO180 DX/SX –ø–æ 9.44 ‚Ç¨, –ø–æ 2 —à—Ç –∫–æ–∂–Ω–æ–≥–æ –Ω–∞ –¥–≤–µ—Ä—ñ
    const CORNER_180_DX = { id:"trIS-G-GIUNTO180-DX-CV", label:"–ö—É—Ç–æ—á–æ–∫ IKS 180¬∞ (DX)", priceEur: 9.44 };
    const CORNER_180_SX = { id:"trIS-G-GIUNTO180-SX-CV", label:"–ö—É—Ç–æ—á–æ–∫ IKS 180¬∞ (SX)", priceEur: 9.44 };

    cornersEur = (2*CORNER_180_DX.priceEur + 2*CORNER_180_SX.priceEur) * qty;
    cornersLabel = "–ö—É—Ç–æ—á–∫–∏ 180¬∞ (NS): 4 —à—Ç/–¥–≤–µ—Ä—ñ (DX√ó2 + SX√ó2)";
    cornersCsvRows = [
      [CORNER_180_DX.id, CORNER_180_DX.label, String(2*qty), CORNER_180_DX.priceEur.toFixed(2) + " ‚Ç¨", (2*qty*CORNER_180_DX.priceEur).toFixed(2) + " ‚Ç¨"],
      [CORNER_180_SX.id, CORNER_180_SX.label, String(2*qty), CORNER_180_SX.priceEur.toFixed(2) + " ‚Ç¨", (2*qty*CORNER_180_SX.priceEur).toFixed(2) + " ‚Ç¨"]
    ];
  } else {
    cornersEur = (2*cfg.CORNER_DX.priceEur + 2*cfg.CORNER_SX.priceEur) * qty;
    cornersCsvRows = [
      [cfg.CORNER_DX.id, cfg.CORNER_DX.label, String(2*qty), cfg.CORNER_DX.priceEur.toFixed(2) + " ‚Ç¨", (2*qty*cfg.CORNER_DX.priceEur).toFixed(2) + " ‚Ç¨"],
      [cfg.CORNER_SX.id, cfg.CORNER_SX.label, String(2*qty), cfg.CORNER_SX.priceEur.toFixed(2) + " ‚Ç¨", (2*qty*cfg.CORNER_SX.priceEur).toFixed(2) + " ‚Ç¨"]
    ];
  }
      const handleKey = (systemType === "IKS") ? "HANDLE_200" : "HANDLE_120";
      const pickHandle = pickFinishItem(systemType, handleKey, finish);
      const handle = pickHandle.item;
      if(pickHandle.warn) warns.push(pickHandle.warn);

      const handleEur = (handle ? handle.priceEur : 0) * qty;

      const isGroove = !isAdhesive;
      const gasketEur = isGroove ? (cfg.GASKET.priceEur * qty) : 0;
      let hingeEur = 0;
      let hingeLabel = "";
      let hingeCsvRows = [];

      if(systemType==="IKS"){
        const hm = String(hingeMode || "PI");
        if(Number(angleDeg)===180){
          const h = IKS_HINGES.DEG180;
          hingeEur = (h.dx.priceEur + h.sx.priceEur) * qty;
          hingeLabel = "–ü–µ—Ç–ª—ñ 180¬∞: 1√óDX + 1√óSX / –¥–≤–µ—Ä—ñ";
          hingeCsvRows = [
            [h.dx.id, h.dx.label, String(qty), h.dx.priceEur.toFixed(2) + " ‚Ç¨", (qty*h.dx.priceEur).toFixed(2) + " ‚Ç¨"],
            [h.sx.id, h.sx.label, String(qty), h.sx.priceEur.toFixed(2) + " ‚Ç¨", (qty*h.sx.priceEur).toFixed(2) + " ‚Ç¨"]
          ];
        }else{
          const h = IKS_HINGES[hm] || IKS_HINGES.PI;
          hingeEur = (h.dx.priceEur + h.sx.priceEur) * qty;
          hingeLabel = "–ü–µ—Ç–ª—ñ: 1√óDX + 1√óSX / –¥–≤–µ—Ä—ñ";
          hingeCsvRows = [
            [h.dx.id, h.dx.label, String(qty), h.dx.priceEur.toFixed(2) + " ‚Ç¨", (qty*h.dx.priceEur).toFixed(2) + " ‚Ç¨"],
            [h.sx.id, h.sx.label, String(qty), h.sx.priceEur.toFixed(2) + " ‚Ç¨", (qty*h.sx.priceEur).toFixed(2) + " ‚Ç¨"]
          ];
        }
      }else{
        // IKS mini: –ø–æ–∫–∏ —è–∫ –±—É–ª–æ (–æ–¥–∏–Ω –∫–æ–º–ø–ª–µ–∫—Ç)
        hingeEur = cfg.HINGE_SET.priceEur * qty;
        hingeLabel = cfg.HINGE_SET.label;
        hingeCsvRows = [[cfg.HINGE_SET.id, cfg.HINGE_SET.label, String(qty), cfg.HINGE_SET.priceEur.toFixed(2) + " ‚Ç¨", (qty*cfg.HINGE_SET.priceEur).toFixed(2) + " ‚Ç¨"]];
      }

      const totalEur = profileEur + cornersEur + handleEur + gasketEur + hingeEur;

      const bars = Math.max(1, Math.ceil(needLmTotal / (barLenMm/1000)));

      const breakdown =
`‚Ä¢ –ü—Ä–æ—Ñ—ñ–ª—å: ${bar.label} ‚Üí ${fmtEUR(profileEur)} ‚Ç¨
‚Ä¢ ${cornersLabel} ‚Üí ${fmtEUR(cornersEur)} ‚Ç¨
‚Ä¢ –†—É—á–∫–∞: ${handle.label} ‚Üí ${fmtEUR(handleEur)} ‚Ç¨
‚Ä¢ –£—â—ñ–ª—å–Ω—é–≤–∞—á: ${isGroove ? (cfg.GASKET.label + " ‚Üí " + fmtEUR(gasketEur) + " ‚Ç¨") : "‚Äî"}
‚Ä¢ –ü–µ—Ç–ª—ñ: ${hingeLabel} ‚Üí ${fmtEUR(hingeEur)} ‚Ç¨`;

      const csvRows = [];
      csvRows.push([bar.id, bar.label, needLmTotal.toFixed(3) + " –º", pricePerM.toFixed(2) + " ‚Ç¨", profileEur.toFixed(2) + " ‚Ç¨"]);
      cornersCsvRows.forEach(r=>csvRows.push(r));
      csvRows.push([handle.id, handle.label, String(qty), handle.priceEur.toFixed(2) + " ‚Ç¨", handleEur.toFixed(2) + " ‚Ç¨"]);
      if(isGroove) csvRows.push([cfg.GASKET.id, cfg.GASKET.label, String(qty), cfg.GASKET.priceEur.toFixed(2) + " ‚Ç¨", gasketEur.toFixed(2) + " ‚Ç¨"]);
            hingeCsvRows.forEach(r=>csvRows.push(r));

      return { totalEur, bars, needLmPerDoor, needLmTotal, breakdown, csvRows, warns };
    }

    function buildTelegramText(ctx){
      const modeUa = currentMode === "manager" ? "–º–µ–Ω–µ–¥–∂–µ—Ä" : "–∫–ª—ñ—î–Ω—Ç";
      const clientName = (ctx.clientName || "").trim();
      const clientPhone = (ctx.clientPhone || "").trim();
      const comment = (ctx.comment || "").trim();

      const sysLabel = $('systemType').selectedOptions[0].textContent;
      const profLabel = $('profileType').selectedOptions[0].textContent;
      const finLabel = $('finish').selectedOptions[0].textContent;
      const angleLabel = $('angle').selectedOptions[0].textContent;
      const supplierLabel = $('supplier').selectedOptions[0].textContent;
      const glassLabel = ctx.glassItem.label;
      const temperedLabel = ctx.tempered ? "–∑–∞–≥–∞—Ä—Ç–æ–≤–∞–Ω–µ" : "–Ω–µ –∑–∞–≥–∞—Ä—Ç–æ–≤–∞–Ω–µ";
      const edgeLabel = ctx.edgePolish ? "–ø–æ–ª—ñ—Ä—É–≤–∞–Ω–Ω—è: —Ç–∞–∫" : "–ø–æ–ª—ñ—Ä—É–≤–∞–Ω–Ω—è: –Ω—ñ";

      let lines = [];
      lines.push("üì® –ù–æ–≤–∞ –∑–∞—è–≤–∫–∞: IKS");
      lines.push("");
      if(currentMode === "manager"){
        lines.push("üë§ –ö–ª—ñ—î–Ω—Ç: *" + (clientName || "‚Äî") + "*");
        lines.push("üìû –¢–µ–ª–µ—Ñ–æ–Ω: *" + (clientPhone || "‚Äî") + "*");
        lines.push("");
      }
      lines.push("üîÅ –†–µ–∂–∏–º: *" + modeUa + "*");
      lines.push("");
      lines.push("–ö—É—Ä—Å EUR: *" + fmt(ctx.eurRate,2) + "*");
      lines.push("–°–∏—Å—Ç–µ–º–∞: *" + sysLabel + "*");
      lines.push("–ü—Ä–æ—Ñ—ñ–ª—å: *" + profLabel + "*");
      lines.push("–ö–æ–ª—ñ—Ä: *" + finLabel + "*");
      lines.push("–ö—É—Ç: *" + angleLabel + "*");
      lines.push("");
      lines.push("–°–∫–ª–æ: *" + supplierLabel + "*");
      lines.push("–ú–∞—Ç–µ—Ä—ñ–∞–ª: *" + glassLabel + "*");
      lines.push("–û–ø—Ü—ñ—ó: *" + temperedLabel + "*, *" + edgeLabel + "*");
      if(ctx.supplier === "ABSTRACT" && ctx.isAdhesive && ctx.adhesionPrep){
        lines.push("–ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø—ñ–¥ –ø—Ä–æ—Ñ—ñ–ª—å: *—Ç–∞–∫*");
      }
      lines.push("");
      lines.push("–ì–∞–±–∞—Ä–∏—Ç —Ñ–∞—Å–∞–¥—É: *" + ctx.doorW + "√ó" + ctx.doorH + " –º–º* √ó *" + ctx.qty + " —à—Ç*");
      lines.push("–†–æ–∑–º—ñ—Ä —Å–∫–ª–∞: *" + ctx.glassW + "√ó" + ctx.glassH + " –º–º*");
      lines.push("–ü–ª–æ—â–∞ bill: *" + ctx.glassAreaBillTotal.toFixed(3) + " –º¬≤*");
      lines.push("");
      lines.push("–°–∫–ª–æ (–≥—Ä–Ω): *" + fmtUAH(ctx.glassUAH) + " –≥—Ä–Ω*");
      lines.push("IKS (‚Ç¨): *" + fmtEUR(ctx.iksEur) + " ‚Ç¨* (~ *" + fmtUAH(ctx.iksUah) + " –≥—Ä–Ω*)");
      lines.push("");
      lines.push("–†–∞–∑–æ–º: *" + fmtUAH(ctx.totalUah) + " –≥—Ä–Ω* (~ *" + fmtEUR(ctx.totalEur) + " ‚Ç¨*)");
      if(comment){
        lines.push("");
        lines.push("üí¨ –ö–æ–º–µ–Ω—Ç–∞—Ä: " + comment);
      }
      return lines.join("\n");
    }

    function makeCSV(allRows){
      const header = ["–ê—Ä—Ç–∏–∫—É–ª","–ù–∞–∑–≤–∞","–ö—ñ–ª—å–∫—ñ—Å—Ç—å","–¶—ñ–Ω–∞","–°—É–º–∞"].join(";");
      const lines = allRows.map(r => r.map(x => String(x).replaceAll(";"," ")).join(";"));
      return [header, ...lines].join("\n");
    }

    async function sendTelegram(text){
      const resp = await fetch(TELEGRAM_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          secret: TELEGRAM_FORM_SECRET,
          text
        })
      });
      if(!resp.ok){
        const t = await resp.text();
        throw new Error("HTTP " + resp.status + ": " + t);
      }
      return true;
    }


    function parseMoneyCell(cell){
      const s = String(cell||"").trim();
      if(s.includes("‚Ç¨")) return { value: s.replace("‚Ç¨","").trim(), cur: "EUR" };
      if(s.includes("–≥—Ä–Ω")) return { value: s.replace("–≥—Ä–Ω","").trim(), cur: "UAH" };
      return { value: s, cur: "" };
    }

    function escapeHtml(str){
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function renderSpecTable(res){
      const tb = document.getElementById("specTableBody");
      const hint = document.getElementById("specHint");
      if(!tb) return;

      const rows = [];
      // section headers
      rows.push({section:true, title:"–°–ö–õ–û (UAH)"});
      for(const r of (res.csv?.glassRows || [])){
        rows.push({data:r, forceCur:"UAH"});
      }
      rows.push({section:true, title:"IKS (EUR)"});
      for(const r of (res.csv?.iksRows || [])){
        rows.push({data:r, forceCur:"EUR"});
      }

      // render
      let html = "";
      for(const it of rows){
        if(it.section){
          html += `<tr><td colspan="6" style="padding:10px 12px; font-weight:700; color:var(--text-main); border-bottom:1px solid var(--border); background: rgba(22,163,74,0.06);">${it.title}</td></tr>`;
          continue;
        }
        const r = it.data;
        const art = r[0] ?? "";
        const name = r[1] ?? "";
        const qty  = r[2] ?? "";
        const price = r[3] ?? "";
        const sum   = r[4] ?? "";
        const p = parseMoneyCell(price);
        const s = parseMoneyCell(sum);
        const cur = it.forceCur || p.cur || s.cur || "";
        html += `<tr>
          <td style="padding:10px 12px; border-bottom:1px solid var(--border); white-space:nowrap;">${escapeHtml(String(art))}</td>
          <td style="padding:10px 12px; border-bottom:1px solid var(--border);">${escapeHtml(String(name))}</td>
          <td style="padding:10px 12px; border-bottom:1px solid var(--border); text-align:right; white-space:nowrap;">${escapeHtml(String(qty))}</td>
          <td style="padding:10px 12px; border-bottom:1px solid var(--border); text-align:right; white-space:nowrap;">${escapeHtml(String(price))}</td>
          <td style="padding:10px 12px; border-bottom:1px solid var(--border); text-align:right; white-space:nowrap;">${escapeHtml(String(sum))}</td>
          <td style="padding:10px 12px; border-bottom:1px solid var(--border); white-space:nowrap;">${cur}</td>
        </tr>`;
      }
      tb.innerHTML = html;

      if(hint){
        hint.textContent = "–ü–æ—Ä–∞–¥–∞: CSV (1–°) –º—ñ—Å—Ç–∏—Ç—å —Ç—ñ —Å–∞–º—ñ —Ä—è–¥–∫–∏ —É —Ñ–æ—Ä–º–∞—Ç—ñ ¬´–ê—Ä—Ç–∏–∫—É–ª;–ù–∞–∑–≤–∞;–ö—ñ–ª—å–∫—ñ—Å—Ç—å;–¶—ñ–Ω–∞;–°—É–º–∞¬ª.";
      }
    }

    function specToTSV(res){
      const rows = [];
      rows.push(["–ê—Ä—Ç–∏–∫—É–ª","–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞","–ö-—Å—Ç—å","–¶—ñ–Ω–∞","–°—É–º–∞","–í–∞–ª—é—Ç–∞"]);
      rows.push(["–°–ö–õ–û (UAH)","","","","","UAH"]);
      for(const r of (res.csv?.glassRows || [])) rows.push([r[0],r[1],r[2],r[3],r[4],"UAH"]);
      rows.push(["IKS (EUR)","","","","","EUR"]);
      for(const r of (res.csv?.iksRows || [])) rows.push([r[0],r[1],r[2],r[3],r[4],"EUR"]);
      return rows.map(x=>x.map(v=>String(v??"")).join("\t")).join("\n");
    }

    function render(res){
      $('outGlassSize').textContent = res.glassW + "√ó" + res.glassH;
      $('outGlassAreaRaw').textContent = fmt(res.glassAreaRaw,3);
      $('outGlassAreaBill').textContent = fmt(res.glassAreaBill,3);
      $('outGlassAreaTotal').textContent = fmt(res.glassAreaBillTotal,3);

      $('outPerim').textContent = fmt(res.perimM,2);
      $('outPerimTotal').textContent = fmt(res.perimTotalM,2);
      $('outBars').textContent = String(res.bars);

      $('outGlassUah').textContent = fmtUAH(res.glassUAH) + " –≥—Ä–Ω";
      $('outIksEur').textContent = fmtEUR(res.iksEur) + " ‚Ç¨";
      $('outTotalUah').textContent = fmtUAH(res.totalUah) + " –≥—Ä–Ω";
      $('outTotalEur').textContent = fmtEUR(res.totalEur) + " ‚Ç¨";

      $('outGlassBreakdown').textContent = res.glassBreakdown || "";
      $('outIksBreakdown').textContent = res.iksBreakdown || "";

      // === Spec table (manager) ===
      if(currentMode === "manager"){
        renderSpecTable(res);
      } else {
        const tb = document.getElementById("specTableBody");
        if(tb) tb.innerHTML = "";
        const sh = document.getElementById("specHint");
        if(sh) sh.textContent = "‚Äî";
      }

      $('telegramText').value = res.telegramText || "";
      $('telegramStatus').textContent = "–ì–æ—Ç–æ–≤–æ. –ú–æ–∂–Ω–∞ –∫–æ–ø—ñ—é–≤–∞—Ç–∏ / CSV / Telegram.";
    }

    function calculate(){
      setWarn("");

      const eurRate = Number($('eurRate').value || 0);
      const qty = Math.max(1, Math.floor(Number($('qty').value || 1)));
      const doorW = Math.max(1, Number($('doorW').value || 0));
      const doorH = Math.max(1, Number($('doorH').value || 0));

      const systemType = $('systemType').value;
      const profileType = $('profileType').value;
      const angleDeg = Number($('angle').value || 95);
      const hingeMode = ($('hingeMode') ? $('hingeMode').value : 'PI');
      const isAdhesive = (profileType === "IS954" || profileType === "ISM956");

      const supplier = $('supplier').value;
      const glassItem = getGlassItem(supplier, $('glassItem').value);
      if(!glassItem){
        setWarn("–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ —Å–∫–ª–æ –≤ –±–∞–∑—ñ. –ü–µ—Ä–µ–≤—ñ—Ä selector / JSON.");
        return null;
      }

      const tempered = $('tempered').value === "1";
      const edgePolish = $('edgePolish').value === "1";
      const adhesionPrep = $('adhesionPrep').checked;

      const tol = glassSizeByTolerance(systemType, profileType, doorW, doorH);
      $('glassRuleText').textContent = tol.ruleText || "‚Äî";

      const glassW = tol.glassW;
      const glassH = tol.glassH;

      const glassAreaRaw = mm2_to_m2(glassW, glassH);
      const glassAreaBill = Math.max(glassAreaRaw, 0.25);
      const glassAreaBillTotal = glassAreaBill * qty;

      const perimM = perimeter_m(doorW, doorH);
      const perimTotalM = perimM * qty;
      const bars = Math.max(1, Math.ceil(perimTotalM / 6.1));

      const glassRes = calcGlassUAH({
        supplier, glassItem, glassW, glassH, qty,
        tempered, edgePolish, adhesionPrep,
        isAdhesive
      });

      const finish = $("finish").value;
      const iksRes = calcIksHardwareEur(systemType, profileType, doorW, doorH, qty, finish, angleDeg, hingeMode);
      const iksEur = iksRes.totalEur;
      const iksUah = iksEur * eurRate;
      if(iksRes.warns && iksRes.warns.length){ setWarn(iksRes.warns.join(" ")); }
      const totalUah = glassRes.totalUAH + iksUah;
      const totalEur = eurRate > 0 ? (totalUah / eurRate) : 0;

      // Telegram text
      const telegramText = buildTelegramText({
        eurRate, qty, doorW, doorH,
        systemType, profileType,
        supplier, glassItem,
        tempered, edgePolish, adhesionPrep, isAdhesive,
        glassW, glassH,
        glassAreaBillTotal,
        glassUAH: glassRes.totalUAH,
        iksEur,
        iksUah,
        totalUah,
        totalEur,
        clientName: ($('clientName')?.value || ""),
        clientPhone: ($('clientPhone')?.value || ""),
        comment: ($('comment')?.value || "")
      });

      // warnings
      if(supplier === "BUSEL" && !tempered){
        setWarn("Busel: –ø–µ—Ä–µ–≤—ñ—Ä ¬´–ó–∞–≥–∞—Ä—Ç–æ–≤–∞–Ω–µ¬ª. –£ Busel —á–∞—Å—Ç–æ —Ä–∞—Ö—É—é—Ç—å –∑–∞–≥–∞—Ä—Ç—É–≤–∞–Ω–Ω—è –≤ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è—Ö —è–∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç (–∞–ª–µ –∑–∞–ª–∏—à–∏–ª–∏ –ø–µ—Ä–µ–º–∏–∫–∞—á).");
      }

      const res = {
        eurRate, qty, doorW, doorH,
        systemType, profileType, supplier, glassItem,
        tempered, edgePolish, adhesionPrep, isAdhesive,
        glassW, glassH,
        glassAreaRaw, glassAreaBill, glassAreaBillTotal,
        perimM, perimTotalM, bars,
        glassUAH: glassRes.totalUAH,
        glassBreakdown: glassRes.breakdown,
        iksEur, iksUah,
        iksBreakdown: iksRes.breakdown,
        totalUah, totalEur,
        telegramText,
        csv: {
          glassRows: glassRes.specRows,
          iksRows: iksRes.csvRows
        }
      };

      return res;
    }

    // ===== Events =====
    $('modeToggleBtn').addEventListener('click', () => {
      if(currentMode === "client"){
        const pass = prompt("–ü–∞—Ä–æ–ª—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞:");
        if(String(pass||"").trim() === MANAGER_PASSWORD){
          setMode("manager");
          setWarn("");
        } else {
          setWarn("–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞.");
        }
      } else {
        setMode("client");
        setWarn("");
      }
    });

    $('calcBtn').addEventListener('click', () => {
      const res = calculate();
      if(!res) return;
      last = res;
      render(res);
    });

    // $('applyToOnlyBtn').addEventListener('click', () => {
    //   if(!last){ setWarn("–°–ø–æ—á–∞—Ç–∫—É –Ω–∞—Ç–∏—Å–Ω–∏ ¬´–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏¬ª."); return; }
    //   // –§–æ—Ä–º—É—î–º–æ payload –¥–ª—è ONLY (add-on)
    //   const rowsUAH = (last.csv?.glassRows||[]).map(r => ({
    //     code: r[0], name: r[1], qty: r[2], price: r[3], sum: r[4], currency: 'UAH'
    //   }));
    //   const rowsEUR = (last.csv?.iksRows||[]).map(r => ({
    //     code: r[0], name: r[1], qty: r[2], priceEur: Number(String(r[3]).replace(/[^0-9.\-]/g,'')) || 0,
    //     sumEur: Number(String(r[4]).replace(/[^0-9.\-]/g,'')) || 0, unit: '—à—Ç'
    //   }));
    //   const payload = {
    //     createdAt: new Date().toISOString(),
    //     eurRate: Number(last.eurRate||0),
    //     totalUAH: Number(last.glassUAH||0), // —Ç—ñ–ª—å–∫–∏ UAH-—á–∞—Å—Ç–∏–Ω–∞ —Å–∫–ª–∞/–ø–æ—Å–ª—É–≥
    //     rowsUAH,
    //     rowsEUR,
    //     meta: {
    //       doorW: last.doorW, doorH: last.doorH, qty: last.qty,
    //       systemType: last.systemType, profileType: last.profileType,
    //       supplier: last.supplier,
    //       glassItem: (last.glassItem && (last.glassItem.label||last.glassItem.name)) ? (last.glassItem.label||last.glassItem.name) : '',
    //       tempered: !!last.tempered, edgePolish: !!last.edgePolish,
    //       adhesionPrep: !!last.adhesionPrep, isAdhesive: !!last.isAdhesive
    //     }
    //   };
    //   try{ localStorage.setItem('ONLY_IKS_PAYLOAD', JSON.stringify(payload)); }catch(e){}
    //   setWarn('');
    //   try{
    //     const p=new URLSearchParams(location.search);
    //     const rt=p.get('returnTo');
    //     const target = rt ? decodeURIComponent(rt) : 'only.final.html';
    //     location.href = target + '#iksAddon'; return;
    //   }catch(e){}
    //   alert('IKS –∑–±–µ—Ä–µ–∂–µ–Ω–æ –¥–ª—è ONLY. –ü–æ–≤–µ—Ä–Ω–∏—Å—å –≤ ONLY —ñ –Ω–∞—Ç–∏—Å–Ω–∏ ¬´–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏¬ª.');
    // });

    $('applyToOnlyBtn').addEventListener('click', () => {
      if (!last) {
        setWarn("–°–ø–æ—á–∞—Ç–∫—É –Ω–∞—Ç–∏—Å–Ω–∏ ¬´–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏¬ª.");
        return;
      }

      // ===== —Ñ–æ—Ä–º—É—î–º–æ payload –¥–ª—è ONLY =====
      const rowsUAH = (last.csv?.glassRows || []).map(r => ({
        code: r[0],
        name: r[1],
        qty: r[2],
        price: r[3],
        sum: r[4],
        currency: 'UAH'
      }));

      const rowsEUR = (last.csv?.iksRows || []).map(r => ({
        code: r[0],
        name: r[1],
        qty: r[2],
        priceEur: Number(String(r[3]).replace(/[^0-9.\-]/g, '')) || 0,
        sumEur: Number(String(r[4]).replace(/[^0-9.\-]/g, '')) || 0,
        unit: '—à—Ç'
      }));

      const payload = {
        createdAt: new Date().toISOString(),
        eurRate: Number(last.eurRate || 0),
        totalUAH: Number(last.glassUAH || 0), // —Ç—ñ–ª—å–∫–∏ UAH-—á–∞—Å—Ç–∏–Ω–∞ —Å–∫–ª–∞/–ø–æ—Å–ª—É–≥
        rowsUAH,
        rowsEUR,
        meta: {
          doorW: last.doorW,
          doorH: last.doorH,
          qty: last.qty,
          systemType: last.systemType,
          profileType: last.profileType,
          supplier: last.supplier,
          glassItem:
                  last.glassItem && (last.glassItem.label || last.glassItem.name)
                          ? (last.glassItem.label || last.glassItem.name)
                          : '',
          tempered: !!last.tempered,
          edgePolish: !!last.edgePolish,
          adhesionPrep: !!last.adhesionPrep,
          isAdhesive: !!last.isAdhesive
        }
      };

      try {
        localStorage.setItem('ONLY_IKS_PAYLOAD', JSON.stringify(payload));
      } catch (e) {}

      setWarn('');

      // ===== –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ ONLY –≤ –Ω–æ–≤—ñ–π –≤–∫–ª–∞–¥—Ü—ñ =====
      try {
        const p = new URLSearchParams(location.search);
        const rt = p.get('returnTo');
        const target = rt ? decodeURIComponent(rt) : 'only.final.html';

        // üî• –ö–õ–Æ–ß–û–í–ê –ó–ú–Ü–ù–ê
        window.open(target + '#iksAddon', '_blank');
        return;
      } catch (e) {}

      alert('IKS –∑–±–µ—Ä–µ–∂–µ–Ω–æ –¥–ª—è ONLY. –í—ñ–¥–∫—Ä–∏–π ONLY —ñ –Ω–∞—Ç–∏—Å–Ω–∏ ¬´–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏¬ª.');
    });


    $('copySummaryBtn').addEventListener('click', async () => {
      const txt = $('telegramText').value || "";
      if(!txt){ setWarn("–°–ø–æ—á–∞—Ç–∫—É –Ω–∞—Ç–∏—Å–Ω–∏ ¬´–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏¬ª."); return; }
      await navigator.clipboard.writeText(txt);
      $('telegramStatus').textContent = "–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä.";
    });

    $('downloadCsvBtn').addEventListener('click', () => {
      if(!last){ setWarn("–°–ø–æ—á–∞—Ç–∫—É –Ω–∞—Ç–∏—Å–Ω–∏ ¬´–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏¬ª."); return; }
      const rows = [];
      rows.push(["---","–°–ö–õ–û (UAH)","","",""]);
      for(const r of last.csv.glassRows) rows.push(r);
      rows.push(["---","IKS (EUR)","","",""]);
      for(const r of last.csv.iksRows) rows.push(r);
      const csv = makeCSV(rows);
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "IKS_spec.csv";
      a.click();
      URL.revokeObjectURL(url);
    });


    const IKS_STORAGE_KEY = "ONLY_IKS_PAYLOAD";

    function pushIksToOnly(payload){
      localStorage.setItem(IKS_STORAGE_KEY, JSON.stringify(payload));
      alert("IKS –∑–±–µ—Ä–µ–∂–µ–Ω–æ –¥–ª—è ONLY. –ü–æ–≤–µ—Ä–Ω–∏—Å—å –≤ ONLY —ñ –Ω–∞—Ç–∏—Å–Ω–∏ ¬´–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏¬ª. ");
      try{
        const p=new URLSearchParams(location.search);
        const rt=p.get("returnTo");
        if(rt){ location.href = decodeURIComponent(rt) + "#iksAddon"; }
      }catch(e){}
    }

    // –ø—Ä–∏–∫–ª–∞–¥: –≤–∏–∫–ª–∏–∫ –ø—ñ—Å–ª—è —Ç–≤–æ–≥–æ calculate()
    function buildIksPayload(){
      // –ë–µ—Ä–µ–º–æ –æ—Å—Ç–∞–Ω–Ω—ñ–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ IKS —ñ –ø–∞–∫—É—î–º–æ –¥–ª—è ONLY
      if(!last) return null;

      const eurRate = Number(document.getElementById("eurRate")?.value || 50);

      // helpers
      const parseMoney = (s) => {
        if(s==null) return 0;
        const n = String(s).replace(",", ".").replace(/[^0-9.\-]/g, "");
        const v = Number(n);
        return isFinite(v) ? v : 0;
      };
      const splitQty = (s) => {
        const str = String(s ?? "").trim();
        const m = str.match(/^([0-9]+(?:[\.,][0-9]+)?)\s*(.*)$/);
        if(!m) return { qty: str || "1", unit: "" };
        return { qty: m[1].replace(",", "."), unit: (m[2] || "").trim() };
      };

      const glassRows = (last.csv?.glassRows || []).map(r=>{
        const q = splitQty(r[2]);
        return {
          id: String(r[0]||""),
          label: String(r[1]||""),
          qty: q.qty,
          unit: q.unit || "–º¬≤",
          priceUah: parseMoney(r[3]),
          sumUah: parseMoney(r[4]),
          currency: "UAH"
        };
      });

      const iksRows = (last.csv?.iksRows || []).map(r=>{
        const q = splitQty(r[2]);
        return {
          id: String(r[0]||""),
          label: String(r[1]||""),
          qty: q.qty,
          unit: q.unit || "—à—Ç",
          priceEur: parseMoney(r[3]),
          sumEur: parseMoney(r[4]),
          currency: "EUR"
        };
      });

      const payload = {
        eurRate,
        totalUAH: Number(last.totalUah || 0),
        meta: {
          system: document.getElementById("system")?.value || "IKS",
          profile: document.getElementById("profile")?.value || "IS-954",
          finish: document.getElementById("finish")?.value || "NS",
          qty: Number(document.getElementById("qty")?.value || 1),
          glassSupplier: document.getElementById("glassSupplier")?.value || ""
        },
        rowsEUR: iksRows,
        rowsUAH: glassRows
      };
      return payload;
    }

    document.getElementById("applyToOnlyBtn").addEventListener("click", ()=>{
      const payload = buildIksPayload();
      if(!payload){ alert('–°–ø–æ—á–∞—Ç–∫—É –Ω–∞—Ç–∏—Å–Ω–∏ ¬´–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏¬ª.'); return; }
      pushIksToOnly(payload);
    });


    // mirror CSV button inside spec box
    const dl2 = document.getElementById('downloadCsvBtn2');
    if(dl2){
      dl2.addEventListener('click', () => {
        const b = document.getElementById('downloadCsvBtn');
        if(b) b.click();
      });
    }

    const copySpecBtn = document.getElementById('copySpecBtn');
    if(copySpecBtn){
      copySpecBtn.addEventListener('click', async () => {
        if(!last){ setWarn("–°–ø–æ—á–∞—Ç–∫—É –Ω–∞—Ç–∏—Å–Ω–∏ ¬´–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏¬ª."); return; }
        const tsv = specToTSV(last);
        await navigator.clipboard.writeText(tsv);
        const sh = document.getElementById("specHint");
        if(sh) sh.textContent = "‚úÖ –°–ø–µ—Ü–∏—Ñ—ñ–∫–∞—Ü—ñ—é —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ (TSV). –í—Å—Ç–∞–≤–ª—è–π —É Excel / Google Sheets.";
      });
    }

    $('sendTelegramBtn').addEventListener('click', async () => {
      const txt = $('telegramText').value || "";
      if(!txt){ setWarn("–°–ø–æ—á–∞—Ç–∫—É –Ω–∞—Ç–∏—Å–Ω–∏ ¬´–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏¬ª."); return; }
      const status = $('telegramStatus');
      status.textContent = "–í—ñ–¥–ø—Ä–∞–≤–ª—è—é‚Ä¶";
      try{
        await sendTelegram(txt);
        status.textContent = "‚úÖ –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram.";
      }catch(err){
        status.textContent = "‚ùå –ü–æ–º–∏–ª–∫–∞ Telegram: " + (err?.message || err);
      }
    });

    $('supplier').addEventListener('change', () => {
      populateGlassList();
      autoAdhesionPrep();
      autoBuselPaint();
    });
    $('systemType').addEventListener('change', syncProfileOptions);
    $('profileType').addEventListener('change', syncProfileOptions);
    $('angle').addEventListener('change', () => { syncHingeUI(); autoAdhesionPrep(); autoBuselPaint(); });
    $('hingeMode').addEventListener('change', () => { /* recalculation on demand */ });
    $('finish').addEventListener('change', () => { /* affects IKS price */ });

    $('glassItem').addEventListener('change', () => {
      autoBuselPaint();
    });
    $('buselPaint').addEventListener('change', () => {
      autoBuselPaint();
    });

    // init
    setMode("client");
    populateGlassList();
    syncProfileOptions();
    autoBuselPaint();
    syncHingeUI();

    // first calc
    (function(){
      const res = calculate();
      if(res){ last = res; render(res); }
    })();
  

    // ===== Handoff from ONLY (prefill —Ä–∞–∑–º–µ—Ä–æ–≤) =====
    (function applyOnlyPrefill(){
      try{
        const url = new URL(location.href);
        const p = url.searchParams;

        let changed = false;

        // 1) query params
        const qDoorW = Number(p.get("doorW") || "");
        const qDoorH = Number(p.get("doorH") || "");
        const qQty   = Number(p.get("qty") || "");
        const qRate  = Number(p.get("eurRate") || "");

        if(isFinite(qRate) && qRate>0){ document.getElementById("eurRate").value = qRate; changed = true; }
        if(isFinite(qQty)  && qQty>0){  document.getElementById("qty").value    = qQty;  changed = true; }
        if(isFinite(qDoorW) && qDoorW>0){ document.getElementById("doorW").value = qDoorW; changed = true; }
        if(isFinite(qDoorH) && qDoorH>0){ document.getElementById("doorH").value = qDoorH; changed = true; }

        // 2) localStorage overrides (more reliable)
        const raw = localStorage.getItem("ONLY_IKS_PREFILL");
        if(raw){
          const pre = JSON.parse(raw);
          if(pre && typeof pre === "object"){
            if(pre.eurRate){ document.getElementById("eurRate").value = pre.eurRate; changed = true; }
            if(pre.qty){ document.getElementById("qty").value = pre.qty; changed = true; }
            const dw = (pre.doorW || pre.suggestedDoorW);
            const dh = (pre.doorH || pre.suggestedDoorH);
            if(dw){ document.getElementById("doorW").value = dw; changed = true; }
            if(dh){ document.getElementById("doorH").value = dh; changed = true; }

            // optional defaults
            if(pre.system){ document.getElementById("system").value = pre.system; changed = true; }
            if(pre.profile){ document.getElementById("profile").value = pre.profile; changed = true; }
            if(pre.finish){ document.getElementById("finish").value = pre.finish; changed = true; }
            if(pre.angleDeg){ document.getElementById("angleDeg").value = pre.angleDeg; changed = true; }

            // trigger dependent UI
            try{ document.getElementById("system").dispatchEvent(new Event("change", { bubbles:true })); }catch(e){}
            try{ document.getElementById("profile").dispatchEvent(new Event("change", { bubbles:true })); }catch(e){}
            try{ document.getElementById("finish").dispatchEvent(new Event("change", { bubbles:true })); }catch(e){}
          }
        }

        // 3) if anything changed ‚Äî recalc immediately so user sees the new sizes
        if(changed){
          try{
            const res = calculate();
            if(res){ last = res; render(res); }
          }catch(e){}
        }
      }catch(e){}
    })();
</script>

</body>
</html>




